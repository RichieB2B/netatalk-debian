diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/autogen.sh netatalk/autogen.sh
--- netatalk.orig/autogen.sh	1970-01-01 01:00:00.000000000 +0100
+++ netatalk/autogen.sh	2003-02-17 03:09:28.000000000 +0100
@@ -0,0 +1,13 @@
+#!/bin/sh
+
+# build it all.
+libtoolize --copy --force && \
+	aclocal -I macros $ACLOCAL_FLAGS && \
+	autoheader && \
+	automake --include-deps --add-missing --foreign && \
+	autoconf
+
+# just in case automake generated errors...
+autoconf
+
+./configure --enable-maintainer-mode "$@"
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/bin/aecho/aecho.c netatalk/bin/aecho/aecho.c
--- netatalk.orig/bin/aecho/aecho.c	2003-07-21 07:50:53.000000000 +0200
+++ netatalk/bin/aecho/aecho.c	2005-09-27 12:40:40.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: aecho.c,v 1.5.10.1 2003/07/21 05:50:53 didg Exp $
+ * $Id: aecho.c,v 1.5.10.1.4.1 2005/09/27 10:40:40 didg Exp $
  *
  * Copyright (c) 1990,1991 Regents of The University of Michigan.
  * All Rights Reserved.
@@ -60,20 +60,21 @@
 #endif /* ! SOCKLEN_T */
 
 struct sockaddr_at	target;
-int			s, nsent = 0, nrecv = 0;
+int			sock;
+unsigned int		nsent = 0, nrecv = 0;
 time_t			totalms = 0, minms = -1, maxms = -1;
-static unsigned int     pings = 0;
+unsigned int     	pings = 0;
 
 void usage(char *);
 
 void done()
 {
-    if ( nsent > 0 ) {
+    if ( nsent) {
 	printf( "\n----%d.%d AEP Statistics----\n",
 		ntohs( target.sat_addr.s_net ), target.sat_addr.s_node );
 	printf( "%d packets sent, %d packets received, %d%% packet loss\n",
 		nsent, nrecv, (( nsent - nrecv ) * 100 ) / nsent );
-	if ( nrecv > 0 ) {
+	if ( nrecv ) {
 	    printf( "round-trip (ms)  min/avg/max = %ld/%ld/%ld\n",
 		    minms, totalms / nrecv, maxms );
 	}	
@@ -101,7 +102,7 @@
     memcpy( p, &tv, sizeof( struct timeval ));
     p += sizeof( struct timeval );
 
-    if ( netddp_sendto( s, buf, p - buf, 0, (struct sockaddr *) &target,
+    if ( netddp_sendto( sock, buf, p - buf, 0, (struct sockaddr *) &target,
 	    sizeof( struct sockaddr_at )) < 0 ) {
 	perror( "sendto" );
 	exit( 1 );
@@ -182,7 +183,7 @@
     }
     target.sat_port = port;
 
-    if ((s = netddp_open(saddr.sat_addr.s_net || saddr.sat_addr.s_node ? 
+    if ((sock = netddp_open(saddr.sat_addr.s_net || saddr.sat_addr.s_node ? 
 			 &saddr : NULL, NULL)) < 0) {
        perror("ddp_open");
        exit(1);
@@ -218,7 +219,7 @@
 
     for (;;) {
 	satlen = sizeof( struct sockaddr_at );
-	if (( cc = netddp_recvfrom( s, buf, sizeof( buf ), 0, 
+	if (( cc = netddp_recvfrom( sock, buf, sizeof( buf ), 0, 
 				    (struct sockaddr *) &sat,
 				    &satlen )) < 0 ) {
 	    if ( errno == EINTR ) {
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/bin/cnid/cnid_index.c netatalk/bin/cnid/cnid_index.c
--- netatalk.orig/bin/cnid/cnid_index.c	2005-04-10 14:49:18.000000000 +0200
+++ netatalk/bin/cnid/cnid_index.c	2005-09-27 12:40:40.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: cnid_index.c,v 1.1.2.4 2005/04/10 12:49:18 didg Exp $
+ * $Id: cnid_index.c,v 1.1.2.6 2005/09/27 10:40:40 didg Exp $
  *
  * All Rights Reserved.  See COPYING.
  */
@@ -73,8 +73,8 @@
 
 /* --------------- */
 int didname(dbp, pkey, pdata, skey)
-DB *dbp;
-const DBT *pkey, *pdata;
+DB *dbp _U_;
+const DBT *pkey _U_, *pdata;
 DBT *skey;
 {
 int len;
@@ -91,8 +91,8 @@
  
 /* --------------- */
 int devino(dbp, pkey, pdata, skey)
-DB *dbp;
-const DBT *pkey, *pdata;
+DB *dbp _U_;
+const DBT *pkey _U_, *pdata;
 DBT *skey;
 {
     memset(skey, 0, sizeof(DBT));
@@ -274,7 +274,11 @@
     DB_BTREE_STAT *sp;
     DB *db = db_table[dbi].db;
 
+#if DB_VERSION_MAJOR > 4 || (DB_VERSION_MAJOR == 4 && DB_VERSION_MINOR >= 3)
+    ret = db->stat(db, db_txn, &sp, 0);
+#else
     ret = db->stat(db, &sp, 0);
+#endif
 
     if (ret) {
         LOG(log_error, logtype_cnid, "error getting stat infotmation on database: %s", db_strerror(errno));
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/bin/megatron/asingle.c netatalk/bin/megatron/asingle.c
--- netatalk.orig/bin/megatron/asingle.c	2005-02-06 11:16:00.000000000 +0100
+++ netatalk/bin/megatron/asingle.c	2006-02-26 23:41:19.000000000 +0100
@@ -1,5 +1,5 @@
 /*
- * $Id: asingle.c,v 1.8.6.1.4.1 2005/02/06 10:16:00 didg Exp $
+ * $Id: asingle.c,v 1.8.6.1.4.3 2006/02/26 22:41:19 didg Exp $
  */
 
 #ifdef HAVE_CONFIG_H
@@ -64,7 +64,7 @@
 
 int single_open( singlefile, flags, fh, options )
     char		*singlefile;
-    int			flags, options;
+    int			flags, options _U_;
     struct FHeader	*fh;
 {
     int			rc;
@@ -268,7 +268,7 @@
  * Unless I can't get the current date, in which case use time zero.
  */
     if (( date_entry < 7 ) || ( date_entry > 8 )) {
-	if (( time_seconds = time( NULL )) == -1 ) {
+	if (( time_seconds = time( NULL )) == (u_int32_t)-1 ) {
 	    time_seconds = AD_DATE_START;
 	} else {
 	    time_seconds = AD_DATE_FROM_UNIX(time_seconds);
@@ -310,9 +310,9 @@
 		sizeof(fh->backup_date));
     }
     if ( single.entry[ ADEID_RFORK ].ade_off == 0 ) {
-	fh->forklen[ ADEID_RFORK ] = 0;
+	fh->forklen[RESOURCE] = 0;
     } else {
-	fh->forklen[ ADEID_RFORK ] =
+	fh->forklen[RESOURCE] =
 		htonl( single.entry[ ADEID_RFORK ].ade_len );
     }
     if ( single.entry[ ADEID_DFORK ].ade_off == 0 ) {
@@ -344,11 +344,11 @@
 
 int single_header_test(void)
 {
-    int			cc;
+    ssize_t		cc;
     u_int32_t		templong;
 
     cc = read( single.filed, (char *)header_buf, sizeof( header_buf ));
-    if ( cc < sizeof( header_buf )) {
+    if ( cc < (ssize_t)sizeof( header_buf )) {
 	perror( "Premature end of file :" );
 	return( -1 );
     }
@@ -398,7 +398,7 @@
 int single_read( fork, buffer, length )
     int			fork;
     char		*buffer;
-    int			length;
+    u_int32_t		length;
 {
     u_int32_t		entry_id;
     char		*buf_ptr;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/bin/megatron/asingle.h netatalk/bin/megatron/asingle.h
--- netatalk.orig/bin/megatron/asingle.h	2001-06-29 16:14:46.000000000 +0200
+++ netatalk/bin/megatron/asingle.h	2005-09-27 12:40:40.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: asingle.h,v 1.2 2001/06/29 14:14:46 rufustfirefly Exp $
+ * $Id: asingle.h,v 1.2.16.1 2005/09/27 10:40:40 didg Exp $
  */
 
 #ifndef _ASINGLE_H
@@ -12,6 +12,6 @@
 int single_close(int readflag);
 int single_header_read(struct FHeader *fh, int version);
 int single_header_test(void);
-int single_read(int fork, char *buffer, int length);
+int single_read(int fork, char *buffer, u_int32_t length);
 
 #endif /* _ASINGLE_H */
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/bin/megatron/hqx.c netatalk/bin/megatron/hqx.c
--- netatalk.orig/bin/megatron/hqx.c	2005-02-06 11:16:00.000000000 +0100
+++ netatalk/bin/megatron/hqx.c	2005-09-27 12:40:40.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: hqx.c,v 1.12.4.1.4.1 2005/02/06 10:16:00 didg Exp $
+ * $Id: hqx.c,v 1.12.4.1.4.2 2005/09/27 10:40:40 didg Exp $
  */
 
 #ifdef HAVE_CONFIG_H
@@ -393,7 +393,7 @@
  */
 
 int hqx_header_write( fh )
-    struct FHeader	*fh;
+    struct FHeader	*fh _U_;
 {
     return( -1 );
 }
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/bin/megatron/megatron.c netatalk/bin/megatron/megatron.c
--- netatalk.orig/bin/megatron/megatron.c	2002-04-29 03:52:49.000000000 +0200
+++ netatalk/bin/megatron/megatron.c	2005-09-27 12:40:40.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: megatron.c,v 1.9 2002/04/29 01:52:49 morgana Exp $
+ * $Id: megatron.c,v 1.9.10.1 2005/09/27 10:40:40 didg Exp $
  */
 
 #ifdef HAVE_CONFIG_H
@@ -191,7 +191,7 @@
     struct FHeader	fh;
     int			bufc;
     int			fork;
-    int			forkred;
+    unsigned int	forkred;
 
 /*
  * If the source file is not stdin, make sure it exists and
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/bin/megatron/nad.c netatalk/bin/megatron/nad.c
--- netatalk.orig/bin/megatron/nad.c	2005-02-10 02:23:08.000000000 +0100
+++ netatalk/bin/megatron/nad.c	2006-09-19 02:08:00.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: nad.c,v 1.11.8.2.2.1 2005/02/10 01:23:08 didg Exp $
+ * $Id: nad.c,v 1.11.8.2.2.3 2006/09/19 00:08:00 didg Exp $
  */
 
 #ifdef HAVE_CONFIG_H
@@ -317,7 +317,7 @@
     char        *m, *u;
     u_int16_t    flags = CONV_IGNORE | CONV_UNESCAPEHEX;
     size_t       outlen;
-    static char	 mpath[MAXPATHLEN];
+    static char	 mpath[MAXPATHLEN +2]; /* for convert_charset dest_len parameter +2 */
 
     m = mpath;
     outlen = strlen(upath);
@@ -337,7 +337,6 @@
         goto utompath_error;
     }
 
-    mpath[outlen] = 0;
     if (flags & CONV_REQMANGLE) 
 	goto utompath_error;
 
@@ -353,7 +352,7 @@
     size_t       inplen;
     size_t       outlen;
     u_int16_t    flags = 0;
-    static char	 upath[MAXPATHLEN];
+    static char	 upath[MAXPATHLEN +2]; /* for convert_charset dest_len parameter +2 */
 
     if ( *mpath == '\0' ) {
         return( "." );
@@ -382,7 +381,6 @@
         fprintf (stderr, "conversion from %s to %s for %s failed.", vol.v_maccodepage, vol.v_volcodepage, mpath);
         return(mtoupathcap( upath ));
     }
-    upath[outlen] = 0;
 
     return( upath );
 }
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/bin/uniconv/iso8859_1_adapted.c netatalk/bin/uniconv/iso8859_1_adapted.c
--- netatalk.orig/bin/uniconv/iso8859_1_adapted.c	2005-02-06 11:16:00.000000000 +0100
+++ netatalk/bin/uniconv/iso8859_1_adapted.c	2005-09-27 12:40:40.000000000 +0200
@@ -48,7 +48,7 @@
  * from unicode to iso8859_adapted code page
 */
 
-static size_t iso8859_adapted_push( void *cd, char **inbuf, size_t *inbytesleft,
+static size_t iso8859_adapted_push( void *cd _U_, char **inbuf, size_t *inbytesleft,
                          char **outbuf, size_t *outbytesleft)
 {
     int len = 0;
@@ -102,7 +102,7 @@
 }
 
 /* ------------------------ */
-static size_t iso8859_adapted_pull ( void *cd, char **inbuf, size_t *inbytesleft,
+static size_t iso8859_adapted_pull ( void *cd _U_, char **inbuf, size_t *inbytesleft,
                          char **outbuf, size_t *outbytesleft)
 {
     unsigned char  *inptr;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/bin/uniconv/uniconv.c netatalk/bin/uniconv/uniconv.c
--- netatalk.orig/bin/uniconv/uniconv.c	2004-07-12 02:15:18.000000000 +0200
+++ netatalk/bin/uniconv/uniconv.c	2006-09-19 02:08:00.000000000 +0200
@@ -142,7 +142,7 @@
 
 static char *convert_name(char *name, struct stat *st, cnid_t cur_did)
 {
-	static char   buffer[MAXPATHLEN];
+	static char   buffer[MAXPATHLEN +2];  /* for convert_charset dest_len parameter +2 */
 	size_t outlen = 0;
 	unsigned char *p,*q;
 	int require_conversion = 0;
@@ -171,21 +171,20 @@
 	q=buffer;
 	p=name;
 
-	outlen = convert_charset(ch_from, ch_to, ch_mac, p, strlen(p), q, sizeof(buffer), &flags);
+	outlen = convert_charset(ch_from, ch_to, ch_mac, p, strlen(p), q, sizeof(buffer) -2, &flags);
 	if ((size_t)-1 == outlen) {
   	   if ( ch_to == CH_UTF8) {
 		/* maybe name is already in UTF8? */
 		flags = conv_flags;
 		q = (char*) buffer;
 		p = name;
-		outlen = convert_charset(ch_to, ch_to, ch_mac, p, strlen(p), q, sizeof(buffer), &flags);
+		outlen = convert_charset(ch_to, ch_to, ch_mac, p, strlen(p), q, sizeof(buffer) -2, &flags);
 		if ((size_t)-1 == outlen) {
 			/* it's not UTF8... */
         		fprintf(stderr, "ERROR: conversion from '%s' to '%s' for '%s' in DID %u failed!!!\n", 
                   		from_charset, to_charset, name, ntohl(cur_did));
 			return name;
 		}
-		buffer[outlen] = 0;
 
 		if (!strcmp(buffer, name)) {
 	   		return name;
@@ -195,7 +194,7 @@
                   	from_charset, to_charset, name, ntohl(cur_did));
 	   return name;
 	}
-	buffer[outlen] = 0;
+
 	if (strcmp (name, buffer)) {
 	    if (dry_run) {
     		fprintf(stdout, "dry_run: would rename %s to %s.\n", name, buffer);
@@ -242,7 +241,7 @@
 	return ret;
 }
 
-static int check_adouble(DIR *curdir, char * path)
+static int check_adouble(DIR *curdir, char * path _U_)
 {
 	DIR *adouble;
 	struct dirent* entry;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/config/AppleVolumes.default.tmpl netatalk/config/AppleVolumes.default.tmpl
--- netatalk.orig/config/AppleVolumes.default.tmpl	2003-11-18 13:30:47.000000000 +0100
+++ netatalk/config/AppleVolumes.default.tmpl	2006-09-29 11:27:54.000000000 +0200
@@ -59,6 +59,8 @@
 # maccharset           -> specifies the charset to be used as the mac client codepage
 #                         e.g. "MAC_ROMAN", "MAC_CYRILLIC"
 #
+# perm                -> default permission value OR with the client requested perm
+#
 # miscellaneous options [syntax: options:option1,option2]:
 # prodos              -> make compatible with appleII clients.
 # crlf                -> enable crlf translation for TEXT files.
@@ -76,9 +78,12 @@
 # usedots             -> don't do :hex translation for dot files. note: when 
 #                        this option gets set, certain file names
 #			 become illegal. these are .Parent and
+#			 anything that starts with .Apple.
+# invisibledots       -> don't do :hex translation for dot files. note: when 
+#                        this option gets set, certain file names
+#			 become illegal. these are .Parent and
 #			 anything that starts with .Apple. also, dot
-#			 files created on the unix side are marked
-#			 invisible. 
+#			 files created on the unix side are marked invisible. 
 # limitsize           -> limit disk size reporting to 2GB. this is
 #                        here for older macintoshes using newer
 #                        appleshare clients. yucko.
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/configure.in netatalk/configure.in
--- netatalk.orig/configure.in	2005-04-13 12:21:09.000000000 +0200
+++ netatalk/configure.in	2006-09-07 07:02:20.000000000 +0200
@@ -1,4 +1,4 @@
-dnl $Id: configure.in,v 1.179.2.3.2.37.2.4 2005/04/13 10:21:09 bfernhomberg Exp $
+dnl $Id: configure.in,v 1.179.2.3.2.37.2.7 2006/09/07 05:02:20 didg Exp $
 dnl configure.in for netatalk
 
 AC_INIT(etc/afpd/main.c)
@@ -46,7 +46,7 @@
 dnl Replace `main' with a function in -ld:
 dnl AC_CHECK_LIB(d, main)
 dnl Replace `main' with a function in -ldl:
-AC_CHECK_LIB(dl, dlopen)
+dnl AC_CHECK_LIB(dl, dlopen)
 dnl Replace `main' with a function in -lkauth:
 dnl AC_CHECK_LIB(kauth, main)
 dnl Replace `main' with a function in -lkrb:
@@ -55,16 +55,17 @@
 dnl AC_CHECK_LIB(lwp, main)
 dnl Replace `main' with a function in -ln:
 dnl AC_CHECK_LIB(n, main)
-dnl Replace `main' with a function in -lnsl:
-AC_CHECK_LIB(nsl, main)
+
+dnl not the right stuff but should be enough for now
+AC_CHECK_FUNC(gethostbyname,,[AC_CHECK_LIB(nsl,gethostbyname)])
+AC_CHECK_FUNC(connect,,[AC_CHECK_LIB(socket,connect)])
+
 dnl Replace `main' with a function in -lprot:
 dnl AC_CHECK_LIB(prot, main)
 dnl Replace `main' with a function in -lrx:
 dnl AC_CHECK_LIB(rx, main)
 dnl Replace `main' with a function in -lrxkad:
 dnl AC_CHECK_LIB(rxkad, main)
-dnl Replace `main' with a function in -lsocket:
-AC_CHECK_LIB(socket, socket)
 dnl Replace `main' with a function in -lsys:
 dnl AC_CHECK_LIB(sys, main)
 dnl Replace `main' with a function in -lubik:
@@ -554,6 +555,16 @@
 
 NETATALK_AC_CUPS
 
+dnl check if we can use attribute unused (gcc only) from ethereal
+AC_MSG_CHECKING(to see if we can add '__attribute__((unused))' to CFLAGS)
+if test x$GCC != x ; then
+  CFLAGS="-D_U_=\"__attribute__((unused))\" $CFLAGS"
+  AC_MSG_RESULT(yes)
+else
+  CFLAGS="-D_U_=\"\" $CFLAGS"
+  AC_MSG_RESULT(no)
+fi
+
 dnl --------------------------------------------------------------------------
 dnl FHS stuff has to be done last because it overrides other defaults
 dnl --------------------------------------------------------------------------
@@ -695,10 +706,12 @@
 #	)
 
         # For quotas on Linux XFS filesystems
-        AC_CHECK_HEADERS(linux/xqm.h linux/xfs_fs.h)
-        AC_CHECK_HEADERS(xfs/libxfs.h xfs/xqm.h xfs/xfs_fs.h)
+        
         # For linux > 2.5.56
-        AC_CHECK_HEADERS(linux/dqblk_xfs.h)
+        AC_CHECK_HEADERS(linux/dqblk_xfs.h,,
+		[AC_CHECK_HEADERS(linux/xqm.h linux/xfs_fs.h)
+        	AC_CHECK_HEADERS(xfs/libxfs.h xfs/xqm.h xfs/xfs_fs.h)]
+	)
 
 
 	dnl ----- as far as I can tell, dbtob always does the wrong thing
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/distrib/initscripts/rc.atalk.redhat.tmpl netatalk/distrib/initscripts/rc.atalk.redhat.tmpl
--- netatalk.orig/distrib/initscripts/rc.atalk.redhat.tmpl	2004-01-09 01:23:32.000000000 +0100
+++ netatalk/distrib/initscripts/rc.atalk.redhat.tmpl	2006-09-15 01:26:10.000000000 +0200
@@ -19,13 +19,11 @@
 # Source networking configuration.
 . /etc/sysconfig/network
 
-# Quickly probe for appletalk and warn if we can't find it
-/sbin/modprobe appletalk || echo "[could not load appletalk module]"
-
-# Check for IP Encapsulation support
-#/sbin/modprobe ipddp || echo "[could not load IP encapsulation]"
-
 if [ ! -x ${ATALK_SBIN}/atalkd ]; then
+     # Quickly probe for appletalk and warn if we can't find it
+     #/sbin/modprobe appletalk || echo "[could not load appletalk module]"
+     # Check for IP Encapsulation support
+     #/sbin/modprobe ipddp || echo "[could not load IP encapsulation]"
      echo "[${ATALK_SBIN}/atalkd not found.  Did it compile?]";
      exit 0;
 fi
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/afpd/afp_asp.c netatalk/etc/afpd/afp_asp.c
--- netatalk.orig/etc/afpd/afp_asp.c	2004-05-04 17:38:23.000000000 +0200
+++ netatalk/etc/afpd/afp_asp.c	2005-09-27 12:40:40.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: afp_asp.c,v 1.18.6.6 2004/05/04 15:38:23 didg Exp $
+ * $Id: afp_asp.c,v 1.18.6.6.2.1 2005/09/27 10:40:40 didg Exp $
  *
  * Copyright (c) 1997 Adrian Sun (asun@zoology.washington.edu)
  * Copyright (c) 1990,1993 Regents of The University of Michigan.
@@ -196,7 +196,7 @@
 
 /* ---------------------- */
 #ifdef SERVERTEXT
-static void afp_asp_getmesg (int sig)
+static void afp_asp_getmesg (int sig _U_)
 {
     readmessage(child);
     asp_attention(child->handle, AFPATTN_MESG | AFPATTN_TIME(5));
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/afpd/afp_config.c netatalk/etc/afpd/afp_config.c
--- netatalk.orig/etc/afpd/afp_config.c	2005-01-31 18:00:38.000000000 +0100
+++ netatalk/etc/afpd/afp_config.c	2005-09-27 12:40:40.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: afp_config.c,v 1.22.6.9.2.2 2005/01/31 17:00:38 didg Exp $
+ * $Id: afp_config.c,v 1.22.6.9.2.3 2005/09/27 10:40:40 didg Exp $
  *
  * Copyright (c) 1997 Adrian Sun (asun@zoology.washington.edu)
  * All Rights Reserved.  See COPYRIGHT.
@@ -96,7 +96,7 @@
 }
 
 #ifdef USE_SRVLOC
-static void SRVLOC_callback(SLPHandle hslp, SLPError errcode, void *cookie) {
+static void SRVLOC_callback(SLPHandle hslp _U_, SLPError errcode, void *cookie) {
     *(SLPError*)cookie = errcode;
 }
 
@@ -535,7 +535,7 @@
     FILE *fp;
     char buf[LINESIZE + 1], *p, have_option = 0;
     struct afp_options options;
-    AFPConfig *config, *first = NULL; /* uninitialized, OK 310105 */
+    AFPConfig *config=NULL, *first = NULL; 
 
     status_reset();
     /* if config file doesn't exist, load defaults */
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/afpd/afp_dsi.c netatalk/etc/afpd/afp_dsi.c
--- netatalk.orig/etc/afpd/afp_dsi.c	2005-03-31 02:25:55.000000000 +0200
+++ netatalk/etc/afpd/afp_dsi.c	2005-09-27 12:40:40.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: afp_dsi.c,v 1.27.2.3.2.4.2.1 2005/03/31 00:25:55 didg Exp $
+ * $Id: afp_dsi.c,v 1.27.2.3.2.4.2.2 2005/09/27 10:40:40 didg Exp $
  *
  * Copyright (c) 1999 Adrian Sun (asun@zoology.washington.edu)
  * Copyright (c) 1990,1993 Regents of The University of Michigan.
@@ -166,7 +166,7 @@
 
 /* ---------------------- */
 #ifdef SERVERTEXT
-static void afp_dsi_getmesg (int sig)
+static void afp_dsi_getmesg (int sig _U_)
 {
     readmessage(child.obj);
     dsi_attention(child.obj->handle, AFPATTN_MESG | AFPATTN_TIME(5));
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/afpd/appl.c netatalk/etc/afpd/appl.c
--- netatalk.orig/etc/afpd/appl.c	2005-02-06 11:16:00.000000000 +0100
+++ netatalk/etc/afpd/appl.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: appl.c,v 1.12.2.1.2.2.2.1 2005/02/06 10:16:00 didg Exp $
+ * $Id: appl.c,v 1.12.2.1.2.2.2.2 2005/09/27 10:40:41 didg Exp $
  *
  * Copyright (c) 1990,1993 Regents of The University of Michigan.
  * All Rights Reserved.  See COPYRIGHT.
@@ -160,9 +160,9 @@
 
 
 int afp_addappl(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
-char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+AFPObj  *obj;
+char	*ibuf, *rbuf _U_;
+int	ibuflen _U_, *rbuflen;
 {
     struct vol		*vol;
     struct dir		*dir;
@@ -250,9 +250,9 @@
 }
 
 int afp_rmvappl(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
-char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+AFPObj  *obj;
+char	*ibuf, *rbuf _U_;
+int	ibuflen _U_, *rbuflen;
 {
     struct vol		*vol;
     struct dir		*dir;
@@ -324,9 +324,9 @@
 }
 
 int afp_getappl(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
+AFPObj  *obj;
 char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+int	ibuflen _U_, *rbuflen;
 {
     struct vol		*vol;
     char		*p, *q;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/afpd/auth.c netatalk/etc/afpd/auth.c
--- netatalk.orig/etc/afpd/auth.c	2005-03-11 16:36:58.000000000 +0100
+++ netatalk/etc/afpd/auth.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: auth.c,v 1.44.2.3.2.15.2.3 2005/03/11 15:36:58 didg Exp $
+ * $Id: auth.c,v 1.44.2.3.2.15.2.4 2005/09/27 10:40:41 didg Exp $
  *
  * Copyright (c) 1990,1993 Regents of The University of Michigan.
  * All Rights Reserved.  See COPYRIGHT.
@@ -154,18 +154,17 @@
     return AFP_OK;
 }
 
-
 static int afp_errpwdexpired(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
-char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+AFPObj  *obj _U_;
+char	*ibuf _U_, *rbuf _U_;
+int	ibuflen _U_, *rbuflen;
 {
     *rbuflen = 0;
     return AFPERR_PWDEXPR;
 }
 
 
-static int set_auth_switch(AFPObj *obj, int expired)
+static int set_auth_switch(int expired)
 {
     int i;
 
@@ -364,7 +363,7 @@
 #endif /* ADMIN_GRP */
         uuid = pwd->pw_uid;
 
-    set_auth_switch(obj, expired);
+    set_auth_switch(expired);
 
     obj->logout = logout;
 
@@ -379,8 +378,8 @@
 /* ---------------------- */
 int afp_zzz (obj, ibuf, ibuflen, rbuf, rbuflen ) /* Function 122 */
 AFPObj       *obj;
-char         *ibuf, *rbuf;
-unsigned int ibuflen, *rbuflen;
+char         *ibuf  _U_, *rbuf;
+unsigned int ibuflen  _U_, *rbuflen;
 {
     u_int32_t	retdata;
 
@@ -530,9 +529,9 @@
 
 /* ---------------------- */
 int afp_disconnect(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
-char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+AFPObj  *obj  _U_;
+char	*ibuf, *rbuf  _U_;
+int	ibuflen  _U_, *rbuflen;
 {
     u_int16_t           type;
 
@@ -827,8 +826,8 @@
 
 int afp_logout(obj, ibuf, ibuflen, rbuf, rbuflen)
 AFPObj     *obj;
-char       *ibuf, *rbuf;
-int        ibuflen, *rbuflen;
+char       *ibuf _U_, *rbuf  _U_;
+int        ibuflen  _U_, *rbuflen  _U_;
 {
     LOG(log_info, logtype_afpd, "logout %s", obj->username);
     close_all_vol();
@@ -906,7 +905,7 @@
         (ret == AFPERR_AUTHCONT) ? "continued" :
         (ret ? "failed" : "succeeded"));
     if ( ret == AFP_OK )
-	set_auth_switch(obj, 0);
+	set_auth_switch(0);
 	
     return ret;
 }
@@ -914,9 +913,9 @@
 
 /* FPGetUserInfo */
 int afp_getuserinfo(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
+AFPObj  *obj _U_;
 char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+int	ibuflen _U_, *rbuflen;
 {
     u_int8_t  thisuser;
     u_int32_t id;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/afpd/catsearch.c netatalk/etc/afpd/catsearch.c
--- netatalk.orig/etc/afpd/catsearch.c	2005-05-02 18:34:23.000000000 +0200
+++ netatalk/etc/afpd/catsearch.c	2006-09-19 04:24:04.000000000 +0200
@@ -97,7 +97,7 @@
     u_int16_t offcnt;           /* Offspring count */
 	struct finderinfo finfo;    /* Finder info */
 	char lname[64];             /* Long name */ 
-	char utf8name[512];         /* UTF8 name */
+	char utf8name[514];         /* UTF8 or UCS2 name */ /* for convert_charset dest_len parameter +2 */
 };
 
 /*
@@ -233,12 +233,13 @@
 
 /* -------------------- */
 static struct finderinfo *
-unpack_finderinfo(char *upath, struct adouble *adp, struct finderinfo *finfo)
+unpack_finderinfo(struct vol *vol, struct path *path, struct adouble **adp, struct finderinfo *finfo)
 {
 	packed_finder  buf;
 	void           *ptr;
 	
-	ptr = get_finderinfo(upath, adp, &buf);
+    *adp = adl_lkup(vol, path, *adp);
+	ptr = get_finderinfo(vol, path->u_name, *adp, &buf);
 	return unpack_buffer(finfo, ptr);
 }
 
@@ -258,7 +259,7 @@
 	struct adouble *adp = NULL;
 	time_t c_date, b_date;
 	u_int32_t ac_date, ab_date;
-	static char convbuf[512];
+	static char convbuf[514]; /* for convert_charset dest_len parameter +2 */
 	size_t len;
 
 	if (S_ISDIR(path->st.st_mode)) {
@@ -301,7 +302,7 @@
 	if ((c1.rbitmap & (1<<DIRPBIT_LNAME))) { 
 		if ( (size_t)(-1) == (len = convert_string(vol->v_maccharset, CH_UCS2, path->m_name, strlen(path->m_name), convbuf, 512)) )
 			goto crit_check_ret;
-		convbuf[len] = 0; 
+
 		if ((c1.rbitmap & (1<<CATPBIT_PARTIAL))) {
 			if (strcasestr_w( (ucs2_t*) convbuf, (ucs2_t*) c1.lname) == NULL)
 				goto crit_check_ret;
@@ -314,7 +315,7 @@
 		if ( (size_t)(-1) == (len = convert_charset( CH_UTF8_MAC, CH_UCS2, CH_UTF8, path->m_name, strlen(path->m_name), convbuf, 512, &flags))) {
 			goto crit_check_ret;
 		}
-		convbuf[len] = 0; 
+
 		if (c1.rbitmap & (1<<CATPBIT_PARTIAL)) {
 			if (strcasestr_w((ucs2_t *) convbuf, (ucs2_t*)c1.utf8name) == NULL)
 				goto crit_check_ret;
@@ -372,8 +373,7 @@
 
         /* Check file type ID */
 	if ((c1.rbitmap & (1<<DIRPBIT_FINFO)) && c2.finfo.f_type != 0) {
-		adp = adl_lkup(vol, path, adp);
-	    finfo = unpack_finderinfo(path->u_name, adp, &finderinfo);
+	    finfo = unpack_finderinfo(vol, path, &adp, &finderinfo);
 		if (finfo->f_type != c1.finfo.f_type)
 			goto crit_check_ret;
 	}
@@ -381,8 +381,7 @@
 	/* Check creator ID */
 	if ((c1.rbitmap & (1<<DIRPBIT_FINFO)) && c2.finfo.creator != 0) {
 		if (!finfo) {
-	    	adp = adl_lkup(vol, path, adp);
-			finfo = unpack_finderinfo(path->u_name, adp, &finderinfo);
+			finfo = unpack_finderinfo(vol, path, &adp, &finderinfo);
 		}
 		if (finfo->creator != c1.finfo.creator)
 			goto crit_check_ret;
@@ -391,8 +390,7 @@
 	/* Check finder info attributes */
 	if ((c1.rbitmap & (1<<DIRPBIT_FINFO)) && c2.finfo.attrs != 0) {
 		if (!finfo) {
-	    	adp = adl_lkup(vol, path, adp);
-			finfo = unpack_finderinfo(path->u_name, adp, &finderinfo);
+			finfo = unpack_finderinfo(vol, path, &adp, &finderinfo);
 		}
 
 		if ((finfo->attrs & c2.finfo.attrs) != c1.finfo.attrs)
@@ -402,8 +400,7 @@
 	/* Check label */
 	if ((c1.rbitmap & (1<<DIRPBIT_FINFO)) && c2.finfo.label != 0) {
 		if (!finfo) {
-	    	adp = adl_lkup(vol, path, adp);
-			finfo = unpack_finderinfo(path->u_name, adp, &finderinfo);
+			finfo = unpack_finderinfo(vol, path, &adp, &finderinfo);
 		}
 		if ((finfo->label & c2.finfo.label) != c1.finfo.label)
 			goto crit_check_ret;
@@ -663,7 +660,7 @@
 } /* catsearch() */
 
 /* -------------------------- */
-int catsearch_afp(AFPObj *obj, char *ibuf, int ibuflen,
+int catsearch_afp(AFPObj *obj _U_, char *ibuf, int ibuflen,
                   char *rbuf, int *rbuflen, int ext)
 {
     struct vol *vol;
@@ -827,10 +824,9 @@
         /* Get the long filename */	
 		memcpy(tmppath, bspec1 + spec1[1] + 1, (bspec1 + spec1[1])[0]);
 		tmppath[(bspec1 + spec1[1])[0]]= 0;
-		len = convert_string ( vol->v_maccharset, CH_UCS2, tmppath, strlen(tmppath), c1.lname, 64);
+		len = convert_string ( vol->v_maccharset, CH_UCS2, tmppath, strlen(tmppath), c1.lname, sizeof(c1.lname));
         if (len == (size_t)(-1))
             return AFPERR_PARAM;
-		c1.lname[len] = 0;
 
 #if 0	
 		/* FIXME: do we need it ? It's always null ! */
@@ -861,7 +857,6 @@
  		len = convert_charset(CH_UTF8_MAC, CH_UCS2, CH_UTF8, c1.utf8name, namelen, c1.utf8name, 512, &flags);
         if (len == (size_t)(-1))
             return AFPERR_PARAM;
- 		c1.utf8name[len]=0;
     }
     
     /* Call search */
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/afpd/desktop.c netatalk/etc/afpd/desktop.c
--- netatalk.orig/etc/afpd/desktop.c	2005-02-10 02:23:10.000000000 +0100
+++ netatalk/etc/afpd/desktop.c	2006-09-19 02:08:00.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: desktop.c,v 1.26.2.4.2.18.2.2 2005/02/10 01:23:10 didg Exp $
+ * $Id: desktop.c,v 1.26.2.4.2.18.2.7 2006/09/19 00:08:00 didg Exp $
  *
  * See COPYRIGHT.
  *
@@ -41,9 +41,9 @@
 
 
 int afp_opendt(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
+AFPObj  *obj _U_;
 char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+int	ibuflen _U_, *rbuflen;
 {
     struct vol	*vol;
     u_int16_t	vid;
@@ -62,9 +62,9 @@
 }
 
 int afp_closedt(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
-char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+AFPObj  *obj _U_;
+char	*ibuf _U_, *rbuf _U_;
+int	ibuflen _U_, *rbuflen;
 {
     *rbuflen = 0;
     return( AFP_OK );
@@ -127,9 +127,9 @@
 }
 
 int afp_addicon(obj, ibuf, ibuflen, rbuf, rbuflen)
-AFPObj      *obj;
+AFPObj  *obj;
 char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+int	ibuflen _U_, *rbuflen;
 {
     struct vol		*vol;
 #ifndef NO_DDP
@@ -311,11 +311,13 @@
     return( AFP_OK );
 }
 
-static u_char	utag[] = { 0, 0, 0, 0 };
-static u_char	ucreator[] = { 0, 0, 0, 0 };/* { 'U', 'N', 'I', 'X' };*/
-static u_char	utype[] = { 0, 0, 0, 0 };/* { 'T', 'E', 'X', 'T' };*/
-static short	usize = 256;
-static u_char	uicon[] = {
+static const u_char	utag[] = { 0, 0, 0, 0 };
+static const u_char	ucreator[] = { 0, 0, 0, 0 };/* { 'U', 'N', 'I', 'X' };*/
+static const u_char	utype[] = { 0, 0, 0, 0 };/* { 'T', 'E', 'X', 'T' };*/
+static const short	usize = 256;
+
+#if 0
+static const u_char	uicon[] = {
     0x1F, 0xFF, 0xFC, 0x00, 0x10, 0x00, 0x06, 0x00,
     0x10, 0x00, 0x05, 0x00, 0x10, 0x00, 0x04, 0x80,
     0x10, 0x00, 0x04, 0x40, 0x10, 0x00, 0x04, 0x20,
@@ -349,11 +351,12 @@
     0x1F, 0xFF, 0xFF, 0xF0, 0x1F, 0xFF, 0xFF, 0xF0,
     0x1F, 0xFF, 0xFF, 0xF0, 0x1F, 0xFF, 0xFF, 0xF0,
 };
+#endif
 
 int afp_geticoninfo(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
+AFPObj  *obj _U_;
 char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+int	ibuflen _U_, *rbuflen;
 {
     struct vol	*vol;
     u_char	fcreator[ 4 ], ih[ 12 ];
@@ -425,9 +428,9 @@
 
 
 int afp_geticon(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
+AFPObj  *obj;
 char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+int	ibuflen _U_, *rbuflen;
 {
     struct vol	*vol;
     off_t       offset;
@@ -454,6 +457,7 @@
     memcpy( &bsize, ibuf, sizeof( bsize ));
     bsize = ntohs( bsize );
 
+#if 0
     if ( memcmp( fcreator, ucreator, sizeof( ucreator )) == 0 &&
             memcmp( ftype, utype, sizeof( utype )) == 0 &&
             itype == 1 &&
@@ -462,6 +466,7 @@
         *rbuflen = bsize;
         return( AFP_OK );
     }
+#endif
 
     if ( iconopen( vol, fcreator, O_RDONLY, 0 ) < 0) {
         return( AFPERR_NOITEM );
@@ -574,7 +579,7 @@
 }
 
 /* ---------------------- */
-static char		hexdig[] = "0123456789abcdef";
+static const char		hexdig[] = "0123456789abcdef";
 char *dtfile(const struct vol *vol, u_char creator[], char *ext )
 {
     static char	path[ MAXPATHLEN + 1];
@@ -613,8 +618,8 @@
  * mpath is only a filename 
  * did filename parent directory ID.
 */
-static char  upath[ MAXPATHLEN + 1];
-static char  mpath[ MAXPATHLEN + 1];
+static char  upath[ MAXPATHLEN + 2]; /* for convert_charset dest_len parameter +2 */
+static char  mpath[ MAXPATHLEN + 2];/* for convert_charset dest_len parameter +2 */
 
 char *mtoupath(const struct vol *vol, char *mpath, cnid_t did, int utf8)
 {
@@ -653,7 +658,6 @@
         LOG(log_error, logtype_afpd, "conversion from %s to %s for %s failed.", (utf8)?"UTF8-MAC":vol->v_maccodepage, vol->v_volcodepage, mpath);
 	    return NULL;
     }
-    upath[outlen] = 0;
 
 #ifdef DEBUG
     LOG(log_debug, logtype_afpd, "mtoupath: '%s':'%s'", mpath, upath);
@@ -686,7 +690,6 @@
 	goto utompath_error;
     }
 
-    mpath[outlen] = 0; 
     if (!(flags & CONV_REQMANGLE)) 
         flags = 0;
     else
@@ -757,9 +760,9 @@
 
 /* ----------------------------- */
 int afp_addcomment(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
-char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+AFPObj      *obj _U_;
+char	*ibuf, *rbuf _U_;
+int		ibuflen _U_, *rbuflen;
 {
     struct vol		*vol;
     struct dir		*dir;
@@ -800,7 +803,7 @@
     struct ofork        *of;
     char		*upath;
     int                 isadir;
-
+    int			clen;
 
     upath = path->u_name;
     isadir = path_isadir(path);
@@ -815,6 +818,7 @@
     }
 
     if (!ad_getentryoff(adp, ADEID_COMMENT)) {
+        ad_close( adp, ADFLAGS_HF );
         return AFPERR_NOITEM;
     }
     /*
@@ -826,10 +830,10 @@
         return( AFPERR_NOITEM );
     }
 
-    *rbuf++ = ad_getentrylen( adp, ADEID_COMMENT );
-    memcpy( rbuf, ad_entry( adp, ADEID_COMMENT ),
-            ad_getentrylen( adp, ADEID_COMMENT ));
-    *rbuflen = ad_getentrylen( adp, ADEID_COMMENT ) + 1;
+    clen = min( ad_getentrylen( adp, ADEID_COMMENT ), 128 ); /* OSX only use 128, greater kill Adobe CS2 */
+    *rbuf++ = clen;
+    memcpy( rbuf, ad_entry( adp, ADEID_COMMENT ), clen);
+    *rbuflen = clen + 1;
     ad_close( adp, ADFLAGS_HF );
 
     return( AFP_OK );
@@ -837,9 +841,9 @@
 
 /* -------------------- */
 int afp_getcomment(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
+AFPObj      *obj _U_;
 char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+int		ibuflen _U_, *rbuflen;
 {
     struct vol		*vol;
     struct dir		*dir;
@@ -912,9 +916,9 @@
 
 /* ----------------------- */
 int afp_rmvcomment(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
-char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+AFPObj      *obj _U_;
+char	*ibuf, *rbuf _U_;
+int		ibuflen _U_, *rbuflen;
 {
     struct vol		*vol;
     struct dir		*dir;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/afpd/directory.c netatalk/etc/afpd/directory.c
--- netatalk.orig/etc/afpd/directory.c	2005-02-10 02:23:10.000000000 +0100
+++ netatalk/etc/afpd/directory.c	2006-09-19 04:24:04.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: directory.c,v 1.71.2.4.2.15.2.5 2005/02/10 01:23:10 didg Exp $
+ * $Id: directory.c,v 1.71.2.4.2.15.2.9 2006/09/19 02:24:04 didg Exp $
  *
  * Copyright (c) 1990,1993 Regents of The University of Michigan.
  * All Rights Reserved.  See COPYRIGHT.
@@ -1116,7 +1116,7 @@
                     static char	temp[ MAXPATHLEN + 1];
 
                     /* not an UTF8 name */
-                    if (mtoUTF8(vol, path, strlen(path), temp, MAXPATHLEN) == -1) {
+                    if (mtoUTF8(vol, path, strlen(path), temp, MAXPATHLEN) == (size_t)-1) {
                         afp_errno = AFPERR_PARAM;
                         return( NULL );
                     }
@@ -1290,6 +1290,12 @@
 
 }
 
+/* --------------------- */
+static int invisible_dots(const struct vol *vol, const char *name)
+{ 
+  return vol_inv_dots(vol) && *name  == '.' && strcmp(name, ".") && strcmp(name, "..");
+}
+
 /* ------------------------------ 
    (".", curdir)
    (name, dir) with curdir:name == dir, from afp_enumerate
@@ -1343,8 +1349,7 @@
         case DIRPBIT_ATTR :
             if ( isad ) {
                 ad_getattr(&ad, &ashort);
-            } else if (*dir->d_u_name == '.' && strcmp(dir->d_u_name, ".") 
-                        && strcmp(dir->d_u_name, "..")) {
+            } else if (invisible_dots(vol, dir->d_u_name)) {
                 ashort = htons(ATTRBIT_INVISIBLE);
             } else
                 ashort = 0;
@@ -1387,12 +1392,10 @@
                 ashort = htons(FINDERINFO_CLOSEDVIEW);
                 memcpy(data + FINDERINFO_FRVIEWOFF, &ashort, sizeof(ashort));
 
-                /* dot files are by default invisible */
-                if (*dir->d_u_name  == '.' && strcmp(dir->d_u_name , ".") &&
-                        strcmp(dir->d_u_name , "..")) {
+                /* dot files are by default visible */
+                if (invisible_dots(vol, dir->d_u_name)) {
                     ashort = htons(FINDERINFO_INVISIBLE);
-                    memcpy(data + FINDERINFO_FRFLAGOFF,
-                           &ashort, sizeof(ashort));
+                    memcpy(data + FINDERINFO_FRFLAGOFF, &ashort, sizeof(ashort));
                 }
             }
             data += 32;
@@ -1542,9 +1545,9 @@
 
 /* ----------------------------- */
 int afp_setdirparams(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
-char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+AFPObj  *obj;
+char	*ibuf, *rbuf _U_;
+int	ibuflen _U_, *rbuflen;
 {
     struct vol	*vol;
     struct dir	*dir;
@@ -1639,7 +1642,7 @@
 
     char                *upath;
     struct dir          *dir;
-    int			bit, aint, isad = 1;
+    int			bit, isad = 1;
     int                 cdate, bdate;
     int                 owner, group;
     u_int16_t		ashort, bshort;
@@ -1650,7 +1653,7 @@
     u_int16_t           bitmap = d_bitmap;
     u_char              finder_buf[32];
     u_int32_t		upriv;
-    mode_t              mpriv;          /* uninitialized, OK 310105 */
+    mode_t              mpriv = 0;        
     u_int16_t           upriv_bit = 0;
 
     bit = 0;
@@ -1704,7 +1707,7 @@
             ma.ma_world = *buf++;
             ma.ma_group = *buf++;
             ma.ma_owner = *buf++;
-            mpriv = mtoumode( &ma );
+            mpriv = mtoumode( &ma ) | vol->v_perm;
             if (dir_rx_set(mpriv) && setdirmode( vol, upath, mpriv) < 0 ) {
                 err = set_dir_errors(path, "setdirmode", errno);
                 bitmap = 0;
@@ -1724,20 +1727,21 @@
             break;
 	case DIRPBIT_UNIXPR :
 	    if (vol_unix_priv(vol)) {
-	        /* Skip UID and GID for now, there seems to be no way to set them from an OSX client anyway */
-                buf += sizeof( aint );
-                buf += sizeof( aint );
+                memcpy( &owner, buf, sizeof(owner)); /* FIXME need to change owner too? */
+                buf += sizeof( owner );
+                memcpy( &group, buf, sizeof( group ));
+                buf += sizeof( group );
 
                 change_mdate = 1;
                 change_parent_mdate = 1;
                 memcpy( &upriv, buf, sizeof( upriv ));
                 buf += sizeof( upriv );
-                upriv = ntohl (upriv);
+                upriv = ntohl (upriv) | vol->v_perm;
                 if (dir_rx_set(upriv)) {
                     /* maybe we are trying to set perms back */
                     if ( setdirunixmode(vol, upath, upriv) < 0 ) {
                         bitmap = 0;
-                        err = set_dir_errors(path, "setdirmode", errno);
+                        err = set_dir_errors(path, "setdirunixmode", errno);
                     }
                 }
                 else {
@@ -1855,27 +1859,14 @@
                 goto setdirparam_done;
             }
             break;
-
         case DIRPBIT_GID :
             if (dir->d_did == DIRDID_ROOT)
                 setdeskowner( -1, ntohl(group) ); 
-
-#if 0       /* don't error if we can't set the desktop owner. */
-                err = set_dir_errors(path, "setdeskowner", errno);
-                if (isad && err == AFPERR_PARAM) {
-                    err = AFP_OK; /* ???*/
-                }
-                else {
-                    goto setdirparam_done;
-                }
-#endif /* 0 */
-
             if ( setdirowner(vol, upath, -1, ntohl(group) ) < 0 ) {
                 err = set_dir_errors(path, "setdirowner", errno);
                 goto setdirparam_done;
             }
             break;
-
         case DIRPBIT_ACCESS :
             if (dir->d_did == DIRDID_ROOT) {
                 setdeskmode(mpriv);
@@ -1900,21 +1891,29 @@
 	case DIRPBIT_UNIXPR :
 	    if (vol_unix_priv(vol)) {
                 if (dir->d_did == DIRDID_ROOT) {
-                    setdeskmode( upriv );
                     if (!dir_rx_set(upriv)) {
                         /* we can't remove read and search for owner on volume root */
                         err = AFPERR_ACCESS;
                         goto setdirparam_done;
                     }
+                    setdeskowner( -1, ntohl(group) ); 
+                    setdeskmode( upriv );
+                }
+                if ( setdirowner(vol, upath, -1, ntohl(group) ) < 0 ) {
+                    err = set_dir_errors(path, "setdirowner", errno);
+                    goto setdirparam_done;
                 }
 
                 if ( upriv_bit && setdirunixmode(vol, upath, upriv) < 0 ) {
-                    err = set_dir_errors(path, "setdirmode", errno);
+                    err = set_dir_errors(path, "setdirunixmode", errno);
                     goto setdirparam_done;
                 }
-                break;
             }
-            /* fall through */
+            else {
+                err = AFPERR_BITMAP;
+                goto setdirparam_done;
+            }
+            break;
         default :
             err = AFPERR_BITMAP;
             goto setdirparam_done;
@@ -1963,9 +1962,9 @@
 }
 
 int afp_createdir(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
+AFPObj  *obj;
 char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+int	ibuflen _U_, *rbuflen;
 {
     struct adouble	ad;
     struct vol		*vol;
@@ -2257,9 +2256,9 @@
 }
 
 int afp_mapid(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
+AFPObj  *obj;
 char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+int	ibuflen _U_, *rbuflen;
 {
     struct passwd	*pw;
     struct group	*gr;
@@ -2330,9 +2329,9 @@
 }
 
 int afp_mapname(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
+AFPObj  *obj _U_;
 char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+int	ibuflen _U_, *rbuflen;
 {
     struct passwd	*pw;
     struct group	*gr;
@@ -2394,9 +2393,9 @@
   variable DID support 
 */
 int afp_closedir(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
-char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+AFPObj  *obj _U_;
+char	*ibuf _U_, *rbuf _U_;
+int	ibuflen _U_, *rbuflen;
 {
 #if 0
     struct vol   *vol;
@@ -2433,9 +2432,9 @@
  * there's a pb again with case but move it to cname
 */
 int afp_opendir(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
+AFPObj  *obj _U_;
 char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+int	ibuflen  _U_, *rbuflen;
 {
     struct vol		*vol;
     struct dir		*parentdir;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/afpd/enumerate.c netatalk/etc/afpd/enumerate.c
--- netatalk.orig/etc/afpd/enumerate.c	2004-06-20 17:10:14.000000000 +0200
+++ netatalk/etc/afpd/enumerate.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: enumerate.c,v 1.39.2.2.2.5 2004/06/20 15:10:14 bfernhomberg Exp $
+ * $Id: enumerate.c,v 1.39.2.2.2.5.2.1 2005/09/27 10:40:41 didg Exp $
  *
  * Copyright (c) 1990,1993 Regents of The University of Michigan.
  * All Rights Reserved.  See COPYRIGHT.
@@ -110,7 +110,7 @@
 };
 #define SDBUFBRK	2048
 
-static int enumerate_loop(struct dirent *de, char *mname, void *data)
+static int enumerate_loop(struct dirent *de, char *mname _U_, void *data)
 {
     struct savedir *sd = data; 
     char *start, *end;
@@ -221,9 +221,9 @@
 
 /* ----------------------------- */
 static int enumerate(obj, ibuf, ibuflen, rbuf, rbuflen, ext )
-AFPObj       *obj;
+AFPObj       *obj _U_;
 char	     *ibuf, *rbuf;
-unsigned int ibuflen, *rbuflen;
+unsigned int ibuflen _U_, *rbuflen;
 int     ext;
 {
     static struct savedir	sd = { 0, 0, 0, NULL, NULL, 0 };
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/afpd/file.c netatalk/etc/afpd/file.c
--- netatalk.orig/etc/afpd/file.c	2005-04-28 11:24:04.000000000 +0200
+++ netatalk/etc/afpd/file.c	2007-05-14 20:25:27.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: file.c,v 1.92.2.2.2.31.2.13 2005/04/28 09:24:04 didg Exp $
+ * $Id: file.c,v 1.92.2.2.2.31.2.21 2007/05/14 18:25:27 didg Exp $
  *
  * Copyright (c) 1990,1993 Regents of The University of Michigan.
  * All Rights Reserved.  See COPYRIGHT.
@@ -89,7 +89,7 @@
 }
 
 /* FIXME path : unix or mac name ? (for now it's unix name ) */
-void *get_finderinfo(const char *upath, struct adouble *adp, void *data)
+void *get_finderinfo(const struct vol *vol, const char *upath, struct adouble *adp, void *data)
 {
     struct extmap	*em;
     void                *ad_finder = NULL;
@@ -107,11 +107,11 @@
     else {
         memcpy(data, ufinderi, ADEDLEN_FINDERI);
         chk_ext = 1;
-        if (*upath == '.') { /* make it invisible */
+        if (vol_inv_dots(vol) && *upath == '.') { /* make it invisible */
             u_int16_t ashort;
             
             ashort = htons(FINDERINFO_INVISIBLE);
-            memcpy(data + FINDERINFO_FRFLAGOFF, &ashort, sizeof(ashort));
+            memcpy((char *)data + FINDERINFO_FRFLAGOFF, &ashort, sizeof(ashort));
         }
     }
     /** Only enter if no appledouble information and no finder information found. */
@@ -282,7 +282,7 @@
         case FILPBIT_ATTR :
             if ( adp ) {
                 ad_getattr(adp, &ashort);
-            } else if (*upath == '.') {
+            } else if (vol_inv_dots(vol) && *upath == '.') {
                 ashort = htons(ATTRBIT_INVISIBLE);
             } else
                 ashort = 0;
@@ -336,7 +336,7 @@
             break;
 
         case FILPBIT_FINFO :
-	    get_finderinfo(upath, adp, (char *)data);
+	    get_finderinfo(vol, upath, adp, (char *)data);
             data += ADEDLEN_FINDERI;
             break;
 
@@ -584,9 +584,9 @@
 
 /* ----------------------------- */
 int afp_createfile(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
-char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+AFPObj  *obj;
+char	*ibuf, *rbuf _U_;
+int	ibuflen _U_, *rbuflen;
 {
     struct adouble	ad, *adp;
     struct vol		*vol;
@@ -657,7 +657,7 @@
         openf = O_RDWR|O_CREAT|O_EXCL;
     }
 
-    if ( ad_open( upath, vol_noadouble(vol)|ADFLAGS_DF|ADFLAGS_HF|ADFLAGS_NOHF,
+    if ( ad_open( upath, vol_noadouble(vol)|ADFLAGS_DF|ADFLAGS_HF|ADFLAGS_NOHF|ADFLAGS_CREATE,
                   openf, 0666, adp) < 0 ) {
         switch ( errno ) {
         case EROFS:
@@ -668,6 +668,9 @@
             return( AFPERR_EXIST );
         case EACCES :
             return( AFPERR_ACCESS );
+        case EDQUOT:
+        case ENOSPC :
+            return( AFPERR_DFULL );
         default :
             return( AFPERR_PARAM );
         }
@@ -710,9 +713,9 @@
 }
 
 int afp_setfilparams(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
-char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+AFPObj  *obj;
+char	*ibuf, *rbuf _U_;
+int	ibuflen _U_, *rbuflen;
 {
     struct vol	*vol;
     struct dir	*dir;
@@ -1199,9 +1202,9 @@
 /* -----------------------------------
 */
 int afp_copyfile(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
-char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+AFPObj  *obj;
+char	*ibuf, *rbuf _U_;
+int	ibuflen _U_, *rbuflen;
 {
     struct vol	*s_vol, *d_vol;
     struct dir	*dir;
@@ -1405,6 +1408,7 @@
 /* ----------------------------------
  * if newname is NULL (from directory.c) we don't want to copy ressource fork.
  * because we are doing it elsewhere.
+ * currently if newname is NULL then adp is NULL. 
  */
 int copyfile(s_vol, d_vol, src, dst, newname, adp )
 const struct vol *s_vol, *d_vol;
@@ -1416,6 +1420,7 @@
     int                 ret_err = 0;
     int                 adflags;
     int                 noadouble = vol_noadouble(d_vol);
+    int                 stat_result;
     struct stat         st;
     
 #ifdef DEBUG
@@ -1442,7 +1447,14 @@
         adflags &= ~ADFLAGS_HF;
     }
 
-    if (ad_open(dst , adflags | noadouble, O_RDWR|O_CREAT|O_EXCL, 0666, &add) < 0) {
+    stat_result = fstat(ad_dfileno(adp), &st); /* saving stat exit code, thus saving us on one more stat later on */
+
+    if (stat_result < 0) {           
+      /* unlikely but if fstat fails, the default file mode will be 0666. */
+      st.st_mode = S_IRUSR | S_IWUSR | S_IRGRP | S_IWGRP | S_IROTH | S_IWOTH;
+    }
+
+    if (ad_open(dst , adflags, O_RDWR|O_CREAT|O_EXCL, st.st_mode, &add) < 0) {
         ret_err = errno;
         ad_close( adp, adflags );
         if (EEXIST != ret_err) {
@@ -1451,6 +1463,8 @@
         }
         return AFPERR_EXIST;
     }
+    /* XXX if the source and the dest don't use the same resource type it's broken
+    */
     if (ad_hfileno(adp) == -1 || 0 == (err = copy_fd(ad_hfileno(&add), ad_hfileno(adp)))){
         /* copy the data fork */
 	err = copy_fd(ad_dfileno(&add), ad_dfileno(adp));
@@ -1463,29 +1477,32 @@
     ad_close( adp, adflags );
 
     if (ad_close( &add, adflags ) <0) {
+        if (!ret_err) {
+            ret_err = errno;
+        }
         deletefile(d_vol, dst, 0);
-        ret_err = errno;
         goto done;
     } 
-    else {
+
+    if (!ret_err && newname && (adflags & ADFLAGS_HF)) {
+        /* set the new name in the resource fork */
 	ad_init(&add, d_vol->v_adouble, d_vol->v_ad_options);
-	if (ad_open(dst , adflags | noadouble, O_RDWR, 0666, &add) < 0) {
+	if (ad_open(dst , ADFLAGS_HF | noadouble, O_RDWR, 0666, &add) < 0) {
 	    ret_err = errno;
 	}
+	else {
+            ad_setname(&add, newname);
+            ad_flush( &add, ADFLAGS_HF );
+            if (ad_close( &add, ADFLAGS_HF ) <0) {
+                ret_err = errno;
+            }
+        }
     }
 
-    if (!ret_err && newname) {
-        ad_setname(&add, newname);
-    }
-
-    ad_flush( &add, adflags );
-    if (ad_close( &add, adflags ) <0) {
-       ret_err = errno;
-    }
     if (ret_err) {
         deletefile(d_vol, dst, 0);
     }
-    else if (!stat(src, &st)) {
+    else if (stat_result == 0) {
         /* set dest modification date to src date */
         struct utimbuf	ut;
 
@@ -1635,9 +1652,9 @@
 /* ------------------------------------ */
 /* return a file id */
 int afp_createid(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
+AFPObj  *obj _U_;
 char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+int	ibuflen _U_, *rbuflen;
 {
     struct stat         *st;
     struct vol		*vol;
@@ -1773,9 +1790,9 @@
 /* ------------------------------
    resolve a file id */
 int afp_resolveid(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
+AFPObj      *obj _U_;
 char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+int		ibuflen _U_, *rbuflen;
 {
     struct vol		*vol;
     struct dir		*dir;
@@ -1885,9 +1902,9 @@
 
 /* ------------------------------ */
 int afp_deleteid(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
-char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+AFPObj  *obj _U_;
+char	*ibuf, *rbuf _U_;
+int	ibuflen _U_, *rbuflen;
 {
     struct stat         st;
     struct vol		*vol;
@@ -2021,9 +2038,9 @@
 #define APPLETEMP ".AppleTempXXXXXX"
 
 int afp_exchangefiles(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
-char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+AFPObj  *obj;
+char	*ibuf, *rbuf _U_ ;
+int	ibuflen _U_, *rbuflen;
 {
     struct stat         srcst, destst;
     struct vol		*vol;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/afpd/filedir.c netatalk/etc/afpd/filedir.c
--- netatalk.orig/etc/afpd/filedir.c	2005-02-10 02:23:14.000000000 +0100
+++ netatalk/etc/afpd/filedir.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: filedir.c,v 1.45.2.2.2.14.2.2 2005/02/10 01:23:14 didg Exp $
+ * $Id: filedir.c,v 1.45.2.2.2.14.2.4 2005/09/27 10:40:41 didg Exp $
  *
  * Copyright (c) 1990,1993 Regents of The University of Michigan.
  * All Rights Reserved.  See COPYRIGHT.
@@ -130,9 +130,9 @@
 #endif
 
 int afp_getfildirparams(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
+AFPObj  *obj _U_;
 char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+int	ibuflen _U_, *rbuflen;
 {
     struct stat		*st;
     struct vol		*vol;
@@ -225,9 +225,9 @@
 }
 
 int afp_setfildirparams(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
-char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+AFPObj  *obj;
+char	*ibuf, *rbuf _U_;
+int	ibuflen _U_, *rbuflen;
 {
     struct stat	*st;
     struct vol	*vol;
@@ -440,9 +440,9 @@
 
 /* -------------------------------------------- */
 int afp_rename(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
-char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+AFPObj  *obj;
+char	*ibuf, *rbuf _U_;
+int	ibuflen _U_, *rbuflen;
 {
     struct vol	*vol;
     struct dir	*sdir;
@@ -526,9 +526,9 @@
 
 /* ------------------------------- */
 int afp_delete(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
-char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+AFPObj  *obj;
+char	*ibuf, *rbuf _U_;
+int	ibuflen _U_, *rbuflen;
 {
     struct vol		*vol;
     struct dir		*dir;
@@ -643,9 +643,9 @@
 
 /* ------------------------- */
 int afp_moveandrename(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
-char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+AFPObj  *obj;
+char	*ibuf, *rbuf _U_;
+int	ibuflen  _U_, *rbuflen;
 {
     struct vol	*vol;
     struct dir	*sdir, *ddir;
@@ -748,7 +748,7 @@
 #endif /* DROPKLUDGE */
             /* if unix priv don't try to match perm with dest folder */
             if (!isdir && !vol_unix_priv(vol)) {
-                int  admode = ad_mode("", 0777);
+                int  admode = ad_mode("", 0777) | vol->v_perm;
 
                 setfilmode(upath, admode, NULL);
                 setfilmode(vol->ad_path( upath, ADFLAGS_HF ), ad_hf_mode(admode), NULL);
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/afpd/file.h netatalk/etc/afpd/file.h
--- netatalk.orig/etc/afpd/file.h	2005-01-30 21:56:21.000000000 +0100
+++ netatalk/etc/afpd/file.h	2006-09-19 04:24:05.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: file.h,v 1.16.2.2.2.3.2.3 2005/01/30 20:56:21 didg Exp $
+ * $Id: file.h,v 1.16.2.2.2.3.2.4 2006/09/19 02:24:05 didg Exp $
  *
  * Copyright (c) 1990,1991 Regents of The University of Michigan.
  * All Rights Reserved.
@@ -133,7 +133,7 @@
 extern int copyfile     __P((const struct vol *, const struct vol *, char *, char *, char *, struct adouble *));
 extern int deletefile   __P((const struct vol *, char *, int));
 
-extern void *get_finderinfo __P((const char *, struct adouble *, void *));
+extern void *get_finderinfo __P((const struct vol *, const char *, struct adouble *, void *));
 
 extern size_t mtoUTF8   __P((const struct vol *, const char *, size_t , char *, size_t ));
 extern int  copy_path_name __P((const struct vol *, char *, char *i));
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/afpd/fork.c netatalk/etc/afpd/fork.c
--- netatalk.orig/etc/afpd/fork.c	2004-12-07 04:23:49.000000000 +0100
+++ netatalk/etc/afpd/fork.c	2005-09-28 11:38:56.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: fork.c,v 1.51.2.2.2.10.2.2 2004/12/07 03:23:49 didg Exp $
+ * $Id: fork.c,v 1.51.2.2.2.10.2.5 2005/09/28 09:38:56 didg Exp $
  *
  * Copyright (c) 1990,1993 Regents of The University of Michigan.
  * All Rights Reserved.  See COPYRIGHT.
@@ -83,10 +83,10 @@
     vol = ofork->of_vol;
     dir = ofork->of_dir;
 
-    if (NULL == (path.u_name = mtoupath(vol, ofork->of_name, dir->d_did, utf8_encoding()))) {
+    if (NULL == (path.u_name = mtoupath(vol, of_name(ofork), dir->d_did, utf8_encoding()))) {
         return( AFPERR_MISC );
     }
-    path.m_name = ofork->of_name;
+    path.m_name = of_name(ofork);
     st = &path.st;
     if ( bitmap & ( (1<<FILPBIT_DFLEN) | (1<<FILPBIT_EXTDFLEN) | 
                     (1<<FILPBIT_FNUM) | (1 << FILPBIT_CDATE) | 
@@ -259,9 +259,9 @@
 
 /* ----------------------- */
 int afp_openfork(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
+AFPObj  *obj _U_;
 char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+int	ibuflen _U_, *rbuflen;
 {
     struct vol		*vol;
     struct dir		*dir;
@@ -536,9 +536,9 @@
 }
 
 int afp_setforkparams(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
-char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+AFPObj  *obj _U_;
+char	*ibuf, *rbuf _U_;
+int	ibuflen, *rbuflen;
 {
     struct ofork	*ofork;
     off_t		size;
@@ -630,7 +630,7 @@
             goto afp_setfork_err;
 
         if (ad_flush( ofork->of_ad, ADFLAGS_HF ) < 0) {
-            LOG(log_error, logtype_afpd, "afp_setforkparams(%s): ad_flush: %s", ofork->of_name, strerror(errno) );
+            LOG(log_error, logtype_afpd, "afp_setforkparams(%s): ad_flush: %s", of_name(ofork), strerror(errno) );
             return AFPERR_PARAM;
         }
     } else
@@ -638,7 +638,7 @@
 
 #ifdef AFS
     if ( flushfork( ofork ) < 0 ) {
-        LOG(log_error, logtype_afpd, "afp_setforkparams(%s): flushfork: %s", ofork->of_name, strerror(errno) );
+        LOG(log_error, logtype_afpd, "afp_setforkparams(%s): flushfork: %s", of_name(ofork), strerror(errno) );
     }
 #endif /* AFS */
 
@@ -676,9 +676,9 @@
 
 /* ---------------------- */
 static int byte_lock(obj, ibuf, ibuflen, rbuf, rbuflen, is64 )
-AFPObj  *obj;
+AFPObj  *obj _U_;
 char	*ibuf, *rbuf;
-int	ibuflen, *rbuflen;
+int	ibuflen _U_, *rbuflen;
 int     is64;
 {
     struct ofork	*ofork;
@@ -785,7 +785,7 @@
 
     if ( ad_hfileno( of->of_ad ) == -1 || !memcmp( ufinderi, ad_entry( of->of_ad, ADEID_FINDERI),8)) {
         /* no resource fork or no finderinfo, use our files extension mapping */
-        if (!( em = getextmap( of->of_name )) || memcmp( "TEXT", em->em_type, sizeof( em->em_type ))) {
+        if (!( em = getextmap( of_name(of) )) || memcmp( "TEXT", em->em_type, sizeof( em->em_type ))) {
             return 0;
         } 
         /* file type is TEXT */
@@ -809,7 +809,7 @@
 
     cc = ad_read(ofork->of_ad, eid, offset, rbuf, *rbuflen);
     if ( cc < 0 ) {
-        LOG(log_error, logtype_afpd, "afp_read(%s): ad_read: %s", ofork->of_name, strerror(errno) );
+        LOG(log_error, logtype_afpd, "afp_read(%s): ad_read: %s", of_name(ofork), strerror(errno) );
         *rbuflen = 0;
         return( AFPERR_PARAM );
     }
@@ -867,10 +867,10 @@
  * with dsi, should we check that reqcount < server quantum? 
 */
 static int read_fork(obj, ibuf, ibuflen, rbuf, rbuflen, is64)
-AFPObj      *obj;
+AFPObj  *obj;
 char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
-int is64;
+int	ibuflen _U_, *rbuflen;
+int     is64;
 {
     struct ofork	*ofork;
     off_t		offset, saveoff, reqcount, savereqcount;
@@ -979,7 +979,7 @@
                 if (errno == EINVAL || errno == ENOSYS)
                     goto afp_read_loop;
                 else {
-                    LOG(log_error, logtype_afpd, "afp_read(%s): ad_readfile: %s", ofork->of_name, strerror(errno));
+                    LOG(log_error, logtype_afpd, "afp_read(%s): ad_readfile: %s", of_name(ofork), strerror(errno));
                     goto afp_read_exit;
                 }
             }
@@ -1024,7 +1024,7 @@
         goto afp_read_done;
 
 afp_read_exit:
-        LOG(log_error, logtype_afpd, "afp_read(%s): %s", ofork->of_name, strerror(errno));
+        LOG(log_error, logtype_afpd, "afp_read(%s): %s", of_name(ofork), strerror(errno));
         dsi_readdone(dsi);
         ad_tmplock(ofork->of_ad, eid, ADLOCK_CLR, saveoff, savereqcount,ofork->of_refnum);
         obj->exit(EXITERR_CLNT);
@@ -1059,9 +1059,9 @@
 
 /* ---------------------- */
 int afp_flush(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
-char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+AFPObj  *obj _U_;
+char	*ibuf, *rbuf _U_;
+int	ibuflen _U_, *rbuflen;
 {
     struct vol *vol;
     u_int16_t vid;
@@ -1079,9 +1079,9 @@
 }
 
 int afp_flushfork(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
-char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+AFPObj  *obj _U_;
+char	*ibuf, *rbuf _U_;
+int	ibuflen _U_, *rbuflen;
 {
     struct ofork	*ofork;
     u_int16_t		ofrefnum;
@@ -1096,7 +1096,7 @@
     }
 
     if ( flushfork( ofork ) < 0 ) {
-        LOG(log_error, logtype_afpd, "afp_flushfork(%s): %s", ofork->of_name, strerror(errno) );
+        LOG(log_error, logtype_afpd, "afp_flushfork(%s): %s", of_name(ofork), strerror(errno) );
     }
 
     return( AFP_OK );
@@ -1113,7 +1113,7 @@
     if ( ad_dfileno( ofork->of_ad ) != -1 &&
             fsync( ad_dfileno( ofork->of_ad )) < 0 ) {
         LOG(log_error, logtype_afpd, "flushfork(%s): dfile(%d) %s",
-            ofork->of_name, ad_dfileno(ofork->of_ad), strerror(errno) );
+            of_name(ofork), ad_dfileno(ofork->of_ad), strerror(errno) );
         err = -1;
     }
 
@@ -1139,21 +1139,23 @@
 
         if (err < 0)
             LOG(log_error, logtype_afpd, "flushfork(%s): hfile(%d) %s",
-                ofork->of_name, ad_hfileno(ofork->of_ad), strerror(errno) );
+                of_name(ofork), ad_hfileno(ofork->of_ad), strerror(errno) );
     }
 
     return( err );
 }
 
 int afp_closefork(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
-char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+AFPObj      *obj _U_;
+char	*ibuf, *rbuf _U_;
+int		ibuflen _U_, *rbuflen;
 {
     struct ofork	*ofork;
     struct timeval      tv;
     int			adflags, doflush = 0;
     u_int16_t		ofrefnum;
+    int			ret;
+    
 
     *rbuflen = 0;
     ibuf += 2;
@@ -1184,14 +1186,14 @@
             }
         }
     }
-
+    ret = AFP_OK;
     if ( ad_close( ofork->of_ad, adflags ) < 0 ) {
-        LOG(log_error, logtype_afpd, "afp_closefork(%s): ad_close: %s", ofork->of_name, strerror(errno) );
-        return( AFPERR_PARAM );
+        LOG(log_error, logtype_afpd, "afp_closefork(%s): ad_close: %s", of_name(ofork), strerror(errno) );
+        ret = AFPERR_PARAM;
     }
 
     of_dealloc( ofork );
-    return( AFP_OK );
+    return ret;
 }
 
 
@@ -1223,7 +1225,7 @@
         case ENOSPC :
             return( AFPERR_DFULL );
         default :
-            LOG(log_error, logtype_afpd, "afp_write(%s): ad_write: %s", ofork->of_name, strerror(errno) );
+            LOG(log_error, logtype_afpd, "afp_write(%s): ad_write: %s", of_name(ofork), strerror(errno) );
             return( AFPERR_PARAM );
         }
     }
@@ -1238,7 +1240,7 @@
 static int write_fork(obj, ibuf, ibuflen, rbuf, rbuflen, is64)
 AFPObj              *obj;
 char                *ibuf, *rbuf;
-int                 ibuflen, *rbuflen;
+int                 ibuflen _U_, *rbuflen;
 int                 is64;
 {
     struct ofork	*ofork;
@@ -1439,9 +1441,9 @@
 
 /* ---------------------------- */
 int afp_getforkparams(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
+AFPObj  *obj _U_;
 char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+int	ibuflen _U_, *rbuflen;
 {
     struct ofork	*ofork;
     int			buflen, ret;
@@ -1465,7 +1467,7 @@
 
     if ( ad_hfileno( ofork->of_ad ) != -1 ) {
         if ( ad_refresh( ofork->of_ad ) < 0 ) {
-            LOG(log_error, logtype_afpd, "getforkparams(%s): ad_refresh: %s", ofork->of_name, strerror(errno) );
+            LOG(log_error, logtype_afpd, "getforkparams(%s): ad_refresh: %s", of_name(ofork), strerror(errno) );
             return( AFPERR_PARAM );
         }
     }
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/afpd/fork.h netatalk/etc/afpd/fork.h
--- netatalk.orig/etc/afpd/fork.h	2004-12-07 04:23:51.000000000 +0100
+++ netatalk/etc/afpd/fork.h	2005-09-28 11:38:57.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: fork.h,v 1.8.6.2.2.1 2004/12/07 03:23:51 didg Exp $
+ * $Id: fork.h,v 1.8.6.2.2.2 2005/09/28 09:38:57 didg Exp $
  *
  * Copyright (c) 1990,1993 Regents of The University of Michigan.
  * All Rights Reserved.  See COPYRIGHT.
@@ -25,8 +25,6 @@
     struct adouble	*of_ad;
     struct vol          *of_vol;
     struct dir		*of_dir;
-    char		*of_name;
-    int                 of_namelen;
 
     u_int16_t           of_refnum;
     int                 of_flags;
@@ -53,6 +51,7 @@
 #define AFPFORK_ACCWR   (1<<5)
 #define AFPFORK_ACCMASK (AFPFORK_ACCRD | AFPFORK_ACCWR)
 
+#define of_name(a) (a)->of_ad->ad_m_name
 /* in ofork.c */
 extern struct ofork *of_alloc    __P((struct vol *, struct dir *,
                                                       char *, u_int16_t *, const int,
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/afpd/main.c netatalk/etc/afpd/main.c
--- netatalk.orig/etc/afpd/main.c	2004-05-12 23:21:48.000000000 +0200
+++ netatalk/etc/afpd/main.c	2006-08-01 10:42:45.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: main.c,v 1.20.4.2.2.9 2004/05/12 21:21:48 didg Exp $
+ * $Id: main.c,v 1.20.4.2.2.9.2.1 2006/08/01 08:42:45 didg Exp $
  *
  * Copyright (c) 1990,1993 Regents of The University of Michigan.
  * All Rights Reserved.  See COPYRIGHT.
@@ -279,7 +279,7 @@
 
     sigprocmask(SIG_BLOCK, &sigs, NULL);
     if (!(configs = configinit(&default_options))) {
-        LOG(log_error, logtype_afpd, "main: no servers configured: %s", strerror(errno));
+        LOG(log_error, logtype_afpd, "main: no servers configured");
         afp_exit(EXITERR_CONF);
     }
     sigprocmask(SIG_UNBLOCK, &sigs, NULL);
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/afpd/Makefile.am netatalk/etc/afpd/Makefile.am
--- netatalk.orig/etc/afpd/Makefile.am	2004-08-11 04:39:56.000000000 +0200
+++ netatalk/etc/afpd/Makefile.am	2006-09-07 05:45:54.000000000 +0200
@@ -17,7 +17,7 @@
 	 filedir.h fork.h globals.h icon.h mangle.h misc.h status.h switch.h \
 	 uam_auth.h uid.h unix.h volume.h
 
-LIBS = @LIBS@ @PAM_LIBS@ @QUOTA_LIBS@ @SLP_LIBS@ @WRAP_LIBS@
+LIBS = @LIBS@ @QUOTA_LIBS@ @SLP_LIBS@ @WRAP_LIBS@ @LIBADD_DL@
 
 CFLAGS = -I$(top_srcdir)/include -I$(top_srcdir)/sys \
 	 @CFLAGS@ @SLP_CFLAGS@ \
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/afpd/mangle.c netatalk/etc/afpd/mangle.c
--- netatalk.orig/etc/afpd/mangle.c	2005-02-14 17:01:54.000000000 +0100
+++ netatalk/etc/afpd/mangle.c	2006-09-19 02:08:01.000000000 +0200
@@ -1,5 +1,5 @@
 /* 
- * $Id: mangle.c,v 1.16.2.1.2.12.2.3 2005/02/14 16:01:54 didg Exp $ 
+ * $Id: mangle.c,v 1.16.2.1.2.12.2.6 2006/09/19 00:08:01 didg Exp $ 
  *
  * Copyright (c) 2002. Joe Marcus Clarke (marcus@marcuscom.com)
  * All Rights Reserved.  See COPYRIGHT.
@@ -25,7 +25,7 @@
 static char *demangle_checks ( const struct vol *vol, char* uname, char * mfilename, size_t prefix, char * ext)
 {
     u_int16_t flags;
-    static char buffer[MAXPATHLEN +1];
+    static char buffer[MAXPATHLEN +2];  /* for convert_charset dest_len parameter +2 */
     size_t len;
     size_t mfilenamelen;
     char *u;
@@ -206,10 +206,10 @@
 /* -------------------------------------------------------
  * find the start of a utf8 character
  */
-static unsigned char *
-utf8_mangle_validate(unsigned char *path, size_t len)
+static char *
+utf8_mangle_validate(char *path, size_t len)
 {
-    unsigned char *p = path + len;
+    unsigned char *p = (unsigned char *)path + len;
     int           dec = 0;
 
     /* char matches with 10xxxxxx ? */
@@ -231,12 +231,12 @@
    id         file/folder ID or 0
    
 */
-unsigned char *
-mangle(const struct vol *vol, unsigned char *filename, size_t filenamelen, unsigned char *uname, cnid_t id, int flags) {
-    unsigned char *ext = NULL;
-    unsigned char *m = NULL;
-    static unsigned char mfilename[MAXPATHLEN + 1];
-    unsigned char mangle_suffix[MANGLE_LENGTH + 1];
+char *
+mangle(const struct vol *vol _U_, char *filename, size_t filenamelen, char *uname, cnid_t id, int flags) {
+    char *ext = NULL;
+    char *m = NULL;
+    static char mfilename[MAXPATHLEN + 1];
+    char mangle_suffix[MANGLE_LENGTH + 1];
     size_t ext_len = 0;
     size_t maxlen;
     int k;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/afpd/mangle.h netatalk/etc/afpd/mangle.h
--- netatalk.orig/etc/afpd/mangle.h	2005-01-31 20:50:37.000000000 +0100
+++ netatalk/etc/afpd/mangle.h	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: mangle.h,v 1.4.2.1.2.3.2.1 2005/01/31 19:50:37 didg Exp $
+ * $Id: mangle.h,v 1.4.2.1.2.3.2.2 2005/09/27 10:40:41 didg Exp $
  *
  */
 
@@ -24,7 +24,7 @@
 #define MANGLE_LENGTH  9 /* #ffffffff This really can't be changed. */
 #define MAX_LENGTH MACFILELEN 
 
-extern unsigned char *mangle __P((const struct vol *, unsigned char *, size_t, unsigned char *, cnid_t, int));
+extern char *mangle __P((const struct vol *, char *, size_t, char *, cnid_t, int));
 extern char *demangle __P((const struct vol *, char *, cnid_t did));
 extern char *demangle_osx __P((const struct vol *, char *, cnid_t did, cnid_t *fileid));
 
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/afpd/messages.c netatalk/etc/afpd/messages.c
--- netatalk.orig/etc/afpd/messages.c	2004-02-14 01:30:50.000000000 +0100
+++ netatalk/etc/afpd/messages.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: messages.c,v 1.16.6.1.2.7 2004/02/14 00:30:50 didg Exp $
+ * $Id: messages.c,v 1.16.6.1.2.7.2.1 2005/09/27 10:40:41 didg Exp $
  *
  * Copyright (c) 1997 Adrian Sun (asun@zoology.washington.edu)
  * All Rights Reserved.  See COPYRIGHT.
@@ -116,7 +116,7 @@
 int afp_getsrvrmesg(obj, ibuf, ibuflen, rbuf, rbuflen)
 AFPObj *obj;
 char *ibuf, *rbuf;
-int ibuflen, *rbuflen;
+int ibuflen _U_, *rbuflen;
 {
     char *message;
     u_int16_t type, bitmap;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/afpd/ofork.c netatalk/etc/afpd/ofork.c
--- netatalk.orig/etc/afpd/ofork.c	2005-02-10 02:23:15.000000000 +0100
+++ netatalk/etc/afpd/ofork.c	2005-09-28 11:38:57.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: ofork.c,v 1.20.6.6.2.2 2005/02/10 01:23:15 didg Exp $
+ * $Id: ofork.c,v 1.20.6.6.2.5 2005/09/28 09:38:57 didg Exp $
  *
  * Copyright (c) 1996 Regents of The University of Michigan.
  * All Rights Reserved.  See COPYRIGHT.
@@ -80,7 +80,7 @@
 
     for ( ofrefnum = 0; ofrefnum < nforks; ofrefnum++ ) {
         if ( oforks[ ofrefnum ] != NULL ) {
-            fprintf( f, "%hu <%s>\n", ofrefnum, oforks[ ofrefnum ]->of_name);
+            fprintf( f, "%hu <%s>\n", ofrefnum, of_name(oforks[ ofrefnum ]);
         }
     }
 }
@@ -106,9 +106,10 @@
 const struct vol *vol;
 struct ofork *s_of;
 struct dir *olddir, *newdir;
-const char *oldpath, *newpath;
+const char *oldpath _U_, *newpath;
 {
     struct ofork *of, *next, *d_ofork;
+    int done = 0;
 
     if (!s_of)
         return AFP_OK;
@@ -120,7 +121,10 @@
         if (vol == of->of_vol && olddir == of->of_dir &&
 	         s_of->key.dev == of->key.dev && 
 	         s_of->key.inode == of->key.inode ) {
-            strlcpy( of->of_name, newpath, of->of_namelen);
+	    if (!done) {
+	        strlcpy( of_name(of), newpath, of->of_ad->ad_m_namelen);
+	        done = 1;
+	    }
             if (newdir != olddir) {
                 of->of_d_prev->of_d_next = of->of_d_next;
                 of->of_d_next->of_d_prev = of->of_d_prev;
@@ -162,7 +166,7 @@
     int			i;
 
     if (!oforks) {
-        nforks = (getdtablesize() - 10) / 2;
+        nforks = getdtablesize() - 10;
 	/* protect against insane ulimit -n */
         nforks = min(nforks, 0xffff);
         oforks = (struct ofork **) calloc(nforks, sizeof(struct ofork *));
@@ -215,12 +219,27 @@
         ad = malloc( sizeof( struct adouble ) );
         if (!ad) {
             LOG(log_error, logtype_afpd, "of_alloc: malloc: %s", strerror(errno) );
+            free(of);
+            oforks[ of_refnum ] = NULL;
             return NULL;
         }
 
         /* initialize to zero. This is important to ensure that
            ad_open really does reinitialize the structure. */
         ad_init(ad, vol->v_adouble, vol->v_ad_options);
+
+        ad->ad_m_namelen = 255 +1;
+        /* here's the deal: we allocate enough for the standard mac file length.
+         * in the future, we'll reallocate in fairly large jumps in case
+         * of long unicode names */
+        if (( ad->ad_m_name =(char *)malloc( ad->ad_m_namelen )) == NULL ) {
+            LOG(log_error, logtype_afpd, "of_alloc: malloc: %s", strerror(errno) );
+            free(ad);
+            free(of);
+            oforks[ of_refnum ] = NULL;
+            return NULL;
+        }
+        strlcpy( ad->ad_m_name, path, ad->ad_m_namelen);
     } else {
         /* Increase the refcount on this struct adouble. This is
            decremented again in oforc_dealloc. */
@@ -228,7 +247,6 @@
     }
 
     of->of_ad = ad;
-
     of->of_vol = vol;
     of->of_dir = dir;
 
@@ -242,18 +260,6 @@
         d_ofork->of_d_prev = of;
     }
 
-    /* here's the deal: we allocate enough for the standard mac file length.
-     * in the future, we'll reallocate in fairly large jumps in case
-     * of long unicode names */
-    if (( of->of_name =(char *)malloc(255 + 1)) == NULL ) {
-        LOG(log_error, logtype_afpd, "of_alloc: malloc: %s", strerror(errno) );
-        if (!ad)
-            free(of->of_ad);
-        free(of);
-        oforks[ of_refnum ] = NULL;
-        return NULL;
-    }
-    strlcpy( of->of_name, path, of->of_namelen = 255 + 1);
     *ofrefnum = refnum;
     of->of_refnum = refnum;
     of->key.dev = st->st_dev;
@@ -359,12 +365,12 @@
     }
 
     oforks[ of->of_refnum % nforks ] = NULL;
-    free( of->of_name );
 
     /* decrease refcount */
     of->of_ad->ad_refcount--;
 
     if ( of->of_ad->ad_refcount <= 0) {
+        free( of->of_ad->ad_m_name );
         free( of->of_ad);
     } else {/* someone's still using it. just free this user's locks */
         ad_unlock(of->of_ad, of->of_refnum);
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/afpd/quota.c netatalk/etc/afpd/quota.c
--- netatalk.orig/etc/afpd/quota.c	2005-01-31 18:01:00.000000000 +0100
+++ netatalk/etc/afpd/quota.c	2006-09-11 10:05:02.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: quota.c,v 1.22.8.11.2.1 2005/01/31 17:01:00 didg Exp $
+ * $Id: quota.c,v 1.22.8.11.2.3 2006/09/11 08:05:02 didg Exp $
  *
  * Copyright (c) 1990,1993 Regents of The University of Michigan.
  * All Rights Reserved.  See COPYRIGHT.
@@ -46,7 +46,9 @@
 #include "volume.h"
 #include "unix.h"
 
+/* if you want to debug quota
 #define DEBUG_QUOTA 0
+*/
 #define WANT_USER_QUOTA 0
 #define WANT_GROUP_QUOTA 1
 
@@ -67,6 +69,11 @@
 #ifdef HAVE_XFS_XQM_H
 #include <xfs/xqm.h>
 #define HAVE_LINUX_XQM_H
+#else
+#ifdef  HAVE_LINUX_DQBLK_XFS_H
+#include <linux/dqblk_xfs.h>
+#define HAVE_LINUX_XQM_H
+#endif /* HAVE_LINUX_DQBLK_XFS_H */
 #endif /* HAVE_XFS_XQM_H */
 #endif /* HAVE_LINUX_XQM_H */
 
@@ -712,7 +719,7 @@
 	this_bsize = dqblk.bsize;
 #endif
 
-#if DEBUG_QUOTA
+#ifdef DEBUG_QUOTA
         LOG(log_info, logtype_afpd, "after calling getquota in uquota_getvolspace!" );
         LOG(log_info, logtype_afpd, "dqb_ihardlimit: %u", dqblk.dqb_ihardlimit );
         LOG(log_info, logtype_afpd, "dqb_isoftlimit: %u", dqblk.dqb_isoftlimit );
@@ -747,7 +754,7 @@
                  	  tobytes( dqblk.dqb_curblocks, this_bsize );
     	}
 
-#if DEBUG_QUOTA
+#ifdef DEBUG_QUOTA
         LOG(log_info, logtype_afpd, "bfree          : %u", *bfree );
         LOG(log_info, logtype_afpd, "btotal         : %u", *btotal );
         LOG(log_info, logtype_afpd, "bfree          : %uKB", *bfree/1024 );
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/afpd/status.c netatalk/etc/afpd/status.c
--- netatalk.orig/etc/afpd/status.c	2005-01-31 20:50:38.000000000 +0100
+++ netatalk/etc/afpd/status.c	2006-09-18 02:23:58.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: status.c,v 1.13.6.11.2.1 2005/01/31 19:50:38 didg Exp $
+ * $Id: status.c,v 1.13.6.11.2.3 2006/09/18 00:23:58 didg Exp $
  *
  * Copyright (c) 1990,1993 Regents of The University of Michigan.
  * All Rights Reserved.  See COPYRIGHT.
@@ -36,10 +36,10 @@
 #include "afp_config.h"
 #include "icon.h"
 
-static   int maxstatuslen = 0;
+static   size_t maxstatuslen = 0;
 
 static void status_flags(char *data, const int notif, const int ipok,
-                         const unsigned char passwdbits, const int dirsrvcs)
+                         const unsigned char passwdbits, const int dirsrvcs _U_)
 {
     u_int16_t           status;
 
@@ -85,7 +85,7 @@
     nbp_name(server, &Obj, &Type, &Zone);
     if ((size_t)-1 == (len = convert_string( 
 			options->unixcharset, options->maccharset, 
-			Obj, strlen(Obj), buf, 31)) ) {
+			Obj, strlen(Obj), buf, sizeof(buf))) ) {
 	len = MIN(strlen(Obj), 31);
     	*data++ = len;
     	memcpy( data, Obj, len );
@@ -228,7 +228,7 @@
     return sigoff;
 }
 
-static int status_netaddress(char *data, int *servoffset,
+static size_t status_netaddress(char *data, int *servoffset,
                              const ASP asp, const DSI *dsi,
                              const struct afp_options *options)
 {
@@ -282,7 +282,7 @@
 
     /* handle DNS names */
     if (options->fqdn && dsi) {
-        int len = strlen(options->fqdn);
+        size_t len = strlen(options->fqdn);
         if ( len + 2 + addresses_len < maxstatuslen - offset) {
             *data++ = len +2;
             *data++ = 0x04;
@@ -333,8 +333,8 @@
     return (data - begin);
 }
 
-static int status_directorynames(char *data, int *diroffset, 
-				 const DSI *dsi, 
+static size_t status_directorynames(char *data, int *diroffset, 
+				 const DSI *dsi _U_, 
 				 const struct afp_options *options)
 {
     char *begin = data;
@@ -352,7 +352,7 @@
      */
     if (options->k5service && options->k5realm && options->fqdn) {
 	/* should k5princ be utf8 encoded? */
-	u_int8_t len;
+	size_t len;
 	char *p = strchr( options->fqdn, ':' );
 	if (p) 
 	    *p = '\0';
@@ -360,7 +360,7 @@
 			+ strlen( options->fqdn )
 			+ strlen( options->k5realm );
 	len+=2; /* '/' and '@' */
-	if ( len+2 > maxstatuslen - offset) {
+	if ( len > 255 || len+2 > maxstatuslen - offset) {
 	    *data++ = 0;
 	    LOG ( log_error, logtype_afpd, "status: could not set directory service list, no more room");
 	}	 
@@ -386,8 +386,8 @@
     return (data - begin);
 }
 
-static int status_utf8servername(char *data, int *nameoffset,
-				 const DSI *dsi,
+static size_t status_utf8servername(char *data, int *nameoffset,
+				 const DSI *dsi _U_,
 				 const struct afp_options *options)
 {
     char *Obj, *Type, *Zone;
@@ -481,8 +481,9 @@
 {
     ASP asp;
     DSI *dsi;
-    u_int8_t *status = NULL;
-    int statuslen, c, sigoff;
+    char *status = NULL;
+    size_t statuslen;
+    int c, sigoff;
 
     if (!(aspconfig || dsiconfig) || !options)
         return;
@@ -570,9 +571,9 @@
 
 /* this is the same as asp/dsi_getstatus */
 int afp_getsrvrinfo(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
-char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+AFPObj  *obj;
+char	*ibuf _U_, *rbuf;
+int	ibuflen _U_, *rbuflen;
 {
     AFPConfig *config = obj->config;
 
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/afpd/switch.c netatalk/etc/afpd/switch.c
--- netatalk.orig/etc/afpd/switch.c	2002-11-15 11:59:11.000000000 +0100
+++ netatalk/etc/afpd/switch.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: switch.c,v 1.12 2002/11/15 10:59:11 srittau Exp $
+ * $Id: switch.c,v 1.12.8.1 2005/09/27 10:40:41 didg Exp $
  *
  * Copyright (c) 1990,1991 Regents of The University of Michigan.
  * All Rights Reserved.
@@ -48,9 +48,9 @@
 #include "misc.h"
 
 static int afp_null(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
-char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+AFPObj  *obj _U_;
+char	*ibuf, *rbuf _U_;
+int	ibuflen _U_, *rbuflen;
 {
     LOG(log_info, logtype_afpd, "afp_null handle %d", *ibuf );
     *rbuflen = 0;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/afpd/uam.c netatalk/etc/afpd/uam.c
--- netatalk.orig/etc/afpd/uam.c	2005-02-01 12:33:48.000000000 +0100
+++ netatalk/etc/afpd/uam.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: uam.c,v 1.24.6.7.2.3 2005/02/01 11:33:48 didg Exp $
+ * $Id: uam.c,v 1.24.6.7.2.4 2005/09/27 10:40:41 didg Exp $
  *
  * Copyright (c) 1999 Adrian Sun (asun@zoology.washington.edu)
  * All Rights Reserved.  See COPYRIGHT.
@@ -622,7 +622,7 @@
 #endif /* TRU64 */
 
 /* --- papd-specific functions (just placeholders) --- */
-void append(void *pf, char *data, int len)
+void append(void *pf  _U_, char *data _U_, int len _U_)
 {
     return;
 }
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/afpd/unix.c netatalk/etc/afpd/unix.c
--- netatalk.orig/etc/afpd/unix.c	2004-06-16 00:53:55.000000000 +0200
+++ netatalk/etc/afpd/unix.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: unix.c,v 1.43.2.1.2.10 2004/06/15 22:53:55 didg Exp $
+ * $Id: unix.c,v 1.43.2.1.2.10.2.3 2005/09/27 10:40:41 didg Exp $
  *
  * Copyright (c) 1990,1993 Regents of The University of Michigan.
  * All Rights Reserved.  See COPYRIGHT.
@@ -170,11 +170,13 @@
  * Note: the previous method, using access(), does not work correctly
  * over NFS.
  * FIXME what about ACL?
+ *
+ * dir parameter is used by AFS
  */
 void accessmode( path, ma, dir, st )
 char		*path;
 struct maccess	*ma;
-struct dir	*dir;
+struct dir	*dir _U_;
 struct stat     *st;
 
 {
@@ -402,6 +404,8 @@
         return -1;
     }
         
+    mode |= vol->v_perm;
+
     if (setfilmode( path->u_name, mode, &path->st) < 0)
         return -1;
     /* we need to set write perm if read set for resource fork */
@@ -415,14 +419,14 @@
 struct stat *st;
 {
 struct stat sb;
-mode_t mask = S_IRUSR |S_IWUSR | S_IRGRP | S_IWGRP |S_IROTH | S_IWOTH;
+mode_t mask = S_IRWXU | S_IRWXG | S_IRWXO;  /* rwx for owner group and other, by default */
 
     if (!st) {
         if (stat(name, &sb) != 0)
             return -1;
         st = &sb;
     }
-   mode &= mask;	/* keep only rw-rw-rw in mode */
+   
    mode |= st->st_mode & ~mask; /* keep other bits from previous mode */
    if ( chmod( name,  mode & ~default_options.umask ) < 0 && errno != EPERM ) {
        return -1;
@@ -434,11 +438,12 @@
 int setdirunixmode( vol, name, mode )
 const struct vol *vol;
 const char       *name;
-const mode_t     mode;
+mode_t           mode;
 {
 char *adouble = vol->ad_path( name, ADFLAGS_DIR );
 
     int dropbox = (vol->v_flags & AFPVOL_DROPBOX);
+    mode |= vol->v_perm;
 
     if (dir_rx_set(mode)) {
     	/* extending right? dir first then .AppleDouble */
@@ -469,19 +474,22 @@
 int setdirmode( vol, name, mode )
 const struct vol *vol;
 const char       *name;
-const mode_t mode;
+mode_t           mode;
 {
     char		buf[ MAXPATHLEN + 1];
     struct stat		st;
     char		*m;
     struct dirent	*dirp;
     DIR			*dir;
+    mode_t              hf_mode;
     int                 osx = vol->v_adouble == AD_VERSION2_OSX;
-    int                 hf_mode = ad_hf_mode(mode);
     int                 dropbox = (vol->v_flags & AFPVOL_DROPBOX);
     char                *adouble = vol->ad_path( name, ADFLAGS_DIR );
     char                *adouble_p = ad_dir(adouble);
     
+    mode |= vol->v_perm;
+    hf_mode = ad_hf_mode(mode);
+
     if (dir_rx_set(mode)) {
     	/* extending right? dir first then .AppleDouble */
     	if ( stickydirmode(name, DIRBITS | mode, dropbox) < 0 )
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/afpd/unix.h netatalk/etc/afpd/unix.h
--- netatalk.orig/etc/afpd/unix.h	2005-01-31 18:01:00.000000000 +0100
+++ netatalk/etc/afpd/unix.h	2005-06-02 14:49:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: unix.h,v 1.12.2.1.2.6.2.1 2005/01/31 17:01:00 didg Exp $
+ * $Id: unix.h,v 1.12.2.1.2.6.2.3 2005/06/02 12:49:41 didg Exp $
  */
 
 #ifndef AFPD_UNIX_H
@@ -32,7 +32,7 @@
 #define f_frsize f_fsize
 #else /* TRU64 */
 /* temp fix, was: defined(HAVE_SYS_STATVFS) || defined(__svr4__) */
-#if defined(__svr4__)
+#if defined(__svr4__) || (defined(__NetBSD__) && (__NetBSD_Version__ >= 200040000))
 #include <sys/statvfs.h>
 #define statfs statvfs
 #else /* HAVE_SYS_STATVFS || __svr4__ */
@@ -217,8 +217,8 @@
 
 extern int gmem            __P((const gid_t));
 extern int setdeskmode      __P((const mode_t));
-extern int setdirunixmode   __P((const struct vol *, const char *, const mode_t));
-extern int setdirmode       __P((const struct vol *, const char *, const mode_t));
+extern int setdirunixmode   __P((const struct vol *, const char *, mode_t));
+extern int setdirmode       __P((const struct vol *, const char *, mode_t));
 extern int setdeskowner     __P((const uid_t, const gid_t));
 extern int setdirowner      __P((const struct vol *, const char *, const uid_t, const gid_t));
 extern int setfilmode       __P((char *, mode_t , struct stat *));
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/afpd/volume.c netatalk/etc/afpd/volume.c
--- netatalk.orig/etc/afpd/volume.c	2005-04-25 00:26:31.000000000 +0200
+++ netatalk/etc/afpd/volume.c	2007-04-11 02:21:23.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: volume.c,v 1.51.2.7.2.33.2.5 2005/04/24 22:26:31 didg Exp $
+ * $Id: volume.c,v 1.51.2.7.2.33.2.14 2007/04/11 00:21:23 didg Exp $
  *
  * Copyright (c) 1990,1993 Regents of The University of Michigan.
  * All Rights Reserved.  See COPYRIGHT.
@@ -115,11 +115,13 @@
 #define VOLOPT_FORCEUID  19  /* force uid for username x */
 #define VOLOPT_FORCEGID  20  /* force gid for group x */
 #define VOLOPT_UMASK     21
+#define VOLOPT_DFLTPERM  22
 #else 
 #define VOLOPT_UMASK     19
+#define VOLOPT_DFLTPERM  20
 #endif /* FORCE_UIDGID */
 
-#define VOLOPT_MAX       (VOLOPT_UMASK +1)
+#define VOLOPT_MAX       (VOLOPT_DFLTPERM +1)
 
 #define VOLOPT_NUM        (VOLOPT_MAX + 1)
 
@@ -169,6 +171,7 @@
                                          * maybe because it will be mounted later in preexec */
     {AFPVOL_UNIX_PRIV,  "UNIXPRIV"},    /* support unix privileges */
     {AFPVOL_NODEV,      "NODEV"},       /* always use 0 for device number in cnid calls */
+    {AFPVOL_CACHE,      "CACHEID"},     /* Use adouble v2 CNID caching, default don't use it */
     {0, NULL}
 };
 
@@ -242,7 +245,7 @@
         return ret;
 
     /* first part of the path. just forward to the next variable. */
-    len = MIN(p - src, destlen);
+    len = MIN((size_t)(p - src), destlen);
     if (len > 0) {
         destlen -= len;
         dest += len;
@@ -338,7 +341,7 @@
         /* stuff up to next $ */
         src = p + 2;
         p = strchr(src, '$');
-        len = p ? MIN(p - src, destlen) : destlen;
+        len = p ? MIN((size_t)(p - src), destlen) : destlen;
         if (len > 0) {
             strncpy(dest, src, len);
             dest += len;
@@ -449,6 +452,8 @@
                 options[VOLOPT_FLAGS].i_value |= AFPVOL_NOHEX;
             else if (strcasecmp(p, "usedots") == 0)
                 options[VOLOPT_FLAGS].i_value |= AFPVOL_USEDOTS;
+            else if (strcasecmp(p, "invisibledots") == 0)
+                options[VOLOPT_FLAGS].i_value |= AFPVOL_USEDOTS | AFPVOL_INV_DOTS;
             else if (strcasecmp(p, "limitsize") == 0)
                 options[VOLOPT_FLAGS].i_value |= AFPVOL_LIMITSIZE;
             /* support for either "dropbox" or "dropkludge" */
@@ -478,7 +483,9 @@
         setoption(options, save, VOLOPT_DBPATH, val);
 
     } else if (optionok(tmp, "umask:", val)) {
-	options[VOLOPT_UMASK].i_value = (int)strtol(val, (char **)NULL, 8);
+	options[VOLOPT_UMASK].i_value = (int)strtol(val +1, NULL, 8);
+    } else if (optionok(tmp, "perm:", val)) {
+        options[VOLOPT_DFLTPERM].i_value = (int)strtol(val+1, NULL, 8);
     } else if (optionok(tmp, "mapchars:",val)) {
         setoption(options, save, VOLOPT_MAPCHARS, val);
 
@@ -530,12 +537,16 @@
 */
 static int validupath_adouble(const struct vol *vol, const char *name) 
 {
-    return (vol->v_flags & AFPVOL_USEDOTS) ? strncasecmp(name,".Apple", 6) && strcasecmp(name, ".Parent")
+    return (vol->v_flags & AFPVOL_USEDOTS) ? 
+        strcasecmp(name,".AppleDB") &&
+        strcasecmp(name,".AppleDouble") &&
+        strcasecmp(name,".AppleDesktop") &&
+        strcasecmp(name,".Parent")
                                            : name[0] != '.';
 }                                           
 
 /* ----------------- */
-static int validupath_osx(const struct vol *vol, const char *name) 
+static int validupath_osx(const struct vol *vol _U_, const char *name) 
 {
     return strncasecmp(name,".Apple", 6) && strncasecmp(name,"._", 2);
 }             
@@ -635,7 +646,11 @@
             volume->v_ad_options |= ADVOL_NODEV;
         if ((volume->v_flags & AFPVOL_CACHE))
             volume->v_ad_options |= ADVOL_CACHE;
-        
+        if ((volume->v_flags & AFPVOL_UNIX_PRIV))
+            volume->v_ad_options |= ADVOL_UNIXPRIV;
+        if ((volume->v_flags & AFPVOL_INV_DOTS))
+            volume->v_ad_options |= ADVOL_INVDOTS;
+
         if (options[VOLOPT_PASSWORD].c_value)
             volume->v_password = strdup(options[VOLOPT_PASSWORD].c_value);
 
@@ -657,6 +672,9 @@
 	if (options[VOLOPT_UMASK].i_value)
 	    volume->v_umask = (mode_t)options[VOLOPT_UMASK].i_value;
 
+	if (options[VOLOPT_DFLTPERM].i_value)
+	    volume->v_perm = (mode_t)options[VOLOPT_DFLTPERM].i_value;
+
 	if (options[VOLOPT_ADOUBLE].i_value)
 	    volume->v_adouble = options[VOLOPT_ADOUBLE].i_value;
 	else 
@@ -1398,7 +1416,8 @@
     if ( nameoff ) {
         ashort = htons( data - buf );
         memcpy(nameoff, &ashort, sizeof( ashort ));
-	aint = ucs2_to_charset( (utf8_encoding()?CH_UTF8_MAC:vol->v_maccharset), vol->v_name, data+1, 255);
+        /* name is always in mac charset, FIXME mangle if length > 27 char */
+	aint = ucs2_to_charset( vol->v_maccharset, vol->v_name, data+1, 255);
 	if ( aint <= 0 ) {
 	    *buflen = 0;
             return AFPERR_MISC;
@@ -1499,8 +1518,8 @@
 /* ------------------------------- */
 int afp_getsrvrparms(obj, ibuf, ibuflen, rbuf, rbuflen )
 AFPObj      *obj;
-char	*ibuf, *rbuf;
-int 	ibuflen, *rbuflen;
+char	*ibuf _U_, *rbuf;
+int 	ibuflen _U_, *rbuflen;
 {
     struct timeval	tv;
     struct stat		st;
@@ -1515,6 +1534,8 @@
     data = rbuf + 5;
     for ( vcnt = 0, volume = Volumes; volume; volume = volume->v_next ) {
         if (!(volume->v_flags & AFPVOL_NOSTAT)) {
+            struct maccess ma;
+
             if ( stat( volume->v_path, &st ) < 0 ) {
                 LOG(log_info, logtype_afpd, "afp_getsrvrparms(%s): stat: %s",
                         volume->v_path, strerror(errno) );
@@ -1523,6 +1544,10 @@
             if (!S_ISDIR(st.st_mode)) {
                 continue;		/* not a dir */
             }
+            accessmode(volume->v_path, &ma, NULL, &st);
+            if ((ma.ma_user & (AR_UREAD | AR_USEARCH)) != (AR_UREAD | AR_USEARCH)) {
+                continue;   /* no r-x access */
+            }
         }
         if (volume->v_hide) {
             continue;		/* config file changed but the volume was mounted */
@@ -1570,7 +1595,7 @@
 int afp_openvol(obj, ibuf, ibuflen, rbuf, rbuflen )
 AFPObj      *obj;
 char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+int		ibuflen _U_, *rbuflen;
 {
     struct stat	st;
     char	*volname;
@@ -1841,9 +1866,9 @@
 
 /* ------------------------- */
 int afp_closevol(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
-char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+AFPObj      *obj _U_;
+char	*ibuf, *rbuf _U_;
+int		ibuflen _U_, *rbuflen;
 {
     struct vol	*vol, *ovol;
     u_int16_t	vid;
@@ -1996,9 +2021,9 @@
 
 /* ------------------------- */
 int afp_getvolparams(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
+AFPObj      *obj _U_;
 char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+int		ibuflen _U_, *rbuflen;
 {
     struct vol	*vol;
     u_int16_t	vid, bitmap;
@@ -2019,9 +2044,9 @@
 
 /* ------------------------- */
 int afp_setvolparams(obj, ibuf, ibuflen, rbuf, rbuflen )
-AFPObj      *obj;
-char	*ibuf, *rbuf;
-int		ibuflen, *rbuflen;
+AFPObj      *obj _U_;
+char	*ibuf, *rbuf _U_;
+int		ibuflen _U_, *rbuflen;
 {
     struct adouble ad;
     struct vol	*vol;
@@ -2162,14 +2187,14 @@
 		ad_getattr(&ad, &attr);
 		attr |= htons( ntohs( attr ) | ATTRBIT_INVISIBLE );
 		ad_setattr(&ad, attr);
-#if 0		
+
 		/* do the same with the finder info */
 		if (ad_entry(&ad, ADEID_FINDERI)) {
 			memcpy(&attr, ad_entry(&ad, ADEID_FINDERI) + FINDERINFO_FRFLAGOFF, sizeof(attr));
 			attr   |= htons(FINDERINFO_INVISIBLE);
 			memcpy(ad_entry(&ad, ADEID_FINDERI) + FINDERINFO_FRFLAGOFF,&attr, sizeof(attr));
 		}
-#endif    
+
         	ad_flush( &ad, ADFLAGS_HF );
         	ad_close( &ad, ADFLAGS_HF );
 	}
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/afpd/volume.h netatalk/etc/afpd/volume.h
--- netatalk.orig/etc/afpd/volume.h	2005-02-10 02:23:16.000000000 +0100
+++ netatalk/etc/afpd/volume.h	2006-09-19 04:24:06.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: volume.h,v 1.19.2.5.2.7.2.1 2005/02/10 01:23:16 didg Exp $
+ * $Id: volume.h,v 1.19.2.5.2.7.2.3 2006/09/19 02:24:06 didg Exp $
  *
  * Copyright (c) 1990,1994 Regents of The University of Michigan.
  * All Rights Reserved.  See COPYRIGHT.
@@ -48,6 +48,7 @@
     struct _cnid_db     *v_cdb;
     char                v_stamp[ADEDLEN_PRIVSYN];
     mode_t		v_umask;
+    mode_t		v_perm;             /* default permission value OR with requested perm*/
 
 #ifdef FORCE_UIDGID
     char		*v_forceuid;
@@ -87,8 +88,8 @@
 #endif /* NO_LARGE_VOL_SUPPORT */
 
 #define AFPVOL_OPEN	(1<<0)
-#define AFPVOL_DT	(1<<1)
 
+/* flags  for AFS and quota 0xxx0 */
 #define AFPVOL_GVSMASK	(7<<2)
 #define AFPVOL_NONE	(0<<2)
 #define AFPVOL_AFSGVS	(1<<2)
@@ -116,6 +117,7 @@
                                      * NOTE symlink to a different device will return an ACCESS error
                                      */
 #define AFPVOL_CACHE      (1 << 19)  /* Use adouble v2 CNID caching, default don't use it */
+#define AFPVOL_INV_DOTS   (1 << 20)  /* dots files are invisible */
 
 /* FPGetSrvrParms options */
 #define AFPSRVR_CONFIGINFO     (1 << 0)
@@ -177,6 +179,8 @@
 
 #define vol_unix_priv(vol) (afp_version >= 30 && ((vol)->v_flags & AFPVOL_UNIX_PRIV))
 
+#define vol_inv_dots(vol) (((vol)->v_flags & AFPVOL_INV_DOTS) ? 1 : 0)
+
 extern struct vol	*getvolbyvid __P((const u_int16_t));
 extern int              ustatfs_getvolspace __P((const struct vol *,
             VolSpace *, VolSpace *,
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/atalkd/atserv.h netatalk/etc/atalkd/atserv.h
--- netatalk.orig/etc/atalkd/atserv.h	2001-06-25 22:13:45.000000000 +0200
+++ netatalk/etc/atalkd/atserv.h	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: atserv.h,v 1.2 2001/06/25 20:13:45 rufustfirefly Exp $
+ * $Id: atserv.h,v 1.2.16.1 2005/09/27 10:40:41 didg Exp $
  *
  * Copyright (c) 1990,1992 Regents of The University of Michigan.
  * All Rights Reserved. See COPYRIGHT.
@@ -19,5 +19,3 @@
     int			(*ap_packet)();
 };
 
-extern struct atserv	atserv[];
-extern int		atservNATSERV;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/atalkd/config.c netatalk/etc/atalkd/config.c
--- netatalk.orig/etc/atalkd/config.c	2005-02-06 11:16:02.000000000 +0100
+++ netatalk/etc/atalkd/config.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: config.c,v 1.13.6.5.2.3 2005/02/06 10:16:02 didg Exp $
+ * $Id: config.c,v 1.13.6.5.2.4 2005/09/27 10:40:41 didg Exp $
  *
  * Copyright (c) 1990,1993 Regents of The University of Michigan.
  * All Rights Reserved. See COPYRIGHT.
@@ -476,7 +476,7 @@
 
 int noallmulti( iface, av )
     struct interface	*iface;
-    char		**av;
+    char		**av _U_;
 {
     /* Linux specific, no effect on other platforms */
     iface->i_flags &= !IFACE_ALLMULTI;
@@ -487,7 +487,7 @@
 /*ARGSUSED*/
 int router( iface, av )
     struct interface	*iface;
-    char		**av;
+    char		**av _U_;
 {
     /* make sure "-router" and "-dontroute" aren't both on the same line. */
     if (iface->i_flags & IFACE_DONTROUTE) {
@@ -511,7 +511,7 @@
 /*ARGSUSED*/
 int dontroute( iface, av )
     struct interface	*iface;
-    char		**av;
+    char		**av _U_;
 {
     /* make sure "-router" and "-dontroute" aren't both on the same line. */
     if (iface->i_flags & IFACE_RSEED) {
@@ -526,7 +526,7 @@
 /*ARGSUSED*/
 int seed( iface, av )
     struct interface	*iface;
-    char		**av;
+    char		**av _U_;
 {
     /*
      * Check to be sure "-seed" is before "-zone". we keep the old
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/atalkd/main.c netatalk/etc/atalkd/main.c
--- netatalk.orig/etc/atalkd/main.c	2005-01-31 18:01:04.000000000 +0100
+++ netatalk/etc/atalkd/main.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: main.c,v 1.17.8.6.2.1 2005/01/31 17:01:04 didg Exp $
+ * $Id: main.c,v 1.17.8.6.2.2 2005/09/27 10:40:41 didg Exp $
  *
  * Copyright (c) 1990,1993 Regents of The University of Michigan.
  * All Rights Reserved. See COPYRIGHT.
@@ -108,13 +108,13 @@
 
 int		rtfd;
 
-struct atserv	atserv[] = {
+static struct atserv	atserv[] = {
     { "rtmp",		1,	rtmp_packet },		/* 0 */
     { "nbp",		2,	nbp_packet },		/* 1 */
     { "echo",		4,	aep_packet },		/* 2 */
     { "zip",		6,	zip_packet },		/* 3 */
 };
-int		atservNATSERV = elements( atserv );
+static int		atservNATSERV = elements( atserv );
 
 struct interface	*interfaces = NULL, *ciface = NULL;
 
@@ -168,7 +168,7 @@
 }
 
 
-static void as_timer(int sig)
+static void as_timer(int sig _U_)
 {
     struct sockaddr_at	sat;
     struct ziphdr	zh;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/cnid_dbd/cnid_metad.c netatalk/etc/cnid_dbd/cnid_metad.c
--- netatalk.orig/etc/cnid_dbd/cnid_metad.c	2004-09-06 09:19:21.000000000 +0200
+++ netatalk/etc/cnid_dbd/cnid_metad.c	2007-06-04 08:57:42.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: cnid_metad.c,v 1.1.4.15 2004/09/06 07:19:21 didg Exp $
+ * $Id: cnid_metad.c,v 1.1.4.15.2.2 2007/06/04 06:57:42 didg Exp $
  *
  * Copyright (C) Joerg Lenneis 2003
  * All Rights Reserved.  See COPYING.
@@ -92,6 +92,7 @@
 
 static int srvfd;
 static int rqstfd;
+volatile sig_atomic_t alarmed = 0;
 
 #define MAXSRV 128
 
@@ -114,7 +115,7 @@
 
 static struct server srv[MAXSRV +1];
 
-static struct server *test_usockfn(char *dir, char *fn)
+static struct server *test_usockfn(char *dir, char *fn _U_)
 {
 int i;
     for (i = 1; i <= MAXSRV; i++) {
@@ -363,10 +364,15 @@
 }
 
 /* ------------------ */
+void catch_alarm(int sig) {
+	alarmed = 1;
+}
+
+/* ------------------ */
 int main(int argc, char *argv[])
 {
     char  dbdir[MAXPATHLEN + 1];
-    int   len;
+    int   len, actual_len;
     pid_t pid;
     int   status;
     char  *dbdpn = _PATH_CNID_DBD;
@@ -472,6 +478,7 @@
     }
 
     signal(SIGPIPE, SIG_IGN);
+    signal(SIGALRM, catch_alarm);
 
     while (1) {
         rqstfd = usockfd_check(srvfd, 10000000);
@@ -500,9 +507,18 @@
 	}
         if (rqstfd <= 0)
             continue;
+
         /* TODO: Check out read errors, broken pipe etc. in libatalk. Is
            SIGIPE ignored there? Answer: Ignored for dsi, but not for asp ... */
+        alarm(5); /* to prevent read from getting stuck */
         ret = read(rqstfd, &len, sizeof(int));
+	alarm(0);
+	if (alarmed) {
+	    alarmed = 0;
+	    LOG(log_severe, logtype_cnid, "Read(1) bailed with alarm (timeout)");
+	    goto loop_end;
+	}
+	
         if (!ret) {
             /* already close */
             goto loop_end;
@@ -523,7 +539,16 @@
             LOG(log_error, logtype_cnid, "wrong len parameter: %d", len);
             goto loop_end;
         }
-        if (read(rqstfd, dbdir, len) != len) {
+        
+        alarm(5);
+	actual_len = read(rqstfd, dbdir, len);
+	alarm(0);
+	if (alarmed) {
+	    alarmed = 0;
+	    LOG(log_severe, logtype_cnid, "Read(2) bailed with alarm (timeout)");
+	    goto loop_end;
+	}
+        if (actual_len != len) {
             LOG(log_error, logtype_cnid, "error/short read (dir): %s", strerror(errno));
             goto loop_end;
         }
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/cnid_dbd/dbd_getstamp.c netatalk/etc/cnid_dbd/dbd_getstamp.c
--- netatalk.orig/etc/cnid_dbd/dbd_getstamp.c	2004-02-07 20:46:08.000000000 +0100
+++ netatalk/etc/cnid_dbd/dbd_getstamp.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: dbd_getstamp.c,v 1.1.2.3 2004/02/07 19:46:08 didg Exp $
+ * $Id: dbd_getstamp.c,v 1.1.2.3.2.1 2005/09/27 10:40:41 didg Exp $
  *
  * Copyright (C) Joerg Lenneis 2003
  * All Rights Reserved.  See COPYING.
@@ -21,7 +21,7 @@
 
 /* Return the unique stamp associated with this database */
 
-int dbd_getstamp(struct cnid_dbd_rqst *rqst, struct cnid_dbd_rply *rply)
+int dbd_getstamp(struct cnid_dbd_rqst *rqst _U_, struct cnid_dbd_rply *rply)
 {
     DBT key, data;
     int rc;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/cnid_dbd/dbd_lookup.c netatalk/etc/cnid_dbd/dbd_lookup.c
--- netatalk.orig/etc/cnid_dbd/dbd_lookup.c	2004-02-07 20:46:08.000000000 +0100
+++ netatalk/etc/cnid_dbd/dbd_lookup.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: dbd_lookup.c,v 1.1.4.7 2004/02/07 19:46:08 didg Exp $
+ * $Id: dbd_lookup.c,v 1.1.4.7.2.1 2005/09/27 10:40:41 didg Exp $
  *
  * Copyright (C) Joerg Lenneis 2003
  * All Rights Reserved.  See COPYING.
@@ -29,7 +29,7 @@
 
 int dbd_lookup(struct cnid_dbd_rqst *rqst, struct cnid_dbd_rply *rply)
 {
-    char *buf;
+    unsigned char *buf;
     DBT key, devdata, diddata;
     char dev[CNID_DEV_LEN];
     char ino[CNID_INO_LEN];
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/cnid_dbd/dbd_update.c netatalk/etc/cnid_dbd/dbd_update.c
--- netatalk.orig/etc/cnid_dbd/dbd_update.c	2004-03-22 00:04:07.000000000 +0100
+++ netatalk/etc/cnid_dbd/dbd_update.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: dbd_update.c,v 1.1.4.12 2004/03/21 23:04:07 lenneis Exp $
+ * $Id: dbd_update.c,v 1.1.4.12.2.1 2005/09/27 10:40:41 didg Exp $
  *
  * Copyright (C) Joerg Lenneis 2003
  * All Rights Reserved.  See COPYING.
@@ -36,7 +36,7 @@
 {
     DBT key,pkey, data;
     int rc;
-    char *buf;                            
+    unsigned char *buf;                            
     int notfound = 0;
     char getbuf[CNID_HEADER_LEN + MAXPATHLEN +1];
 #ifdef DEBUG
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/cnid_dbd/dbif.c netatalk/etc/cnid_dbd/dbif.c
--- netatalk.orig/etc/cnid_dbd/dbif.c	2004-12-21 14:36:12.000000000 +0100
+++ netatalk/etc/cnid_dbd/dbif.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: dbif.c,v 1.1.4.15.2.1 2004/12/21 13:36:12 didg Exp $
+ * $Id: dbif.c,v 1.1.4.15.2.3 2005/09/27 10:40:41 didg Exp $
  *
  * Copyright (C) Joerg Lenneis 2003
  * All Rights Reserved.  See COPYING.
@@ -233,7 +233,7 @@
 }
 
 /* --------------- */
-int dbif_open(struct db_param *dbp, int do_truncate)
+int dbif_open(struct db_param *dbp _U_, int do_truncate)
 {
     int ret;
     int i;
@@ -514,7 +514,11 @@
     DB_BTREE_STAT *sp;
     DB *db = db_table[dbi].db;
 
+#if DB_VERSION_MAJOR > 4 || (DB_VERSION_MAJOR == 4 && DB_VERSION_MINOR >= 3)
+    ret = db->stat(db, db_txn, &sp, 0);
+#else
     ret = db->stat(db, &sp, 0);
+#endif
 
     if (ret) {
         LOG(log_error, logtype_cnid, "error getting stat infotmation on database: %s", db_strerror(errno));
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/cnid_dbd/db_param.c netatalk/etc/cnid_dbd/db_param.c
--- netatalk.orig/etc/cnid_dbd/db_param.c	2004-12-21 14:36:12.000000000 +0100
+++ netatalk/etc/cnid_dbd/db_param.c	2007-06-06 12:18:07.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: db_param.c,v 1.1.4.4.2.1 2004/12/21 13:36:12 didg Exp $
+ * $Id: db_param.c,v 1.1.4.4.2.3 2007/06/06 10:18:07 didg Exp $
  *
  * Copyright (C) Joerg Lenneis 2003
  * All Rights Reserved.  See COPYING.
@@ -36,21 +36,21 @@
 #define DEFAULT_FLUSH_FREQUENCY    100  
 #define DEFAULT_FLUSH_INTERVAL     30   
 #define DEFAULT_USOCK_FILE         "usock"
-#define DEFAULT_FD_TABLE_SIZE      16
+#define DEFAULT_FD_TABLE_SIZE      64
 #define DEFAULT_IDLE_TIMEOUT       600
 #define DEFAULT_CHECK              0
 
 static struct db_param params;
 static int parse_err;
 
-static int usock_maxlen()
+static size_t usock_maxlen()
 {
     struct sockaddr_un addr;
 
     return sizeof(addr.sun_path) - 1;
 }
 
-static int make_pathname(char *path, char *dir, char *fn, int maxlen)
+static int make_pathname(char *path, char *dir, char *fn, size_t maxlen)
 {
     size_t len;
 
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/cnid_dbd/Makefile.am netatalk/etc/cnid_dbd/Makefile.am
--- netatalk.orig/etc/cnid_dbd/Makefile.am	2004-12-21 14:36:12.000000000 +0100
+++ netatalk/etc/cnid_dbd/Makefile.am	2006-09-07 05:45:54.000000000 +0200
@@ -11,18 +11,15 @@
                    dbd_update.c dbd_delete.c dbd_getstamp.c \
                    dbd_dbcheck.c
 
-cnid_dbd_LDADD = $(top_builddir)/libatalk/libatalk.la
+cnid_dbd_LDADD = $(top_builddir)/libatalk/libatalk.la @BDB_LIBS@
 
 cnid_metad_SOURCES = cnid_metad.c usockfd.c db_param.c
 
-cnid_metad_LDADD = $(top_builddir)/libatalk/libatalk.la
+cnid_metad_LDADD = $(top_builddir)/libatalk/libatalk.la 
 
 noinst_HEADERS = dbif.h pack.h db_param.h dbd.h usockfd.h comm.h
 
 EXTRA_DIST = README
 
-LIBS = @LIBS@ @BDB_LIBS@
-
-
 CFLAGS = @CFLAGS@ @BDB_CFLAGS@ \
          -D_PATH_CNID_DBD=\"$(sbindir)/cnid_dbd\"
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/cnid_dbd/pack.c netatalk/etc/cnid_dbd/pack.c
--- netatalk.orig/etc/cnid_dbd/pack.c	2004-02-07 20:46:08.000000000 +0100
+++ netatalk/etc/cnid_dbd/pack.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: pack.c,v 1.1.4.9 2004/02/07 19:46:08 didg Exp $
+ * $Id: pack.c,v 1.1.4.9.2.1 2005/09/27 10:40:41 didg Exp $
  *
  * Copyright (C) Joerg Lenneis 2003
  * All Rights Reserved.  See COPYING.
@@ -57,8 +57,8 @@
 
 /* --------------- */
 int didname(dbp, pkey, pdata, skey)
-DB *dbp;
-const DBT *pkey, *pdata;
+DB *dbp _U_;
+const DBT *pkey _U_, *pdata;
 DBT *skey;
 {
 int len;
@@ -75,8 +75,8 @@
  
 /* --------------- */
 int devino(dbp, pkey, pdata, skey)
-DB *dbp;
-const DBT *pkey, *pdata;
+DB *dbp _U_;
+const DBT *pkey _U_, *pdata;
 DBT *skey;
 {
     memset(skey, 0, sizeof(DBT));
@@ -89,10 +89,10 @@
    differ from make_cnid_data in that we never return NULL, rqst->name cannot
    ever cause start[] to overflow because name length is checked in libatalk. */
 
-char *pack_cnid_data(struct cnid_dbd_rqst *rqst)
+unsigned char *pack_cnid_data(struct cnid_dbd_rqst *rqst)
 {
-    static char start[CNID_HEADER_LEN + MAXPATHLEN + 1];
-    char *buf = start +CNID_LEN;
+    static unsigned char start[CNID_HEADER_LEN + MAXPATHLEN + 1];
+    unsigned char *buf = start +CNID_LEN;
     u_int32_t i;
 
     pack_devino(buf, rqst->dev, rqst->ino);
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/cnid_dbd/pack.h netatalk/etc/cnid_dbd/pack.h
--- netatalk.orig/etc/cnid_dbd/pack.h	2004-01-21 22:28:42.000000000 +0100
+++ netatalk/etc/cnid_dbd/pack.h	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: pack.h,v 1.1.4.3 2004/01/21 21:28:42 lenneis Exp $
+ * $Id: pack.h,v 1.1.4.3.2.1 2005/09/27 10:40:41 didg Exp $
  *
  * Copyright (C) Joerg Lenneis 2003
  * All Rights Reserved.  See COPYING.
@@ -38,7 +38,7 @@
 #define CNID_DBD_HEADER_LEN          (CNID_DBD_DEVINO_LEN + CNID_DBD_DID_LEN)
 #endif
 
-extern char      *pack_cnid_data  __P((struct cnid_dbd_rqst *));
+extern unsigned char *pack_cnid_data  __P((struct cnid_dbd_rqst *));
 
 #ifdef DEBUG
 extern char      *stringify_devino  __P((dev_t dev, ino_t ino));
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/cnid_dbd/usockfd.c netatalk/etc/cnid_dbd/usockfd.c
--- netatalk.orig/etc/cnid_dbd/usockfd.c	2004-09-06 09:19:21.000000000 +0200
+++ netatalk/etc/cnid_dbd/usockfd.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: usockfd.c,v 1.1.4.4 2004/09/06 07:19:21 didg Exp $
+ * $Id: usockfd.c,v 1.1.4.4.2.1 2005/09/27 10:40:41 didg Exp $
  *
  * Copyright (C) Joerg Lenneis 2003
  * All Rights Reserved.  See COPYING.
@@ -141,7 +141,7 @@
 int usockfd_check(int sockfd, unsigned long ndelay)
 {
     int fd;
-    int size;
+    socklen_t size;
     fd_set readfds;
     struct timeval tv;
     int ret;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/papd/headers.c netatalk/etc/papd/headers.c
--- netatalk.orig/etc/papd/headers.c	2005-02-06 11:16:02.000000000 +0100
+++ netatalk/etc/papd/headers.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: headers.c,v 1.9.10.1.2.1 2005/02/06 10:16:02 didg Exp $
+ * $Id: headers.c,v 1.9.10.1.2.2 2005/09/27 10:40:41 didg Exp $
  *
  * Copyright (c) 1990,1994 Regents of The University of Michigan.
  * All Rights Reserved.  See COPYRIGHT.
@@ -25,7 +25,7 @@
 
 
 int ch_for( in, out )
-	struct papfile	*in, *out;
+	struct papfile	*in, *out _U_;
 {
     char                *start, *stop, *p, *q, c;
     int                 linelength, crlflength;
@@ -74,7 +74,7 @@
 }
 
 int ch_title( in, out )
-    struct papfile	*in, *out;
+    struct papfile	*in, *out _U_;
 {
     char		*start, *stop, *p, *q, c;
     int			linelength, crlflength;
@@ -138,7 +138,7 @@
 
 
 int ch_creator( in, out )
-    struct papfile	*in, *out;
+    struct papfile	*in, *out _U_;
 {
     char		*start, *stop, *p, *q, c;
     int			linelength, crlflength;
@@ -188,7 +188,7 @@
 }
 
 int ch_endcomm( in, out )
-    struct papfile	*in, *out;
+    struct papfile	*in, *out _U_;
 {
     char                *start;
     int                 linelength, crlflength;
@@ -215,7 +215,7 @@
 }
 
 int ch_starttranslate(in,out)
-    struct papfile      *in, *out;
+    struct papfile      *in, *out _U_;
 {
     char                *start;
     int                 linelength, crlflength;
@@ -240,7 +240,7 @@
 }
 
 int ch_endtranslate(in,out)
-    struct papfile      *in, *out;
+    struct papfile      *in, *out _U_;
 {
     char                *start;
     int                 linelength, crlflength;
@@ -265,7 +265,7 @@
 }
 
 int ch_translateone(in,out)
-    struct papfile      *in, *out;
+    struct papfile      *in, *out _U_;
 {
     char                *start;
     int                 linelength, crlflength;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/papd/magics.c netatalk/etc/papd/magics.c
--- netatalk.orig/etc/papd/magics.c	2005-02-06 11:16:02.000000000 +0100
+++ netatalk/etc/papd/magics.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: magics.c,v 1.11.6.2.2.1 2005/02/06 10:16:02 didg Exp $
+ * $Id: magics.c,v 1.11.6.2.2.2 2005/09/27 10:40:41 didg Exp $
  *
  * Copyright (c) 1990,1994 Regents of The University of Michigan.
  * All Rights Reserved.  See COPYRIGHT.
@@ -89,7 +89,7 @@
 
 int cm_psquery( in, out, sat )
     struct papfile	*in, *out;
-    struct sockaddr_at	*sat;
+    struct sockaddr_at	*sat _U_;
 {
     struct papd_comment	*comment;
     char		*start;
@@ -122,7 +122,7 @@
 
 int cm_psadobe( in, out, sat )
     struct papfile	*in, *out;
-    struct sockaddr_at	*sat;
+    struct sockaddr_at	*sat _U_;
 {
     char		*start;
     int			linelength, crlflength;
@@ -163,7 +163,7 @@
 
 int cm_psswitch( in, out, sat )
     struct papfile	*in, *out;
-    struct sockaddr_at	*sat;
+    struct sockaddr_at	*sat _U_;
 {
     char		*start, *stop, *p;
     int			linelength, crlflength;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/papd/main.c netatalk/etc/papd/main.c
--- netatalk.orig/etc/papd/main.c	2004-06-09 03:25:53.000000000 +0200
+++ netatalk/etc/papd/main.c	2007-04-27 23:29:16.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: main.c,v 1.18.6.2 2004/06/09 01:25:53 bfernhomberg Exp $
+ * $Id: main.c,v 1.18.6.2.2.2 2007/04/27 21:29:16 didg Exp $
  *
  * Copyright (c) 1990,1995 Regents of The University of Michigan.
  * All Rights Reserved.  See COPYRIGHT.
@@ -426,7 +426,6 @@
                     }
 #endif /* HAVE_CUPS */
 
-
 		    /*
 		     * If this fails, we've run out of sockets. Rather than
 		     * just die(), let's try to continue. Maybe some sockets
@@ -435,10 +434,13 @@
 		    if (( atp = atp_open( ATADDR_ANYPORT, 
 					  &pr->p_addr)) == NULL ) {
 			LOG(log_error, logtype_papd, "atp_open: %m" );
-			rbuf[ 2 ] = rbuf[ 3 ] = 0xff;
+			rbuf[ 2 ] = rbuf[ 3 ] = 0xff;  /* printer busy */
+			rbuf[ 4 ] = 0; /* FIXME is it right? */
 			err = 1;
 		    }
-		    rbuf[ 4 ] = atp_sockaddr( atp )->sat_port;
+		    else {
+		       rbuf[ 4 ] = atp_sockaddr( atp )->sat_port;
+                    }
 		    rbuf[ 5 ] = oquantum;
 		    rbuf[ 6 ] = rbuf[ 7 ] = 0;
 
@@ -451,16 +453,20 @@
 		     */
 		    if ( atp_sresp( pr->p_atp, &atpb ) < 0 ) {
 			LOG(log_error, logtype_papd, "atp_sresp: %m" );
-			continue;
+			err = 1;
 		    }
 
 		    if ( err ) {
+			if (atp) {
+			   atp_close(atp);
+                        }
 			continue;
 		    }
 
 		    switch ( c = fork()) {
 		    case -1 :
 			LOG(log_error, logtype_papd, "fork: %m" );
+                        atp_close(atp);
 			continue;
 
 		    case 0 : /* child */
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/papd/Makefile.am netatalk/etc/papd/Makefile.am
--- netatalk.orig/etc/papd/Makefile.am	2004-06-30 23:47:51.000000000 +0200
+++ netatalk/etc/papd/Makefile.am	2006-09-07 05:45:54.000000000 +0200
@@ -9,7 +9,7 @@
 papd_SOURCES = main.c printcap.c session.c file.c comment.c lp.c ppd.c \
 	       magics.c headers.c queries.c auth.c uam.c print_cups.c
 
-papd_LDADD = $(top_builddir)/libatalk/libatalk.la @PAM_LIBS@ @CUPS_LIBS@
+papd_LDADD = $(top_builddir)/libatalk/libatalk.la @CUPS_LIBS@ @LIBADD_DL@
 papd_LDFLAGS = -export-dynamic @CUPS_LDFLAGS@
 
 showppd_SOURCES = showppd.c ppd.c
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/papd/print_cups.c netatalk/etc/papd/print_cups.c
--- netatalk.orig/etc/papd/print_cups.c	2005-01-12 00:00:40.000000000 +0100
+++ netatalk/etc/papd/print_cups.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: print_cups.c,v 1.1.2.1.2.1 2005/01/11 23:00:40 didg Exp $
+ * $Id: print_cups.c,v 1.1.2.1.2.2 2005/09/27 10:40:41 didg Exp $
  *
  * Copyright 2004 Bjoern Fernhomberg.
  *
@@ -79,7 +79,7 @@
  */
 
 static const char *                            /* O - Password or NULL */
-cups_passwd_cb(const char *prompt)      /* I - Prompt */
+cups_passwd_cb(const char *prompt _U_)      /* I - Prompt */
 {
  /*
   * Always return NULL to indicate that no password is available...
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/papd/uam.c netatalk/etc/papd/uam.c
--- netatalk.orig/etc/papd/uam.c	2004-02-14 01:30:51.000000000 +0100
+++ netatalk/etc/papd/uam.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: uam.c,v 1.9.6.4 2004/02/14 00:30:51 didg Exp $
+ * $Id: uam.c,v 1.9.6.4.2.1 2005/09/27 10:40:41 didg Exp $
  *
  * Copyright (c) 1999 Adrian Sun (asun@zoology.washington.edu)
  * All Rights Reserved.  See COPYRIGHT.
@@ -183,15 +183,15 @@
 }
 
 /* Crap to support uams which call this afpd function */
-int uam_afpserver_option(void *private, const int what, void *option,
-                         int *len)
+int uam_afpserver_option(void *private _U_, const int what _U_, void *option _U_,
+                         int *len _U_)
 {
 	return(0);
 }
 
 /* --- helper functions for plugin uams --- */
 
-struct passwd *uam_getname(void *dummy, char *name, const int len)
+struct passwd *uam_getname(void *dummy _U_, char *name, const int len)
 {
   struct passwd *pwent;
   char *user;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/uams/uams_dhx_pam.c netatalk/etc/uams/uams_dhx_pam.c
--- netatalk.orig/etc/uams/uams_dhx_pam.c	2004-06-24 03:20:12.000000000 +0200
+++ netatalk/etc/uams/uams_dhx_pam.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: uams_dhx_pam.c,v 1.24.6.5 2004/06/24 01:20:12 bfernhomberg Exp $
+ * $Id: uams_dhx_pam.c,v 1.24.6.5.2.1 2005/09/27 10:40:41 didg Exp $
  *
  * Copyright (c) 1990,1993 Regents of The University of Michigan.
  * Copyright (c) 1999 Adrian Sun (asun@u.washington.edu) 
@@ -83,7 +83,7 @@
 static int PAM_conv (int num_msg,
                      const struct pam_message **msg,
                      struct pam_response **resp,
-                     void *appdata_ptr) {
+                     void *appdata_ptr _U_) {
   int count = 0;
   struct pam_response *reply;
   
@@ -185,7 +185,7 @@
 };
 
 
-static int dhx_setup(void *obj, char *ibuf, int ibuflen, 
+static int dhx_setup(void *obj, char *ibuf, int ibuflen _U_, 
 		     char *rbuf, int *rbuflen)
 {
     u_int16_t sessid;
@@ -316,7 +316,7 @@
 }
 
 /* -------------------------------- */
-static int login(void *obj, char *username, int ulen,  struct passwd **uam_pwd,
+static int login(void *obj, char *username, int ulen,  struct passwd **uam_pwd _U_,
 		     char *ibuf, int ibuflen,
 		     char *rbuf, int *rbuflen)
 {
@@ -404,7 +404,7 @@
 /* -------------------------------- */
 
 static int pam_logincont(void *obj, struct passwd **uam_pwd,
-			 char *ibuf, int ibuflen, 
+			 char *ibuf, int ibuflen _U_, 
 			 char *rbuf, int *rbuflen)
 {
     char *hostname;
@@ -561,7 +561,7 @@
 /* change pw for dhx needs a couple passes to get everything all
  * right. basically, it's like the login/logincont sequence */
 static int pam_changepw(void *obj, char *username,
-			struct passwd *pwd, char *ibuf, int ibuflen,
+			struct passwd *pwd _U_, char *ibuf, int ibuflen,
 			char *rbuf, int *rbuflen)
 {
     BIGNUM *bn1, *bn2, *bn3;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/uams/uams_dhx_passwd.c netatalk/etc/uams/uams_dhx_passwd.c
--- netatalk.orig/etc/uams/uams_dhx_passwd.c	2004-03-18 03:56:32.000000000 +0100
+++ netatalk/etc/uams/uams_dhx_passwd.c	2006-12-03 17:23:07.000000000 +0100
@@ -1,5 +1,5 @@
 /*
- * $Id: uams_dhx_passwd.c,v 1.18.6.6 2004/03/18 02:56:32 bfernhomberg Exp $
+ * $Id: uams_dhx_passwd.c,v 1.18.6.6.2.2 2006/12/03 16:23:07 didg Exp $
  *
  * Copyright (c) 1990,1993 Regents of The University of Michigan.
  * Copyright (c) 1999 Adrian Sun (asun@u.washington.edu) 
@@ -74,8 +74,8 @@
 #endif /* TRU64 */
 
 /* dhx passwd */
-static int pwd_login(void *obj, char *username, int ulen, struct passwd **uam_pwd,
-			char *ibuf, int ibuflen,
+static int pwd_login(void *obj, char *username, int ulen, struct passwd **uam_pwd _U_,
+			char *ibuf, int ibuflen _U_,
 			char *rbuf, int *rbuflen)
 {
     unsigned char iv[] = "CJalbert";
@@ -277,7 +277,7 @@
 }
 			
 static int passwd_logincont(void *obj, struct passwd **uam_pwd,
-			    char *ibuf, int ibuflen, 
+			    char *ibuf, int ibuflen _U_, 
 			    char *rbuf, int *rbuflen)
 {
 #ifdef SHADOWPW
@@ -403,3 +403,9 @@
   UAM_MODULE_VERSION,
   uam_setup, uam_cleanup
 };
+
+UAM_MODULE_EXPORT struct uam_export uams_dhx_passwd = {
+  UAM_MODULE_SERVER,
+  UAM_MODULE_VERSION,
+  uam_setup, uam_cleanup
+};
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/uams/uams_guest.c netatalk/etc/uams/uams_guest.c
--- netatalk.orig/etc/uams/uams_guest.c	2004-02-14 03:47:15.000000000 +0100
+++ netatalk/etc/uams/uams_guest.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: uams_guest.c,v 1.12.6.2 2004/02/14 02:47:15 didg Exp $
+ * $Id: uams_guest.c,v 1.12.6.2.2.1 2005/09/27 10:40:41 didg Exp $
  *
  * (c) 2001 (see COPYING)
  */
@@ -43,8 +43,8 @@
 
 /* login and login_ext are almost the same */
 static int noauth_login(void *obj, struct passwd **uam_pwd,
-			char *ibuf, int ibuflen, 
-			char *rbuf, int *rbuflen)
+			char *ibuf _U_, int ibuflen _U_, 
+			char *rbuf _U_, int *rbuflen)
 {
     struct passwd *pwent;
     char *guest, *username;
@@ -78,7 +78,7 @@
     return( AFP_OK );
 }
 
-static int noauth_login_ext(void *obj, char *uname, struct passwd **uam_pwd,
+static int noauth_login_ext(void *obj, char *uname _U_, struct passwd **uam_pwd,
                      char *ibuf, int ibuflen,
                      char *rbuf, int *rbuflen)
 {
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/uams/uams_pam.c netatalk/etc/uams/uams_pam.c
--- netatalk.orig/etc/uams/uams_pam.c	2004-02-14 03:47:15.000000000 +0100
+++ netatalk/etc/uams/uams_pam.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: uams_pam.c,v 1.15.2.1.2.5 2004/02/14 02:47:15 didg Exp $
+ * $Id: uams_pam.c,v 1.15.2.1.2.5.2.1 2005/09/27 10:40:41 didg Exp $
  *
  * Copyright (c) 1990,1993 Regents of The University of Michigan.
  * Copyright (c) 1999 Adrian Sun (asun@u.washington.edu) 
@@ -69,7 +69,7 @@
 static int PAM_conv (int num_msg,
                      const struct pam_message **msg,
                      struct pam_response **resp,
-                     void *appdata_ptr) 
+                     void *appdata_ptr _U_) 
 {
   struct pam_response *reply;
   int count;
@@ -139,8 +139,8 @@
 };
 
 static int login(void *obj, char *username, int ulen,  struct passwd **uam_pwd,
-		     char *ibuf, int ibuflen,
-		     char *rbuf, int *rbuflen)
+		     char *ibuf, int ibuflen _U_,
+		     char *rbuf _U_, int *rbuflen _U_)
 {
     struct passwd *pwd;
     int err, PAM_error;
@@ -282,9 +282,9 @@
 }
 
 /* change passwd */
-static int pam_changepw(void *obj, char *username,
-			struct passwd *pwd, char *ibuf, int ibuflen,
-			char *rbuf, int *rbuflen)
+static int pam_changepw(void *obj _U_, char *username,
+			struct passwd *pwd _U_, char *ibuf, int ibuflen _U_,
+			char *rbuf _U_, int *rbuflen _U_)
 {
     char pw[PASSWDLEN + 1];
     pam_handle_t *lpamh;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/uams/uams_passwd.c netatalk/etc/uams/uams_passwd.c
--- netatalk.orig/etc/uams/uams_passwd.c	2004-06-15 02:52:09.000000000 +0200
+++ netatalk/etc/uams/uams_passwd.c	2006-12-03 17:23:08.000000000 +0100
@@ -1,5 +1,5 @@
 /*
- * $Id: uams_passwd.c,v 1.19.2.1.2.9 2004/06/15 00:52:09 bfernhomberg Exp $
+ * $Id: uams_passwd.c,v 1.19.2.1.2.9.2.2 2006/12/03 16:23:08 didg Exp $
  *
  * Copyright (c) 1990,1993 Regents of The University of Michigan.
  * Copyright (c) 1999 Adrian Sun (asun@u.washington.edu) 
@@ -75,7 +75,7 @@
 
 static int pwd_login(void *obj, char *username, int ulen, struct passwd **uam_pwd,
                         char *ibuf, int ibuflen,
-                        char *rbuf, int *rbuflen)
+                        char *rbuf _U_, int *rbuflen _U_)
 {
     char  *p;
     struct passwd *pwd;
@@ -416,3 +416,9 @@
             UAM_MODULE_VERSION,
             uam_setup, uam_cleanup
         };
+
+UAM_MODULE_EXPORT struct uam_export uams_passwd = {
+            UAM_MODULE_SERVER,
+            UAM_MODULE_VERSION,
+            uam_setup, uam_cleanup
+        };
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/etc/uams/uams_randnum.c netatalk/etc/uams/uams_randnum.c
--- netatalk.orig/etc/uams/uams_randnum.c	2004-10-08 02:54:40.000000000 +0200
+++ netatalk/etc/uams/uams_randnum.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /* 
- * $Id: uams_randnum.c,v 1.12.6.4 2004/10/08 00:54:40 bfernhomberg Exp $
+ * $Id: uams_randnum.c,v 1.12.6.4.2.1 2005/09/27 10:40:41 didg Exp $
  *
  * Copyright (c) 1990,1993 Regents of The University of Michigan.
  * Copyright (c) 1999 Adrian Sun (asun@u.washington.edu) 
@@ -72,8 +72,8 @@
 
 /* handle ~/.passwd. courtesy of shirsch@ibm.net. */
 static  __inline__ int home_passwd(const struct passwd *pwd, 
-				   const char *path, const int pathlen, 
-				   char *passwd, const int len,
+				   const char *path, const int pathlen _U_, 
+				   unsigned char *passwd, const int len,
 				   const int set)
 {
   struct stat st;
@@ -145,7 +145,7 @@
 #define unhex(x)  (isdigit(x) ? (x) - '0' : toupper(x) + 10 - 'A')
 static int afppasswd(const struct passwd *pwd, 
 		     const char *path, const int pathlen, 
-		     char *passwd, int len, 
+		     unsigned char *passwd, int len, 
 		     const int set)
 {
   u_int8_t key[DES_KEY_SZ*2];
@@ -264,7 +264,7 @@
  * depending upon whether or not the password is in ~/.passwd
  * or in a global location */
 static int randpass(const struct passwd *pwd, const char *file,
-		    char *passwd, const int len, const int set) 
+		    unsigned char *passwd, const int len, const int set) 
 {
   int i;
   uid_t uid = geteuid();
@@ -303,8 +303,8 @@
 
 /* randnum sends an 8-byte number and uses the user's password to
  * check against the encrypted reply. */
-static int rand_login(void *obj, char *username, int ulen, struct passwd **uam_pwd,
-                        char *ibuf, int ibuflen,
+static int rand_login(void *obj, char *username, int ulen, struct passwd **uam_pwd _U_,
+                        char *ibuf _U_, int ibuflen _U_,
                         char *rbuf, int *rbuflen)
 {
 
@@ -350,8 +350,8 @@
 /* check encrypted reply. we actually setup the encryption stuff
  * here as the first part of randnum and rand2num are identical. */
 static int randnum_logincont(void *obj, struct passwd **uam_pwd,
-			     char *ibuf, int ibuflen, 
-			     char *rbuf, int *rbuflen)
+			     char *ibuf, int ibuflen _U_, 
+			     char *rbuf _U_, int *rbuflen)
 {
   u_int16_t sessid;
 
@@ -389,7 +389,7 @@
  *    and sends it back as part of the reply.
  */
 static int rand2num_logincont(void *obj, struct passwd **uam_pwd,
-			      char *ibuf, int ibuflen, 
+			      char *ibuf, int ibuflen _U_, 
 			      char *rbuf, int *rbuflen)
 {
   u_int16_t sessid;
@@ -437,9 +437,9 @@
  * NOTE: an FPLogin must already have completed successfully for this
  *       to work. 
  */
-static int randnum_changepw(void *obj, const char *username, 
+static int randnum_changepw(void *obj, const char *username _U_, 
 			    struct passwd *pwd, char *ibuf,
-			    int ibuflen, char *rbuf, int *rbuflen)
+			    int ibuflen _U_, char *rbuf _U_, int *rbuflen _U_)
 {
     char *passwdfile;
     int err, len;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/include/atalk/adouble.h netatalk/include/atalk/adouble.h
--- netatalk.orig/include/atalk/adouble.h	2005-02-12 12:22:05.000000000 +0100
+++ netatalk/include/atalk/adouble.h	2006-09-29 11:27:54.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: adouble.h,v 1.21.6.20.2.3 2005/02/12 11:22:05 didg Exp $
+ * $Id: adouble.h,v 1.21.6.20.2.7 2006/09/29 09:27:54 didg Exp $
  * Copyright (c) 1990,1991 Regents of The University of Michigan.
  * All Rights Reserved.
  *
@@ -252,6 +252,9 @@
     off_t               ad_rlen;     /* ressource fork len with AFP 3.0
                                         the header parameter size is too small.
                                      */
+    char                *ad_m_name;   /* mac name for open fork */
+    int                 ad_m_namelen;
+
     char                *(*ad_path)(const char *, int);
                            
 #ifdef USE_MMAPPED_HEADERS
@@ -268,10 +271,15 @@
 #define ADFLAGS_V1COMPAT  (1<<4)
 #define ADFLAGS_NOHF      (1<<5)  /* not an error if no ressource fork */
 #define ADFLAGS_RDONLY    (1<<6)  /* don't try readwrite */
+#define ADFLAGS_CREATE    (1<<7)
 
 /* adouble v2 cnid cache */
 #define ADVOL_NODEV      (1 << 0)   
 #define ADVOL_CACHE      (1 << 1)
+/* adouble unix priv */
+#define ADVOL_UNIXPRIV   (1 << 2)   
+/* dot files (.DS_Store) are invisible) */
+#define ADVOL_INVDOTS    (1 << 3)   
 
 /* lock flags */
 #define ADLOCK_CLR      (0)
@@ -411,7 +419,8 @@
 #define ad_metadata(name, flags, adp)  ad_open(name, ADFLAGS_HF|(flags), O_RDONLY, 0666, adp)
 #endif
 
-/* extend header to RW if R or W (W if R for locking),
+/* build a resource fork mode from the data fork mode:
+ * remove X mode and extend header to RW if R or W (W if R for locking),
  */ 
 #ifndef ATACC
 #ifndef __inline__
@@ -419,9 +428,7 @@
 #endif
 static __inline__ mode_t ad_hf_mode (mode_t mode)
 {
-#if 0
-    mode |= S_IRUSR;
-#endif    
+    mode &= ~(S_IXUSR | S_IXGRP | S_IXOTH);
     /* fnctl lock need write access */
     if ((mode & S_IRUSR))
         mode |= S_IWUSR;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/include/atalk/cnid.h netatalk/include/atalk/cnid.h
--- netatalk.orig/include/atalk/cnid.h	2005-01-30 21:56:21.000000000 +0100
+++ netatalk/include/atalk/cnid.h	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /* 
- * $Id: cnid.h,v 1.9.6.6.2.1 2005/01/30 20:56:21 didg Exp $
+ * $Id: cnid.h,v 1.9.6.6.2.2 2005/09/27 10:40:41 didg Exp $
  *
  * Copyright (c) 2003 the Netatalk Team
  * Copyright (c) 2003 Rafal Lewczuk <rlewczuk@pronet.pl>
@@ -51,18 +51,17 @@
 	void *_private;              /* back-end speficic data */
 
 	cnid_t (*cnid_add)(struct _cnid_db *cdb, const struct stat *st, const cnid_t did, 
-			char *name, const int len, cnid_t hint);
+			char *name, const size_t, cnid_t hint);
 	int (*cnid_delete)(struct _cnid_db *cdb, cnid_t id);
-	cnid_t (*cnid_get)(struct _cnid_db *cdb, const cnid_t did, char *name,
-			const int len);
+	cnid_t (*cnid_get)(struct _cnid_db *cdb, const cnid_t did, char *name, const  size_t);
 	cnid_t (*cnid_lookup)(struct _cnid_db *cdb, const struct stat *st, const cnid_t did,
-			char *name, const int len);
+			char *name, const size_t);
 	cnid_t (*cnid_nextid)(struct _cnid_db *cdb);
-	char *(*cnid_resolve)(struct _cnid_db *cdb, cnid_t *id, void *buffer, u_int32_t len);
+	char *(*cnid_resolve)(struct _cnid_db *cdb, cnid_t *id, void *buffer, size_t len);
 	int (*cnid_update)(struct _cnid_db *cdb, const cnid_t id, const struct stat *st, 
-			const cnid_t did, char *name, const int len);	
+			const cnid_t did, char *name, const size_t len);	
 	void (*cnid_close)(struct _cnid_db *cdb);
-	int  (*cnid_getstamp)(struct _cnid_db *cdb, void *buffer, const int len);
+	int  (*cnid_getstamp)(struct _cnid_db *cdb, void *buffer, const size_t len);
 };
 typedef struct _cnid_db cnid_db;
 
@@ -88,62 +87,28 @@
 struct _cnid_db *cnid_open(const char *volpath, mode_t mask, char *type, int flags);
 
 cnid_t cnid_add(struct _cnid_db *cdb, const struct stat *st, const cnid_t did, 
-			char *name, const int len, cnid_t hint);
+			char *name, const size_t len, cnid_t hint);
 
 int    cnid_delete(struct _cnid_db *cdb, cnid_t id);
 
-cnid_t cnid_get   (struct _cnid_db *cdb, const cnid_t did, char *name,const int len);
+cnid_t cnid_get   (struct _cnid_db *cdb, const cnid_t did, char *name,const size_t len);
 
-int    cnid_getstamp(struct _cnid_db *cdb, void *buffer, const int len);
+int    cnid_getstamp(struct _cnid_db *cdb, void *buffer, const size_t len);
 
 cnid_t cnid_lookup(struct _cnid_db *cdb, const struct stat *st, const cnid_t did,
-			char *name, const int len);
+			char *name, const size_t len);
 
-char *cnid_resolve(struct _cnid_db *cdb, cnid_t *id, void *buffer, u_int32_t len);
+char *cnid_resolve(struct _cnid_db *cdb, cnid_t *id, void *buffer, size_t len);
 
 int cnid_update   (struct _cnid_db *cdb, const cnid_t id, const struct stat *st, 
-			const cnid_t did, char *name, const int len);	
+			const cnid_t did, char *name, const size_t len);
+
+cnid_t cnid_rebuild_add(struct _cnid_db *cdb, const struct stat *st, const cnid_t did,
+                        char *name, const size_t len, cnid_t hint);
+
 
 /* This function closes a CNID database and frees all resources assigned to it. */ 
 void cnid_close(struct _cnid_db *db);
 
 #endif
 
-/*
- * $Log: cnid.h,v $
- * Revision 1.9.6.6.2.1  2005/01/30 20:56:21  didg
- *
- * Olaf Hering at suse.de warning fixes.
- *
- * Revision 1.9.6.6  2004/02/22 18:36:37  didg
- *
- * small clean up
- *
- * Revision 1.9.6.5  2004/01/14 23:15:19  lenneis
- * Check if we can get a DB stamp sucessfully in afs_openvol and fail
- * the open if not.
- *
- * Revision 1.9.6.4  2004/01/10 07:19:31  bfernhomberg
- * add cnid_init prototype
- *
- * Revision 1.9.6.3  2004/01/03 22:42:55  didg
- *
- * better errors handling in afpd for dbd cnid.
- *
- * Revision 1.9.6.2  2004/01/03 22:21:09  didg
- *
- * add nodev volume option (always use 0 for device number).
- *
- * Revision 1.9.6.1  2003/09/09 16:42:20  didg
- *
- * big merge for db frontend and unicode.
- *
- * Revision 1.9.4.2  2003/06/11 15:29:11  rlewczuk
- * Removed obsolete parameter from cnid_add. Spotted by Didier.
- *
- * Revision 1.9.4.1  2003/05/29 07:53:19  rlewczuk
- * Selectable CNIDs. Some refactoring. Propably needs more of refactoring, mainly
- * a well designed API (current API is just an old cnid_* API enclosed in VMT).
- *
- */
-
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/include/atalk/dsi.h netatalk/include/atalk/dsi.h
--- netatalk.orig/include/atalk/dsi.h	2005-02-01 13:06:17.000000000 +0100
+++ netatalk/include/atalk/dsi.h	2005-09-27 12:40:41.000000000 +0200
@@ -64,8 +64,9 @@
   
   u_int32_t attn_quantum, datasize, server_quantum;
   u_int16_t serverID, clientID;
-  u_int8_t *status, commands[DSI_CMDSIZ], data[DSI_DATASIZ];
-  int statuslen;
+  char      *status;
+  u_int8_t  commands[DSI_CMDSIZ], data[DSI_DATASIZ];
+  size_t statuslen;
   size_t datalen, cmdlen;
   size_t read_count, write_count;
   int asleep; /* client won't reply AFP 0x7a ? */
@@ -142,7 +143,7 @@
 			  const char * /*host*/, const char * /*address*/,
 			  const int /*port*/, const int /*proxy*/,
 			  const u_int32_t /* server quantum */));
-extern void dsi_setstatus __P((DSI *, u_int8_t *, const int));
+extern void dsi_setstatus __P((DSI *, char *, const size_t));
 
 /* in dsi_getsess.c */
 extern DSI *dsi_getsession __P((DSI *, server_child *, const int));
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/adouble/ad_open.c netatalk/libatalk/adouble/ad_open.c
--- netatalk.orig/libatalk/adouble/ad_open.c	2005-02-12 12:22:05.000000000 +0100
+++ netatalk/libatalk/adouble/ad_open.c	2006-09-29 11:27:54.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: ad_open.c,v 1.30.6.18.2.4 2005/02/12 11:22:05 didg Exp $
+ * $Id: ad_open.c,v 1.30.6.18.2.7 2006/09/29 09:27:54 didg Exp $
  *
  * Copyright (c) 1999 Adrian Sun (asun@u.washington.edu)
  * Copyright (c) 1990,1991 Regents of The University of Michigan.
@@ -484,6 +484,7 @@
 #if 0
     mode |= S_IRUSR;
 #endif    
+    mode &= ~(S_IXUSR | S_IXGRP | S_IXOTH);
     /* fnctl lock need write access */
     if ((mode & S_IRUSR))
         mode |= S_IWUSR;
@@ -943,7 +944,7 @@
     struct stat         st;
     char		*slash, *ad_p;
     int			hoflags, admode;
-    int                 st_invalid;
+    int                 st_invalid = -1;
     int                 open_df = 0;
     
     if (ad->ad_inited != AD_INITED) {
@@ -959,12 +960,17 @@
         if (ad_dfileno(ad) == -1) {
 	  hoflags = (oflags & ~(O_RDONLY | O_WRONLY)) | O_RDWR;
 	  admode = mode;
-	  st_invalid = ad_mode_st(path, &admode, &st);
+	  if ((oflags & O_CREAT)) {
+	      st_invalid = ad_mode_st(path, &admode, &st);
+	      if ((ad->ad_options & ADVOL_UNIXPRIV)) {
+	          admode = mode;
+	      }
+	  }
           ad->ad_df.adf_fd =open( path, hoflags, admode );
 	  if (ad->ad_df.adf_fd < 0 ) {
              if ((errno == EACCES || errno == EROFS) && !(oflags & O_RDWR)) {
                 hoflags = oflags;
-                ad->ad_df.adf_fd =open( path, hoflags, admode );
+                ad->ad_df.adf_fd = open( path, hoflags, admode );
              }
 	  }
 	  if ( ad->ad_df.adf_fd < 0)
@@ -972,7 +978,7 @@
 
 	  AD_SET(ad->ad_df.adf_off);
 	  ad->ad_df.adf_flags = hoflags;
-	  if ((oflags & O_CREAT) && !st_invalid) {
+	  if (!st_invalid) {
 	      /* just created, set owner if admin (root) */
 	      ad_chown(path, &st);
 	  }
@@ -1039,6 +1045,9 @@
 	    admode = mode;
 	    errno = 0;
 	    st_invalid = ad_mode_st(ad_p, &admode, &st);
+	    if ((ad->ad_options & ADVOL_UNIXPRIV)) {
+	        admode = mode;
+	    }
 	    admode = ad_hf_mode(admode); 
 	    if ( errno == ENOENT && !(adflags & ADFLAGS_NOADOUBLE) && ad->ad_flags != AD_VERSION2_OSX) {
 		/*
@@ -1056,6 +1065,9 @@
 		*slash = '/';
 		admode = mode;
 		st_invalid = ad_mode_st(ad_p, &admode, &st);
+		if ((ad->ad_options & ADVOL_UNIXPRIV)) {
+	            admode = mode;
+	        }
 		admode = ad_hf_mode(admode); 
 	    }
 	    /* retry with O_CREAT */
@@ -1182,12 +1194,13 @@
     }
 
     /* make things invisible */
-    if ((*path == '.') && strcmp(path, ".") && strcmp(path, "..")) {
+    if ((ad->ad_options & ADVOL_INVDOTS) && !(adflags & ADFLAGS_CREATE) && 
+           (*path == '.') && strcmp(path, ".") && strcmp(path, "..")) 
+    {
         ashort = htons(ATTRBIT_INVISIBLE);
 	ad_setattr(ad, ashort);
 	ashort = htons(FINDERINFO_INVISIBLE);
-	memcpy(ad_entry(ad, ADEID_FINDERI) + FINDERINFO_FRFLAGOFF,
-		     &ashort, sizeof(ashort));
+	memcpy(ad_entry(ad, ADEID_FINDERI) + FINDERINFO_FRFLAGOFF, &ashort, sizeof(ashort));
     }
 
     if (stat(path, &st) < 0) {
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/cnid/cdb/cnid_cdb_add.c netatalk/libatalk/cnid/cdb/cnid_cdb_add.c
--- netatalk.orig/libatalk/cnid/cdb/cnid_cdb_add.c	2005-01-30 21:56:22.000000000 +0100
+++ netatalk/libatalk/cnid/cdb/cnid_cdb_add.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: cnid_cdb_add.c,v 1.1.4.6.2.1 2005/01/30 20:56:22 didg Exp $
+ * $Id: cnid_cdb_add.c,v 1.1.4.6.2.2 2005/09/27 10:40:41 didg Exp $
  *
  * Copyright (c) 1999. Adrian Sun (asun@zoology.washington.edu)
  * All Rights Reserved. See COPYRIGHT.
@@ -40,11 +40,11 @@
     buf[CNID_DEV_LEN + CNID_INO_LEN - 8] = ino;    
 }
 
-char *make_cnid_data(const struct stat *st,const cnid_t did,
-                     const char *name, const int len)
+unsigned char *make_cnid_data(const struct stat *st,const cnid_t did,
+                     const char *name, const size_t len)
 {
-    static char start[CNID_HEADER_LEN + MAXPATHLEN + 1];
-    char *buf = start  +CNID_LEN;
+    static unsigned char start[CNID_HEADER_LEN + MAXPATHLEN + 1];
+    unsigned char *buf = start  +CNID_LEN;
     u_int32_t i;
 
     if (len > MAXPATHLEN)
@@ -70,7 +70,7 @@
 #endif
 
 extern int cnid_cdb_update(struct _cnid_db *cdb, const cnid_t id, const struct stat *st,
-                const cnid_t did, char *name, const int len);
+                const cnid_t did, char *name, const size_t len);
 
 /* --------------- */
 int db_stamp(void *buffer, size_t size)
@@ -169,7 +169,7 @@
 
 /* ------------------------ */
 cnid_t cnid_cdb_add(struct _cnid_db *cdb, const struct stat *st,
-                const cnid_t did, char *name, const int len,
+                const cnid_t did, char *name, const size_t len,
                 cnid_t hint)
 {
     CNID_private *db;
@@ -246,7 +246,7 @@
 
 /* cnid_cbd_getstamp */
 /*-----------------------*/
-int cnid_cdb_getstamp(struct _cnid_db *cdb, void *buffer, const int len)
+int cnid_cdb_getstamp(struct _cnid_db *cdb, void *buffer, const size_t len)
 {
     DBT key, data;
     int rc;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/cnid/cdb/cnid_cdb_get.c netatalk/libatalk/cnid/cdb/cnid_cdb_get.c
--- netatalk.orig/libatalk/cnid/cdb/cnid_cdb_get.c	2005-01-30 21:56:22.000000000 +0100
+++ netatalk/libatalk/cnid/cdb/cnid_cdb_get.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: cnid_cdb_get.c,v 1.1.4.2.2.1 2005/01/30 20:56:22 didg Exp $
+ * $Id: cnid_cdb_get.c,v 1.1.4.2.2.2 2005/09/27 10:40:41 didg Exp $
  */
 
 #ifdef HAVE_CONFIG_H
@@ -11,7 +11,7 @@
 
 /* Return CNID for a given did/name. */
 cnid_t cnid_cdb_get(struct _cnid_db *cdb, const cnid_t did, char *name,
-                const int len)
+                const size_t len)
 {
     char start[CNID_DID_LEN + MAXPATHLEN + 1], *buf;
     CNID_private *db;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/cnid/cdb/cnid_cdb.h netatalk/libatalk/cnid/cdb/cnid_cdb.h
--- netatalk.orig/libatalk/cnid/cdb/cnid_cdb.h	2005-01-30 21:56:22.000000000 +0100
+++ netatalk/libatalk/cnid/cdb/cnid_cdb.h	2005-09-27 12:40:41.000000000 +0200
@@ -23,18 +23,18 @@
 
 /* cnid_add.c */
 extern cnid_t cnid_cdb_add __P((struct _cnid_db *, const struct stat *, const cnid_t,
-			    char *, const int, cnid_t));
-extern int cnid_cdb_getstamp __P((struct _cnid_db *, void *, const int ));
+			    char *, const size_t, cnid_t));
+extern int cnid_cdb_getstamp __P((struct _cnid_db *, void *, const size_t ));
 
 /* cnid_get.c */
-extern cnid_t cnid_cdb_get __P((struct _cnid_db *, const cnid_t, char *, const int)); 
-extern char *cnid_cdb_resolve __P((struct _cnid_db *, cnid_t *, void *, u_int32_t )); 
+extern cnid_t cnid_cdb_get __P((struct _cnid_db *, const cnid_t, char *, const size_t)); 
+extern char *cnid_cdb_resolve __P((struct _cnid_db *, cnid_t *, void *, size_t )); 
 extern cnid_t cnid_cdb_lookup __P((struct _cnid_db *, const struct stat *, const cnid_t,
-			       char *, const int));
+			       char *, const size_t));
 
 /* cnid_update.c */
 extern int cnid_cdb_update __P((struct _cnid_db *, const cnid_t, const struct stat *,
-			    const cnid_t, char *, int));
+			    const cnid_t, char *, size_t));
 
 /* cnid_delete.c */
 extern int cnid_cdb_delete __P((struct _cnid_db *, const cnid_t));
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/cnid/cdb/cnid_cdb_lookup.c netatalk/libatalk/cnid/cdb/cnid_cdb_lookup.c
--- netatalk.orig/libatalk/cnid/cdb/cnid_cdb_lookup.c	2005-01-30 21:56:22.000000000 +0100
+++ netatalk/libatalk/cnid/cdb/cnid_cdb_lookup.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: cnid_cdb_lookup.c,v 1.1.4.5.2.1 2005/01/30 20:56:22 didg Exp $
+ * $Id: cnid_cdb_lookup.c,v 1.1.4.5.2.2 2005/09/27 10:40:41 didg Exp $
  */
 
 #ifdef HAVE_CONFIG_H
@@ -15,9 +15,9 @@
 /* This returns the CNID corresponding to a particular file.  It will
  * also fix up the various databases if there's a problem. */
 cnid_t cnid_cdb_lookup(struct _cnid_db *cdb, const struct stat *st, const cnid_t did,
-                   char *name, const int len)
+                   char *name, const size_t len)
 {
-    char *buf;
+    unsigned char *buf;
     CNID_private *db;
     DBT key, devdata, diddata;
     char dev[CNID_DEV_LEN];
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/cnid/cdb/cnid_cdb_open.c netatalk/libatalk/cnid/cdb/cnid_cdb_open.c
--- netatalk.orig/libatalk/cnid/cdb/cnid_cdb_open.c	2004-03-22 05:38:51.000000000 +0100
+++ netatalk/libatalk/cnid/cdb/cnid_cdb_open.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,6 +1,6 @@
 
 /*
- * $Id: cnid_cdb_open.c,v 1.1.4.10 2004/03/22 04:38:51 bfernhomberg Exp $
+ * $Id: cnid_cdb_open.c,v 1.1.4.10.2.1 2005/09/27 10:40:41 didg Exp $
  *
  * Copyright (c) 1999. Adrian Sun (asun@zoology.washington.edu)
  * All Rights Reserved. See COPYRIGHT.
@@ -86,8 +86,8 @@
 
 /* --------------- */
 static int didname(dbp, pkey, pdata, skey)
-DB *dbp;
-const DBT *pkey, *pdata;
+DB *dbp _U_;
+const DBT *pkey _U_, *pdata;
 DBT *skey;
 {
 int len;
@@ -101,8 +101,8 @@
  
 /* --------------- */
 static int devino(dbp, pkey, pdata, skey)
-DB *dbp;
-const DBT *pkey, *pdata;
+DB *dbp _U_;
+const DBT *pkey _U_, *pdata;
 DBT *skey;
 {
     memset(skey, 0, sizeof(DBT));
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/cnid/cdb/cnid_cdb_private.h netatalk/libatalk/cnid/cdb/cnid_cdb_private.h
--- netatalk.orig/libatalk/cnid/cdb/cnid_cdb_private.h	2004-03-22 05:38:51.000000000 +0100
+++ netatalk/libatalk/cnid/cdb/cnid_cdb_private.h	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: cnid_cdb_private.h,v 1.1.4.7 2004/03/22 04:38:51 bfernhomberg Exp $
+ * $Id: cnid_cdb_private.h,v 1.1.4.7.2.1 2005/09/27 10:40:41 didg Exp $
  */
 
 #ifndef LIBATALK_CDB_PRIVATE_H
@@ -195,12 +195,12 @@
     buf[CNID_DEV_LEN + CNID_INO_LEN - 8] = ino;    
 }
 
-static __inline__ char *make_cnid_data(const struct stat *st,
+static __inline__ unsigned char *make_cnid_data(const struct stat *st,
                                        const cnid_t did,
-                                       const char *name, const int len)
+                                       const char *name, const size_t len)
 {
-    static char start[CNID_HEADER_LEN + MAXPATHLEN + 1];
-    char *buf = start  +CNID_LEN;
+    static unsigned char start[CNID_HEADER_LEN + MAXPATHLEN + 1];
+    unsigned char *buf = start  +CNID_LEN;
     u_int32_t i;
 
     if (len > MAXPATHLEN)
@@ -224,8 +224,8 @@
     return start;
 }
 #else
-extern char *make_cnid_data __P((const struct stat *,const cnid_t ,
-                                       const char *, const int ));
+extern unsigned char *make_cnid_data __P((const struct stat *,const cnid_t ,
+                                       const char *, const size_t ));
 #endif
 
 #endif /* atalk/cnid/cnid_private.h */
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/cnid/cdb/cnid_cdb_resolve.c netatalk/libatalk/cnid/cdb/cnid_cdb_resolve.c
--- netatalk.orig/libatalk/cnid/cdb/cnid_cdb_resolve.c	2003-10-21 18:23:54.000000000 +0200
+++ netatalk/libatalk/cnid/cdb/cnid_cdb_resolve.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: cnid_cdb_resolve.c,v 1.1.4.2 2003/10/21 16:23:54 didg Exp $
+ * $Id: cnid_cdb_resolve.c,v 1.1.4.2.2.1 2005/09/27 10:40:41 didg Exp $
  */
 
 #ifdef HAVE_CONFIG_H
@@ -10,7 +10,7 @@
 #include "cnid_cdb_private.h"
 
 /* Return the did/name pair corresponding to a CNID. */
-char *cnid_cdb_resolve(struct _cnid_db *cdb, cnid_t *id, void *buffer, u_int32_t len) {
+char *cnid_cdb_resolve(struct _cnid_db *cdb, cnid_t *id, void *buffer, size_t len) {
     CNID_private *db;
     DBT key, data;
     int rc;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/cnid/cdb/cnid_cdb_update.c netatalk/libatalk/cnid/cdb/cnid_cdb_update.c
--- netatalk.orig/libatalk/cnid/cdb/cnid_cdb_update.c	2005-01-30 21:56:22.000000000 +0100
+++ netatalk/libatalk/cnid/cdb/cnid_cdb_update.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: cnid_cdb_update.c,v 1.1.4.4.2.1 2005/01/30 20:56:22 didg Exp $
+ * $Id: cnid_cdb_update.c,v 1.1.4.4.2.2 2005/09/27 10:40:41 didg Exp $
  */
 
 #ifdef HAVE_CONFIG_H
@@ -15,10 +15,10 @@
  * handle the did/name data, there are a bunch of functions to get
  * and set the various fields. */
 int cnid_cdb_update(struct _cnid_db *cdb, const cnid_t id, const struct stat *st,
-                const cnid_t did, char *name, const int len
+                const cnid_t did, char *name, const size_t len
                 /*, const char *info, const int infolen*/)
 {
-    char *buf;
+    unsigned char *buf;
     CNID_private *db;
     DBT key, pkey, data;
     int rc;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/cnid/cnid.c netatalk/libatalk/cnid/cnid.c
--- netatalk.orig/libatalk/cnid/cnid.c	2005-01-31 18:01:16.000000000 +0100
+++ netatalk/libatalk/cnid/cnid.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /* 
- * $Id: cnid.c,v 1.1.4.11.2.2 2005/01/31 17:01:16 didg Exp $
+ * $Id: cnid.c,v 1.1.4.11.2.3 2005/09/27 10:40:41 didg Exp $
  *
  * Copyright (c) 2003 the Netatalk Team
  * Copyright (c) 2003 Rafal Lewczuk <rlewczuk@pronet.pl>
@@ -196,7 +196,7 @@
 
 /* --------------- */
 cnid_t cnid_add(struct _cnid_db *cdb, const struct stat *st, const cnid_t did, 
-			char *name, const int len, cnid_t hint)
+			char *name, const size_t len, cnid_t hint)
 {
 cnid_t ret;
 
@@ -219,7 +219,7 @@
 
 
 /* --------------- */
-cnid_t cnid_get(struct _cnid_db *cdb, const cnid_t did, char *name,const int len)
+cnid_t cnid_get(struct _cnid_db *cdb, const cnid_t did, char *name,const size_t len)
 {
 cnid_t ret;
 
@@ -230,7 +230,7 @@
 }
 
 /* --------------- */
-int cnid_getstamp(struct _cnid_db *cdb,  void *buffer, const int len)
+int cnid_getstamp(struct _cnid_db *cdb,  void *buffer, const size_t len)
 {
 cnid_t ret;
 time_t t;
@@ -252,7 +252,7 @@
 
 /* --------------- */
 cnid_t cnid_lookup(struct _cnid_db *cdb, const struct stat *st, const cnid_t did,
-			char *name, const int len)
+			char *name, const size_t len)
 {
 cnid_t ret;
 
@@ -263,7 +263,7 @@
 }
 
 /* --------------- */
-char *cnid_resolve(struct _cnid_db *cdb, cnid_t *id, void *buffer, u_int32_t len)
+char *cnid_resolve(struct _cnid_db *cdb, cnid_t *id, void *buffer, size_t len)
 {
 char *ret;
 
@@ -275,7 +275,7 @@
 
 /* --------------- */
 int cnid_update   (struct _cnid_db *cdb, const cnid_t id, const struct stat *st, 
-			const cnid_t did, char *name, const int len)
+			const cnid_t did, char *name, const size_t len)
 {
 int ret;
 
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/cnid/db3/cnid_db3_add.c netatalk/libatalk/cnid/db3/cnid_db3_add.c
--- netatalk.orig/libatalk/cnid/db3/cnid_db3_add.c	2005-01-30 21:56:22.000000000 +0100
+++ netatalk/libatalk/cnid/db3/cnid_db3_add.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: cnid_db3_add.c,v 1.1.4.2.2.1 2005/01/30 20:56:22 didg Exp $
+ * $Id: cnid_db3_add.c,v 1.1.4.2.2.2 2005/09/27 10:40:41 didg Exp $
  *
  * Copyright (c) 1999. Adrian Sun (asun@zoology.washington.edu)
  * All Rights Reserved. See COPYRIGHT.
@@ -118,7 +118,6 @@
     DBT rootinfo_key, rootinfo_data;
     DB_TXN *tid;
     int rc;
-    int flag;
     cnid_t hint,id;
 
     memset(&rootinfo_key, 0, sizeof(rootinfo_key));
@@ -203,7 +202,7 @@
 
 /* ------------------------ */
 cnid_t cnid_db3_add(struct _cnid_db *cdb, const struct stat *st,
-                const cnid_t did, char *name, const int len,
+                const cnid_t did, char *name, const size_t len,
                 cnid_t hint)
 {
     CNID_private *db;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/cnid/db3/cnid_db3_get.c netatalk/libatalk/cnid/db3/cnid_db3_get.c
--- netatalk.orig/libatalk/cnid/db3/cnid_db3_get.c	2005-01-30 21:56:22.000000000 +0100
+++ netatalk/libatalk/cnid/db3/cnid_db3_get.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: cnid_db3_get.c,v 1.1.4.2.2.1 2005/01/30 20:56:22 didg Exp $
+ * $Id: cnid_db3_get.c,v 1.1.4.2.2.2 2005/09/27 10:40:41 didg Exp $
  */
 
 #ifdef HAVE_CONFIG_H
@@ -27,8 +27,7 @@
 #include "cnid_db3_private.h"
 
 /* Return CNID for a given did/name. */
-cnid_t cnid_db3_get(struct _cnid_db *cdb, const cnid_t did, char *name,
-                const int len)
+cnid_t cnid_db3_get(struct _cnid_db *cdb, const cnid_t did, char *name, const size_t len)
 {
     char start[CNID_DID_LEN + MAXPATHLEN + 1], *buf;
     CNID_private *db;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/cnid/db3/cnid_db3.h netatalk/libatalk/cnid/db3/cnid_db3.h
--- netatalk.orig/libatalk/cnid/db3/cnid_db3.h	2005-01-30 21:56:22.000000000 +0100
+++ netatalk/libatalk/cnid/db3/cnid_db3.h	2005-09-27 12:40:41.000000000 +0200
@@ -60,17 +60,17 @@
 
 /* cnid_add.c */
 extern cnid_t cnid_db3_add __P((struct _cnid_db *, const struct stat *, const cnid_t,
-			    char *, const int, cnid_t));
+			    char *, const size_t, cnid_t));
 
 /* cnid_get.c */
-extern cnid_t cnid_db3_get __P((struct _cnid_db *, const cnid_t, char *, const int)); 
-extern char *cnid_db3_resolve __P((struct _cnid_db *, cnid_t *, void *, u_int32_t )); 
+extern cnid_t cnid_db3_get __P((struct _cnid_db *, const cnid_t, char *, const size_t)); 
+extern char *cnid_db3_resolve __P((struct _cnid_db *, cnid_t *, void *, size_t )); 
 extern cnid_t cnid_db3_lookup __P((struct _cnid_db *, const struct stat *, const cnid_t,
-			       char *, const int));
+			       char *, const size_t));
 
 /* cnid_update.c */
 extern int cnid_db3_update __P((struct _cnid_db *, const cnid_t, const struct stat *,
-			    const cnid_t, char *, int));
+			    const cnid_t, char *, size_t));
 
 /* cnid_delete.c */
 extern int cnid_db3_delete __P((struct _cnid_db *, const cnid_t));
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/cnid/db3/cnid_db3_lookup.c netatalk/libatalk/cnid/db3/cnid_db3_lookup.c
--- netatalk.orig/libatalk/cnid/db3/cnid_db3_lookup.c	2005-01-30 21:56:22.000000000 +0100
+++ netatalk/libatalk/cnid/db3/cnid_db3_lookup.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,6 +1,6 @@
 
 /*
- * $Id: cnid_db3_lookup.c,v 1.1.4.2.2.1 2005/01/30 20:56:22 didg Exp $
+ * $Id: cnid_db3_lookup.c,v 1.1.4.2.2.2 2005/09/27 10:40:41 didg Exp $
  */
 
 #ifdef HAVE_CONFIG_H
@@ -32,9 +32,9 @@
 
 /* This returns the CNID corresponding to a particular file.  It will
  * also fix up the various databases if there's a problem. */
-cnid_t cnid_db3_lookup(struct _cnid_db *cdb, const struct stat *st, const cnid_t did, char *name, const int len)
+cnid_t cnid_db3_lookup(struct _cnid_db *cdb, const struct stat *st, const cnid_t did, char *name, const size_t len)
 {
-    char *buf;
+    unsigned char *buf;
     CNID_private *db;
     DBT key, devdata, diddata;
     int devino = 1, didname = 1;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/cnid/db3/cnid_db3_private.h netatalk/libatalk/cnid/db3/cnid_db3_private.h
--- netatalk.orig/libatalk/cnid/db3/cnid_db3_private.h	2003-10-30 10:38:47.000000000 +0100
+++ netatalk/libatalk/cnid/db3/cnid_db3_private.h	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: cnid_db3_private.h,v 1.1.4.3 2003/10/30 09:38:47 bfernhomberg Exp $
+ * $Id: cnid_db3_private.h,v 1.1.4.3.2.1 2005/09/27 10:40:41 didg Exp $
  */
 
 #ifndef LIBATALK_CNID_PRIVATE_H
@@ -106,12 +106,12 @@
 #endif /* __inline__ */
 
 /* construct db_cnid data. NOTE: this is not re-entrant.  */
-static __inline__ char *make_cnid_data(const struct stat *st,
+static __inline__ unsigned char *make_cnid_data(const struct stat *st,
                                        const cnid_t did,
-                                       const char *name, const int len)
+                                       const char *name, const size_t len)
 {
-    static char start[CNID_HEADER_LEN + MAXPATHLEN + 1];
-    char *buf = start;
+    static unsigned char start[CNID_HEADER_LEN + MAXPATHLEN + 1];
+    unsigned char *buf = start;
     u_int32_t i;
 
     if (len > MAXPATHLEN)
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/cnid/db3/cnid_db3_resolve.c netatalk/libatalk/cnid/db3/cnid_db3_resolve.c
--- netatalk.orig/libatalk/cnid/db3/cnid_db3_resolve.c	2003-10-21 18:23:54.000000000 +0200
+++ netatalk/libatalk/cnid/db3/cnid_db3_resolve.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: cnid_db3_resolve.c,v 1.1.4.2 2003/10/21 16:23:54 didg Exp $
+ * $Id: cnid_db3_resolve.c,v 1.1.4.2.2.1 2005/09/27 10:40:41 didg Exp $
  */
 
 #ifdef HAVE_CONFIG_H
@@ -27,7 +27,7 @@
 #include "cnid_db3_private.h"
 
 /* Return the did/name pair corresponding to a CNID. */
-char *cnid_db3_resolve(struct _cnid_db *cdb, cnid_t *id, void *buffer, u_int32_t len) {
+char *cnid_db3_resolve(struct _cnid_db *cdb, cnid_t *id, void *buffer, size_t len) {
     CNID_private *db;
     DBT key, data;
     int rc;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/cnid/db3/cnid_db3_update.c netatalk/libatalk/cnid/db3/cnid_db3_update.c
--- netatalk.orig/libatalk/cnid/db3/cnid_db3_update.c	2005-01-30 21:56:22.000000000 +0100
+++ netatalk/libatalk/cnid/db3/cnid_db3_update.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: cnid_db3_update.c,v 1.1.4.2.2.1 2005/01/30 20:56:22 didg Exp $
+ * $Id: cnid_db3_update.c,v 1.1.4.2.2.2 2005/09/27 10:40:41 didg Exp $
  */
 
 #ifdef HAVE_CONFIG_H
@@ -30,7 +30,7 @@
  * handle the did/name data, there are a bunch of functions to get
  * and set the various fields. */
 int cnid_db3_update(struct _cnid_db *cdb, const cnid_t id, const struct stat *st,
-                const cnid_t did, char *name, const int len
+                const cnid_t did, char *name, const size_t len
                 /*, const char *info, const int infolen*/)
 {
     CNID_private *db;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/cnid/dbd/cnid_dbd.c netatalk/libatalk/cnid/dbd/cnid_dbd.c
--- netatalk.orig/libatalk/cnid/dbd/cnid_dbd.c	2005-02-06 11:16:03.000000000 +0100
+++ netatalk/libatalk/cnid/dbd/cnid_dbd.c	2007-06-06 12:13:17.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: cnid_dbd.c,v 1.1.4.18.2.2 2005/02/06 10:16:03 didg Exp $
+ * $Id: cnid_dbd.c,v 1.1.4.18.2.4 2007/06/06 10:13:17 didg Exp $
  *
  * Copyright (C) Joerg Lenneis 2003
  * All Rights Reserved.  See COPYING.
@@ -284,6 +284,7 @@
     struct timeval tv;
     time_t orig, t;
     int silent = 1;
+    int clean = 1; /* no errors so far - to prevent sleep on first try */
     
     if (db->changed) {
         /* volume and db don't have the same timestamp
@@ -330,6 +331,7 @@
                        will log messages if something goes wrong again */
         if (db->fd != -1) {
             close(db->fd);
+            db->fd = -1; /* FD not valid... will need to reconnect */
         }
         time(&t);
         if (t - orig > MAX_DELAY) {
@@ -337,11 +339,14 @@
             return -1;
 	}
 
-        /* sleep a little before retry */
-        db->fd = -1;
-        tv.tv_usec = 0;
-        tv.tv_sec  = 5;
-        select(0, NULL, NULL, NULL, &tv);
+	if (!clean) { /* don't sleep if just got disconnected by cnid server */
+            /* sleep a little before retry */
+            tv.tv_usec = 0;
+            tv.tv_sec  = 5;
+            select(0, NULL, NULL, NULL, &tv); /* sleep for 5 seconds */
+	} else {
+            clean = 0; /* false... next time sleep */
+        }
     }
     return -1;
 }
@@ -375,7 +380,7 @@
 }
 
 /* ---------------------- */
-struct _cnid_db *cnid_dbd_open(const char *dir, mode_t mask)
+struct _cnid_db *cnid_dbd_open(const char *dir, mode_t mask _U_)
 {
     CNID_private *db = NULL;
     struct _cnid_db *cdb = NULL;
@@ -446,8 +451,8 @@
 
 /* ---------------------- */
 cnid_t cnid_dbd_add(struct _cnid_db *cdb, const struct stat *st,
-                const cnid_t did, char *name, const int len,
-                cnid_t hint)
+                const cnid_t did, char *name, const size_t len,
+                cnid_t hint _U_)
 {
     CNID_private *db;
     struct cnid_dbd_rqst rqst;
@@ -479,6 +484,7 @@
     rqst.name = name;
     rqst.namelen = len;
 
+    rply.namelen = 0;
     if (transmit(db, &rqst, &rply) < 0) {
         errno = CNID_ERR_DB;
         return CNID_INVALID;
@@ -504,8 +510,7 @@
 }
 
 /* ---------------------- */
-cnid_t cnid_dbd_get(struct _cnid_db *cdb, const cnid_t did, char *name,
-                const int len)
+cnid_t cnid_dbd_get(struct _cnid_db *cdb, const cnid_t did, char *name, const size_t len)
 {
     CNID_private *db;
     struct cnid_dbd_rqst rqst;
@@ -531,6 +536,7 @@
     rqst.name = name;
     rqst.namelen = len;
 
+    rply.namelen = 0;
     if (transmit(db, &rqst, &rply) < 0) {
         errno = CNID_ERR_DB;
         return CNID_INVALID;
@@ -555,7 +561,7 @@
 }
 
 /* ---------------------- */
-char *cnid_dbd_resolve(struct _cnid_db *cdb, cnid_t *id, void *buffer, u_int32_t len)
+char *cnid_dbd_resolve(struct _cnid_db *cdb, cnid_t *id, void *buffer, size_t len)
 {
     CNID_private *db;
     struct cnid_dbd_rqst rqst;
@@ -630,7 +636,7 @@
 }
 
 /* ---------------------- */
-int cnid_dbd_getstamp(struct _cnid_db *cdb, void *buffer, const int len)
+int cnid_dbd_getstamp(struct _cnid_db *cdb, void *buffer, const size_t len)
 {
     CNID_private *db;
     int ret;
@@ -650,7 +656,7 @@
 
 /* ---------------------- */
 cnid_t cnid_dbd_lookup(struct _cnid_db *cdb, const struct stat *st, const cnid_t did,
-                   char *name, const int len)
+                   char *name, const size_t len)
 {
     CNID_private *db;
     struct cnid_dbd_rqst rqst;
@@ -682,6 +688,7 @@
     rqst.name = name;
     rqst.namelen = len;
 
+    rply.namelen = 0;
     if (transmit(db, &rqst, &rply) < 0) {
         errno = CNID_ERR_DB;
         return CNID_INVALID;
@@ -707,7 +714,7 @@
 
 /* ---------------------- */
 int cnid_dbd_update(struct _cnid_db *cdb, const cnid_t id, const struct stat *st,
-                const cnid_t did, char *name, const int len)
+                const cnid_t did, char *name, const size_t len)
 {
     CNID_private *db;
     struct cnid_dbd_rqst rqst;
@@ -738,6 +745,7 @@
     rqst.name = name;
     rqst.namelen = len;
 
+    rply.namelen = 0;
     if (transmit(db, &rqst, &rply) < 0) {
         errno = CNID_ERR_DB;
         return -1;
@@ -773,6 +781,7 @@
     rqst.op = CNID_DBD_OP_DELETE;
     rqst.cnid = id;
 
+    rply.namelen = 0;
     if (transmit(db, &rqst, &rply) < 0) {
         errno = CNID_ERR_DB;
         return -1;
@@ -790,6 +799,7 @@
     }
 }
 
+
 struct _cnid_module cnid_dbd_module = {
     "dbd",
     {NULL, NULL},
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/cnid/dbd/cnid_dbd.h netatalk/libatalk/cnid/dbd/cnid_dbd.h
--- netatalk.orig/libatalk/cnid/dbd/cnid_dbd.h	2005-01-30 21:56:23.000000000 +0100
+++ netatalk/libatalk/cnid/dbd/cnid_dbd.h	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: cnid_dbd.h,v 1.1.4.3.2.1 2005/01/30 20:56:23 didg Exp $
+ * $Id: cnid_dbd.h,v 1.1.4.3.2.2 2005/09/27 10:40:41 didg Exp $
  *
  * Copyright (C) Joerg Lenneis 2003
  * All Rights Reserved.  See COPYING.
@@ -21,14 +21,14 @@
 extern struct _cnid_db *cnid_dbd_open __P((const char *, mode_t));
 extern void cnid_dbd_close __P((struct _cnid_db *));
 extern cnid_t cnid_dbd_add __P((struct _cnid_db *, const struct stat *, const cnid_t,
-			    char *, const int, cnid_t));
-extern cnid_t cnid_dbd_get __P((struct _cnid_db *, const cnid_t, char *, const int)); 
-extern char *cnid_dbd_resolve __P((struct _cnid_db *, cnid_t *, void *, u_int32_t )); 
-extern int cnid_dbd_getstamp __P((struct _cnid_db *, void *, const int )); 
+			    char *, const size_t, cnid_t));
+extern cnid_t cnid_dbd_get __P((struct _cnid_db *, const cnid_t, char *, const size_t)); 
+extern char *cnid_dbd_resolve __P((struct _cnid_db *, cnid_t *, void *, size_t )); 
+extern int cnid_dbd_getstamp __P((struct _cnid_db *, void *, const size_t )); 
 extern cnid_t cnid_dbd_lookup __P((struct _cnid_db *, const struct stat *, const cnid_t,
-			       char *, const int));
+			       char *, const size_t));
 extern int cnid_dbd_update __P((struct _cnid_db *, const cnid_t, const struct stat *,
-			    const cnid_t, char *, int));
+			    const cnid_t, char *, size_t));
 extern int cnid_dbd_delete __P((struct _cnid_db *, const cnid_t));
 
 #endif /* include/atalk/cnid_dbd.h */
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/cnid/last/cnid_last.c netatalk/libatalk/cnid/last/cnid_last.c
--- netatalk.orig/libatalk/cnid/last/cnid_last.c	2005-02-06 11:16:03.000000000 +0100
+++ netatalk/libatalk/cnid/last/cnid_last.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,6 +1,6 @@
 
 /*
- * $Id: cnid_last.c,v 1.1.4.1.2.2 2005/02/06 10:16:03 didg Exp $
+ * $Id: cnid_last.c,v 1.1.4.1.2.3 2005/09/27 10:40:41 didg Exp $
  *
  * Copyright (c) 1999. Adrian Sun (asun@zoology.washington.edu)
  * All Rights Reserved. See COPYRIGHT.
@@ -23,7 +23,7 @@
 
 /* ------------------------ */
 cnid_t cnid_last_add(struct _cnid_db *cdb, const struct stat *st,
-                     const cnid_t did, char *name, const int len, cnid_t hint)
+                     const cnid_t did _U_, char *name _U_, const size_t len _U_, cnid_t hint _U_)
 {
 
     /* FIXME: it relies on fact, that this is never called twice for the same file/dir. */
@@ -80,7 +80,7 @@
 
 
 
-int cnid_last_delete(struct _cnid_db *cdb, const cnid_t id)
+int cnid_last_delete(struct _cnid_db *cdb _U_, const cnid_t id _U_)
 {
     return CNID_INVALID;
 }
@@ -88,7 +88,7 @@
 
 
 /* Return CNID for a given did/name. */
-cnid_t cnid_last_get(struct _cnid_db *cdb, const cnid_t did, char *name, const int len)
+cnid_t cnid_last_get(struct _cnid_db *cdb _U_, const cnid_t did _U_, char *name _U_, const size_t len _U_)
 {
     /* FIXME: it relies on fact, that this is never called twice for the same file/dir. */
     /* Propably we should look through DID tree. */
@@ -98,7 +98,8 @@
 
 
 /* */
-cnid_t cnid_last_lookup(struct _cnid_db *cdb, const struct stat *st, const cnid_t did, char *name, const int len)
+cnid_t cnid_last_lookup(struct _cnid_db *cdb _U_, const struct stat *st _U_, const cnid_t did _U_, 
+    char *name _U_, const size_t len _U_)
 {
     /* FIXME: this function doesn't work in [last] scheme ! */
     /* Should be never called or CNID should be somewhat refactored again. */
@@ -143,7 +144,7 @@
     return cdb;
 }
 
-struct _cnid_db *cnid_last_open(const char *dir, mode_t mask)
+struct _cnid_db *cnid_last_open(const char *dir, mode_t mask _U_)
 {
     struct _cnid_db *cdb;
 
@@ -167,16 +168,15 @@
 };
 
 /* Return the did/name pair corresponding to a CNID. */
-char *cnid_last_resolve(struct _cnid_db *cdb, cnid_t * id, void *buffer, u_int32_t len)
+char *cnid_last_resolve(struct _cnid_db *cdb _U_, cnid_t * id _U_, void *buffer _U_, size_t len _U_)
 {
     /* FIXME: frankly, it does not work. As get, add and other functions. */
     return NULL;
 }
 
 
-int cnid_last_update(struct _cnid_db *cdb, const cnid_t id, const struct stat *st,
-                     const cnid_t did, char *name, const int len
-                     /*, const char *info, const int infolen */ )
+int cnid_last_update(struct _cnid_db *cdb _U_, const cnid_t id _U_, const struct stat *st _U_,
+                     const cnid_t did  _U_, char *name  _U_, const size_t len _U_)
 {
     return 0;
 }
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/cnid/last/cnid_last.h netatalk/libatalk/cnid/last/cnid_last.h
--- netatalk.orig/libatalk/cnid/last/cnid_last.h	2005-01-30 21:56:23.000000000 +0100
+++ netatalk/libatalk/cnid/last/cnid_last.h	2005-09-27 12:40:41.000000000 +0200
@@ -23,12 +23,12 @@
 extern struct _cnid_db *cnid_last_open __P((const char *, mode_t));
 extern void cnid_last_close __P((struct _cnid_db *));
 extern cnid_t cnid_last_add __P((struct _cnid_db *, const struct stat *, const cnid_t,
-                                 char *, const int, cnid_t));
-extern cnid_t cnid_last_get __P((struct _cnid_db *, const cnid_t, char *, const int));
-extern char *cnid_last_resolve __P((struct _cnid_db *, cnid_t *, void *, u_int32_t));
-extern cnid_t cnid_last_lookup __P((struct _cnid_db *, const struct stat *, const cnid_t, char *, const int));
+                                 char *, const size_t, cnid_t));
+extern cnid_t cnid_last_get __P((struct _cnid_db *, const cnid_t, char *, const size_t));
+extern char *cnid_last_resolve __P((struct _cnid_db *, cnid_t *, void *, size_t));
+extern cnid_t cnid_last_lookup __P((struct _cnid_db *, const struct stat *, const cnid_t, char *, const size_t));
 extern int cnid_last_update __P((struct _cnid_db *, const cnid_t, const struct stat *,
-                                 const cnid_t, char *, int));
+                                 const cnid_t, char *, size_t));
 extern int cnid_last_delete __P((struct _cnid_db *, const cnid_t));
 
 #endif /* include/atalk/cnid_last.h */
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/cnid/tdb/cnid_tdb_add.c netatalk/libatalk/cnid/tdb/cnid_tdb_add.c
--- netatalk.orig/libatalk/cnid/tdb/cnid_tdb_add.c	2005-01-31 18:01:16.000000000 +0100
+++ netatalk/libatalk/cnid/tdb/cnid_tdb_add.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: cnid_tdb_add.c,v 1.1.2.1.2.2 2005/01/31 17:01:16 didg Exp $
+ * $Id: cnid_tdb_add.c,v 1.1.2.1.2.3 2005/09/27 10:40:41 didg Exp $
  *
  * Copyright (c) 1999. Adrian Sun (asun@zoology.washington.edu)
  * All Rights Reserved. See COPYRIGHT.
@@ -103,7 +103,7 @@
 
 /* ------------------------ */
 cnid_t cnid_tdb_add(struct _cnid_db *cdb, const struct stat *st,
-                     const cnid_t did, char *name, const int len, cnid_t hint)
+                     const cnid_t did, char *name, const size_t len, cnid_t hint)
 {
     const struct stat *lstp;
     cnid_t id;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/cnid/tdb/cnid_tdb_get.c netatalk/libatalk/cnid/tdb/cnid_tdb_get.c
--- netatalk.orig/libatalk/cnid/tdb/cnid_tdb_get.c	2005-01-30 21:56:23.000000000 +0100
+++ netatalk/libatalk/cnid/tdb/cnid_tdb_get.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: cnid_tdb_get.c,v 1.1.2.1.2.1 2005/01/30 20:56:23 didg Exp $
+ * $Id: cnid_tdb_get.c,v 1.1.2.1.2.2 2005/09/27 10:40:41 didg Exp $
  */
 
 #ifdef HAVE_CONFIG_H
@@ -11,7 +11,7 @@
 #include "cnid_tdb.h"
 
 /* Return CNID for a given did/name. */
-cnid_t cnid_tdb_get(struct _cnid_db *cdb, const cnid_t did, char *name, const int len)
+cnid_t cnid_tdb_get(struct _cnid_db *cdb, const cnid_t did, char *name, const size_t len)
 {
     char start[TDB_DID_LEN + MAXPATHLEN + 1], *buf;
     struct _cnid_tdb_private *db;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/cnid/tdb/cnid_tdb.h netatalk/libatalk/cnid/tdb/cnid_tdb.h
--- netatalk.orig/libatalk/cnid/tdb/cnid_tdb.h	2005-01-30 21:56:23.000000000 +0100
+++ netatalk/libatalk/cnid/tdb/cnid_tdb.h	2005-09-27 12:40:41.000000000 +0200
@@ -70,16 +70,16 @@
 
 /* cnid_add.c */
 extern cnid_t cnid_tdb_add __P((struct _cnid_db *, const struct stat *, const cnid_t,
-                                 char *, const int, cnid_t));
+                                 char *, const size_t, cnid_t));
 
 /* cnid_get.c */
-extern cnid_t cnid_tdb_get __P((struct _cnid_db *, const cnid_t, char *, const int));
-extern char *cnid_tdb_resolve __P((struct _cnid_db *, cnid_t *, void *, u_int32_t));
-extern cnid_t cnid_tdb_lookup __P((struct _cnid_db *, const struct stat *, const cnid_t, char *, const int));
+extern cnid_t cnid_tdb_get __P((struct _cnid_db *, const cnid_t, char *, const size_t));
+extern char *cnid_tdb_resolve __P((struct _cnid_db *, cnid_t *, void *, size_t));
+extern cnid_t cnid_tdb_lookup __P((struct _cnid_db *, const struct stat *, const cnid_t, char *, const size_t));
 
 /* cnid_update.c */
 extern int cnid_tdb_update __P((struct _cnid_db *, const cnid_t, const struct stat *,
-                                 const cnid_t, char *, int));
+                                 const cnid_t, char *, size_t));
 
 /* cnid_delete.c */
 extern int cnid_tdb_delete __P((struct _cnid_db *, const cnid_t));
@@ -90,7 +90,7 @@
 /* construct db_cnid data. NOTE: this is not re-entrant.  */
 static __inline__ char *make_tdb_data(const struct stat *st,
                                        const cnid_t did,
-                                       const char *name, const int len)
+                                       const char *name, const size_t len)
 {
     static char start[TDB_HEADER_LEN + MAXPATHLEN + 1];
     char *buf = start;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/cnid/tdb/cnid_tdb_lookup.c netatalk/libatalk/cnid/tdb/cnid_tdb_lookup.c
--- netatalk.orig/libatalk/cnid/tdb/cnid_tdb_lookup.c	2005-01-30 21:56:23.000000000 +0100
+++ netatalk/libatalk/cnid/tdb/cnid_tdb_lookup.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: cnid_tdb_lookup.c,v 1.1.2.1.2.1 2005/01/30 20:56:23 didg Exp $
+ * $Id: cnid_tdb_lookup.c,v 1.1.2.1.2.2 2005/09/27 10:40:41 didg Exp $
  */
 
 #ifdef HAVE_CONFIG_H
@@ -11,7 +11,7 @@
 #include "cnid_tdb.h"
 #include <atalk/logger.h>
 
-cnid_t cnid_tdb_lookup(struct _cnid_db *cdb, const struct stat *st, const cnid_t did, char *name, const int len)
+cnid_t cnid_tdb_lookup(struct _cnid_db *cdb, const struct stat *st, const cnid_t did, char *name, const size_t len)
 {
     char *buf;
     struct _cnid_tdb_private *db;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/cnid/tdb/cnid_tdb_update.c netatalk/libatalk/cnid/tdb/cnid_tdb_update.c
--- netatalk.orig/libatalk/cnid/tdb/cnid_tdb_update.c	2005-01-30 21:56:23.000000000 +0100
+++ netatalk/libatalk/cnid/tdb/cnid_tdb_update.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: cnid_tdb_update.c,v 1.1.2.1.2.1 2005/01/30 20:56:23 didg Exp $
+ * $Id: cnid_tdb_update.c,v 1.1.2.1.2.2 2005/09/27 10:40:41 didg Exp $
  */
 
 #ifdef HAVE_CONFIG_H
@@ -12,7 +12,7 @@
 #include <atalk/logger.h>
 
 int cnid_tdb_update(struct _cnid_db *cdb, const cnid_t id, const struct stat *st,
-                     const cnid_t did, char *name, const int len
+                     const cnid_t did, char *name, const size_t len
                      /*, const char *info, const int infolen */ )
 {
     struct _cnid_tdb_private *db;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/dsi/dsi_getstat.c netatalk/libatalk/dsi/dsi_getstat.c
--- netatalk.orig/libatalk/dsi/dsi_getstat.c	2001-06-29 16:14:46.000000000 +0200
+++ netatalk/libatalk/dsi/dsi_getstat.c	2005-09-12 18:10:19.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: dsi_getstat.c,v 1.3 2001/06/29 14:14:46 rufustfirefly Exp $
+ * $Id: dsi_getstat.c,v 1.3.16.1 2005/09/12 16:10:19 didg Exp $
  *
  * Copyright (c) 1997 Adrian Sun (asun@zoology.washington.edu)
  * All rights reserved. See COPYRIGHT.
@@ -21,6 +21,7 @@
 {
   dsi->header.dsi_flags = DSIFL_REPLY;
   /*dsi->header.dsi_command = DSIFUNC_STAT;*/
+  dsi->header.dsi_code = dsi->header.dsi_reserved = 0;
   
   memcpy(dsi->commands, dsi->status, dsi->statuslen);
   dsi->cmdlen = dsi->statuslen; 
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/dsi/dsi_init.c netatalk/libatalk/dsi/dsi_init.c
--- netatalk.orig/libatalk/dsi/dsi_init.c	2004-04-28 00:45:37.000000000 +0200
+++ netatalk/libatalk/dsi/dsi_init.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: dsi_init.c,v 1.3.14.1 2004/04/27 22:45:37 didg Exp $
+ * $Id: dsi_init.c,v 1.3.14.1.2.1 2005/09/27 10:40:41 didg Exp $
  *
  * Copyright (c) 1997 Adrian Sun (asun@zoology.washington.edu)
  * All rights reserved. See COPYRIGHT.
@@ -55,7 +55,7 @@
     return dsi;
 }
 
-void dsi_setstatus(DSI *dsi, u_int8_t *status, const int slen)
+void dsi_setstatus(DSI *dsi, char *status, const size_t slen)
 {
     dsi->status = status;
     dsi->statuslen = slen;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/dsi/dsi_opensess.c netatalk/libatalk/dsi/dsi_opensess.c
--- netatalk.orig/libatalk/dsi/dsi_opensess.c	2001-06-29 16:14:46.000000000 +0200
+++ netatalk/libatalk/dsi/dsi_opensess.c	2005-09-12 18:10:20.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: dsi_opensess.c,v 1.3 2001/06/29 14:14:46 rufustfirefly Exp $
+ * $Id: dsi_opensess.c,v 1.3.16.1 2005/09/12 16:10:20 didg Exp $
  *
  * Copyright (c) 1997 Adrian Sun (asun@zoology.washington.edu)
  * All rights reserved. See COPYRIGHT.
@@ -37,6 +37,7 @@
   /* let the client know the server quantum. we don't use the
    * max server quantum due to a bug in appleshare client 3.8.6. */
   dsi->header.dsi_flags = DSIFL_REPLY;
+  dsi->header.dsi_code = 0;
   /* dsi->header.dsi_command = DSIFUNC_OPEN;*/
   dsi->cmdlen = 2 + sizeof(i); /* length of data. dsi_send uses it. */
   dsi->commands[0] = DSIOPT_SERVQUANT;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/dsi/dsi_stream.c netatalk/libatalk/dsi/dsi_stream.c
--- netatalk.orig/libatalk/dsi/dsi_stream.c	2005-01-31 20:50:53.000000000 +0100
+++ netatalk/libatalk/dsi/dsi_stream.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: dsi_stream.c,v 1.11.6.5.2.1 2005/01/31 19:50:53 didg Exp $
+ * $Id: dsi_stream.c,v 1.11.6.5.2.2 2005/09/27 10:40:41 didg Exp $
  *
  * Copyright (c) 1998 Adrian Sun (asun@zoology.washington.edu)
  * All rights reserved. See COPYRIGHT.
@@ -112,7 +112,7 @@
  * write raw data. return actual bytes read. checks against EINTR
  * aren't necessary if all of the signals have SA_RESTART
  * specified. */
-size_t dsi_stream_write(DSI *dsi, void *data, const size_t length, int mode)
+size_t dsi_stream_write(DSI *dsi, void *data, const size_t length, int mode _U_)
 {
   size_t written;
   ssize_t len;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/dsi/dsi_tcp.c netatalk/libatalk/dsi/dsi_tcp.c
--- netatalk.orig/libatalk/dsi/dsi_tcp.c	2005-01-12 00:00:42.000000000 +0100
+++ netatalk/libatalk/dsi/dsi_tcp.c	2007-03-17 15:44:36.000000000 +0100
@@ -1,5 +1,5 @@
 /*
- * $Id: dsi_tcp.c,v 1.9.10.7.2.1 2005/01/11 23:00:42 didg Exp $
+ * $Id: dsi_tcp.c,v 1.9.10.7.2.3 2007/03/17 14:44:36 didg Exp $
  *
  * Copyright (c) 1997, 1998 Adrian Sun (asun@zoology.washington.edu)
  * All rights reserved. See COPYRIGHT.
@@ -297,7 +297,7 @@
       }
   }
   else {
-      if (((struct in_addr *) host->h_addr)->s_addr != 0x100007F) { /* FIXME ugly check */
+      if (( ((struct in_addr *) host->h_addr)->s_addr & htonl(0x7F000000) ) !=  htonl(0x7F000000)) { /* FIXME ugly check */
           dsi->server.sin_addr.s_addr = ((struct in_addr *) host->h_addr)->s_addr;
           return 1;
       }
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/dsi/dsi_write.c netatalk/libatalk/dsi/dsi_write.c
--- netatalk.orig/libatalk/dsi/dsi_write.c	2004-05-04 16:26:14.000000000 +0200
+++ netatalk/libatalk/dsi/dsi_write.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: dsi_write.c,v 1.3.14.2 2004/05/04 14:26:14 didg Exp $
+ * $Id: dsi_write.c,v 1.3.14.2.2.1 2005/09/27 10:40:41 didg Exp $
  *
  * Copyright (c) 1997 Adrian Sun (asun@zoology.washington.edu)
  * All rights reserved. See COPYRIGHT.
@@ -34,7 +34,7 @@
 /* initialize relevant things for dsi_write. this returns the amount
  * of data in the data buffer. the interface has been reworked to allow
  * for arbitrary buffers. */
-size_t dsi_writeinit(DSI *dsi, void *buf, const size_t buflen)
+size_t dsi_writeinit(DSI *dsi, void *buf, const size_t buflen _U_)
 {
 #ifdef TIMER_ON_READ
   const struct itimerval none = {{0, 0}, {0, 0}};
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/unicode/charcnv.c netatalk/libatalk/unicode/charcnv.c
--- netatalk.orig/libatalk/unicode/charcnv.c	2004-09-07 13:34:40.000000000 +0200
+++ netatalk/libatalk/unicode/charcnv.c	2007-09-17 14:45:28.000000000 +0200
@@ -66,7 +66,7 @@
  */
 
 
-#define MAX_CHARSETS 10
+#define MAX_CHARSETS 20
 
 #define CHECK_FLAGS(a,b) (((a)!=NULL) ? (*(a) & (b)) : 0 )
 
@@ -275,6 +275,28 @@
 }
 
 /**
+ *
+ **/
+static size_t add_null(charset_t to, char *buf, size_t bytesleft, size_t len)
+{
+	/* Terminate the string */
+	if (to == CH_UCS2 && bytesleft >= 2) {
+		buf[len]   = 0;
+		buf[len+1] = 0;
+
+	}
+	else if ( to != CH_UCS2 && bytesleft > 0 )
+		buf[len]   = 0;
+	else {
+		errno = E2BIG;
+ 	        return (size_t)(-1);
+	}
+
+	return len;
+}
+
+ 
+/**
  * Convert string from one encoding to another, making error checking etc
  *
  * @param src pointer to source string (multibyte or singlebyte)
@@ -324,19 +346,9 @@
 		LOG(log_debug, logtype_default,"Conversion error: %s",reason);
 		return (size_t)-1;
 	}
-
+	
 	/* Terminate the string */
-	if (to == CH_UCS2 && destlen-o_len >= 2) {
-		o_save[destlen-o_len]   = 0;
-		o_save[destlen-o_len+1] = 0;
-	}
-	else if ( to != CH_UCS2 && destlen-o_len > 0 )
-		o_save[destlen-o_len] = 0;
-	else {
-		/* FIXME: what should we do here, string *might* be unterminated. E2BIG? */
-	}
-
-	return destlen-o_len;
+	return add_null( to, o_save, o_len, destlen -o_len);
 }
 
 
@@ -700,7 +712,6 @@
 	}
 	
 	free(buffer);
-	dst[len] = 0;
 	return (len);
 }
 
@@ -727,7 +738,6 @@
 	}
 
 	free(buffer);
-	dst[len] = 0;
 	return (len);
 }
 
@@ -783,7 +793,7 @@
 	char* outbuf = (char*)dest;
 	atalk_iconv_t descriptor;
 	atalk_iconv_t descriptor_cap;
-	char *o_save, *s;
+	char *s;
 	char h[MAXPATHLEN];
 	const char *h_buf;
 
@@ -801,7 +811,6 @@
 
 	i_len=srclen;
 	o_len=destlen;
-	o_save=outbuf;
 	
 conversion_loop:
 	if ( flags && (*flags & CONV_UNESCAPEHEX)) {
@@ -999,19 +1008,23 @@
     return destlen -o_len;
 }
 
+/*
+ * FIXME the size is a mess we really need a malloc/free logic
+ *`dest size must be dest_len +2
+*/
 size_t convert_charset ( charset_t from_set, charset_t to_set, charset_t cap_charset, char* src, size_t src_len, char* dest, size_t dest_len, u_int16_t *flags)
 {
 	size_t i_len, o_len;
 	ucs2_t *u;
-	ucs2_t buffer[MAXPATHLEN];
-	ucs2_t buffer2[MAXPATHLEN];
+	ucs2_t buffer[MAXPATHLEN +2];
+	ucs2_t buffer2[MAXPATHLEN +2];
  	int composition = 0;
 	
 	lazy_initialize_conv();
 
 	/* convert from_set to UCS2 */
  	if ((size_t)(-1) == ( o_len = pull_charset_flags( from_set, cap_charset, src, src_len, 
-                                                          (char *) buffer, sizeof(buffer), flags)) ) {
+                                                          (char *) buffer, sizeof(buffer) -2, flags)) ) {
 		LOG(log_error, logtype_default, "Conversion failed ( %s to CH_UCS2 )", charset_name(from_set));
 		return (size_t) -1;
 	}
@@ -1027,7 +1040,7 @@
  	if (CHECK_FLAGS(flags, CONV_DECOMPOSE) || (charsets[to_set] && charsets[to_set]->flags & CHARSET_DECOMPOSED) )
  	    composition = 2;
  
-	i_len = sizeof(buffer2);
+	i_len = sizeof(buffer2) -2;
 	u = buffer2;
 
 	switch (composition) {
@@ -1044,6 +1057,9 @@
  	        return (size_t)(-1);
 	    break;
 	}
+	/* null terminate */
+	u[i_len] = 0;
+	u[i_len +1] = 0;
 		
   	/* Do case conversions */	
  	if (CHECK_FLAGS(flags, CONV_TOUPPER)) {
@@ -1059,6 +1075,9 @@
 		       "Conversion failed (CH_UCS2 to %s):%s", charset_name(to_set), strerror(errno));
 		return (size_t) -1;
 	}
+	/* null terminate */
+	dest[o_len] = 0;
+	dest[o_len +1] = 0;
 
 	return o_len;
 }
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/unicode/charsets/generic_mb.c netatalk/libatalk/unicode/charsets/generic_mb.c
--- netatalk.orig/libatalk/unicode/charsets/generic_mb.c	2003-11-15 00:41:05.000000000 +0100
+++ netatalk/libatalk/unicode/charsets/generic_mb.c	2005-09-27 12:40:41.000000000 +0200
@@ -42,8 +42,8 @@
 
 /* ------------------------ */
 
-size_t mb_generic_push( int (*char_func)(unsigned char *, ucs2_t), void *cd, char **inbuf, size_t *inbytesleft,
-                         char **outbuf, size_t *outbytesleft)
+size_t mb_generic_push( int (*char_func)(unsigned char *, ucs2_t), void *cd _U_, char **inbuf, 
+			size_t *inbytesleft, char **outbuf, size_t *outbytesleft)
 {
         int len = 0;
 	unsigned char *tmpptr = (unsigned char *) *outbuf;
@@ -76,8 +76,8 @@
 
 /* ------------------------ */
 
-size_t mb_generic_pull ( int (*char_func)(ucs2_t *, const unsigned char *), void *cd, char **inbuf, size_t *inbytesleft,
-                         char **outbuf, size_t *outbytesleft)
+size_t mb_generic_pull ( int (*char_func)(ucs2_t *, const unsigned char *), void *cd _U_, 
+			char **inbuf, size_t *inbytesleft,char **outbuf, size_t *outbytesleft)
 {
 	ucs2_t 		temp;
 	unsigned char	*inptr;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/unicode/charsets/mac_greek.c netatalk/libatalk/unicode/charsets/mac_greek.c
--- netatalk.orig/libatalk/unicode/charsets/mac_greek.c	1970-01-01 01:00:00.000000000 +0100
+++ netatalk/libatalk/unicode/charsets/mac_greek.c	2006-07-20 00:09:34.000000000 +0200
@@ -0,0 +1,110 @@
+/* 
+   Unix SMB/CIFS implementation.
+   minimal iconv implementation
+   Copyright (C) Andrew Tridgell 2001
+   Copyright (C) Jelmer Vernooij 2002,2003
+   Copyright (C) Panos Christeas 2006
+   
+   This program is free software; you can redistribute it and/or modify
+   it under the terms of the GNU General Public License as published by
+   the Free Software Foundation; either version 2 of the License, or
+   (at your option) any later version.
+   
+   This program is distributed in the hope that it will be useful,
+   but WITHOUT ANY WARRANTY; without even the implied warranty of
+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+   GNU General Public License for more details.
+   
+   You should have received a copy of the GNU General Public License
+   along with this program; if not, write to the Free Software
+   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
+   
+   From samba 3.0 beta and GNU libiconv-1.8
+   It's bad but most of the time we can't use libc iconv service:
+   - it doesn't round trip for most encoding
+   - it doesn't know about Apple extension
+
+*/
+
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif /* HAVE_CONFIG_H */
+#include <stdlib.h>
+#include <netatalk/endian.h>
+#include <atalk/unicode.h>
+
+#include "mac_greek.h"
+#include "generic_mb.h"
+
+static size_t   mac_greek_pull(void *,char **, size_t *, char **, size_t *);
+static size_t   mac_greek_push(void *,char **, size_t *, char **, size_t *);
+
+struct charset_functions charset_mac_greek =
+{
+	"MAC_GREEK",
+	6,
+	mac_greek_pull,
+	mac_greek_push,
+	CHARSET_CLIENT | CHARSET_MULTIBYTE,
+	NULL, NULL
+};
+
+/* ------------------------ */
+static int
+char_ucs2_to_mac_greek ( unsigned char *r, ucs2_t wc)
+{
+  unsigned char c = 0;
+  if (wc < 0x0080) {
+    *r = wc;
+    return 1;
+  }
+  else if (wc >= 0x00a0 && wc < 0x0100)
+    c = mac_greek_page00[wc-0x00a0];
+  else if (wc == 0x0153)
+    c = 0xcf;
+  else if (wc >= 0x0380 && wc < 0x03d0)
+    c = mac_greek_page03[wc-0x0380];
+  else if (wc >= 0x2010 && wc < 0x2038)
+    c = mac_greek_page20[wc-0x2010];
+  else if (wc == 0x2122)
+    c = 0x93;
+  else if (wc >= 0x2248 && wc < 0x2268)
+    c = mac_greek_page22[wc-0x2248];
+  if (c != 0) {
+    *r = c;
+    return 1;
+  }
+ return 0;
+ }
+
+static size_t mac_greek_push( void *cd, char **inbuf, size_t *inbytesleft,
+                         char **outbuf, size_t *outbytesleft)
+{
+	/* No special handling required */
+	return (size_t) mb_generic_push( char_ucs2_to_mac_greek, cd, inbuf, inbytesleft, outbuf, outbytesleft);
+}
+
+/* ------------------------ */
+static int
+char_mac_greek_to_ucs2 (ucs2_t *pwc, const unsigned char *s)
+{
+  unsigned char c = *s;
+  if (c < 0x80) {
+    *pwc = (ucs2_t) c;
+    return 1;
+  }
+  else {
+    unsigned short wc = mac_greek_2uni[c-0x80];
+    if (wc != 0xfffd) {
+      *pwc = (ucs2_t) wc;
+      return 1;
+    }
+  }
+  return 0;
+}
+
+static size_t mac_greek_pull ( void *cd, char **inbuf, size_t *inbytesleft,
+                         char **outbuf, size_t *outbytesleft)
+{
+	return (size_t) mb_generic_pull( char_mac_greek_to_ucs2, cd, inbuf, inbytesleft, outbuf, outbytesleft);
+}
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/unicode/charsets/mac_greek.h netatalk/libatalk/unicode/charsets/mac_greek.h
--- netatalk.orig/libatalk/unicode/charsets/mac_greek.h	1970-01-01 01:00:00.000000000 +0100
+++ netatalk/libatalk/unicode/charsets/mac_greek.h	2006-07-20 00:09:34.000000000 +0200
@@ -0,0 +1,91 @@
+/*
+ * Copyright (C) 1999-2001 Free Software Foundation, Inc.
+ * This file is part of the GNU LIBICONV Library.
+ *
+ * The GNU LIBICONV Library is free software; you can redistribute it
+ * and/or modify it under the terms of the GNU Library General Public
+ * License as published by the Free Software Foundation; either version 2
+ * of the License, or (at your option) any later version.
+ *
+ * The GNU LIBICONV Library is distributed in the hope that it will be
+ * useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ * Library General Public License for more details.
+ *
+ * You should have received a copy of the GNU Library General Public
+ * License along with the GNU LIBICONV Library; see the file COPYING.LIB.
+ * If not, write to the Free Software Foundation, Inc., 59 Temple Place -
+ * Suite 330, Boston, MA 02111-1307, USA.
+ */
+
+/*
+ * MacGreek
+ */
+
+static const unsigned short mac_greek_2uni[128] = {
+  /* 0x80 */
+  0x00c4, 0x00b9, 0x00b2, 0x00c9, 0x00b3, 0x00d6, 0x00dc, 0x0385,
+  0x00e0, 0x00e2, 0x00e4, 0x0384, 0x00a8, 0x00e7, 0x00e9, 0x00e8,
+  /* 0x90 */
+  0x00ea, 0x00eb, 0x00a3, 0x2122, 0x00ee, 0x00ef, 0x2022, 0x00bd,
+  0x2030, 0x00f4, 0x00f6, 0x00a6, 0x00ad, 0x00f9, 0x00fb, 0x00fc,
+  /* 0xa0 */
+  0x2020, 0x0393, 0x0394, 0x0398, 0x039b, 0x039e, 0x03a0, 0x00df,
+  0x00ae, 0x00a9, 0x03a3, 0x03aa, 0x00a7, 0x2260, 0x00b0, 0x0387,
+  /* 0xb0 */
+  0x0391, 0x00b1, 0x2264, 0x2265, 0x00a5, 0x0392, 0x0395, 0x0396,
+  0x0397, 0x0399, 0x039a, 0x039c, 0x03a6, 0x03ab, 0x03a8, 0x03a9,
+  /* 0xc0 */
+  0x03ac, 0x039d, 0x00ac, 0x039f, 0x03a1, 0x2248, 0x03a4, 0x00ab,
+  0x00bb, 0x2026, 0x00a0, 0x03a5, 0x03a7, 0x0386, 0x0388, 0x0153,
+  /* 0xd0 */
+  0x2013, 0x2015, 0x201c, 0x201d, 0x2018, 0x2019, 0x00f7, 0x0389,
+  0x038a, 0x038c, 0x038e, 0x03ad, 0x03ae, 0x03af, 0x03cc, 0x038f,
+  /* 0xe0 */
+  0x03cd, 0x03b1, 0x03b2, 0x03c8, 0x03b4, 0x03b5, 0x03c6, 0x03b3,
+  0x03b7, 0x03b9, 0x03be, 0x03ba, 0x03bb, 0x03bc, 0x03bd, 0x03bf,
+  /* 0xf0 */
+  0x03c0, 0x03ce, 0x03c1, 0x03c3, 0x03c4, 0x03b8, 0x03c9, 0x03c2,
+  0x03c7, 0x03c5, 0x03b6, 0x03ca, 0x03cb, 0x0390, 0x03b0, 0xfffd,
+};
+
+static const unsigned char mac_greek_page00[96] = {
+  0xca, 0x00, 0x00, 0x92, 0x00, 0xb4, 0x9b, 0xac, /* 0xa0-0xa7 */
+  0x8c, 0xa9, 0x00, 0xc7, 0xc2, 0x9c, 0xa8, 0x00, /* 0xa8-0xaf */
+  0xae, 0xb1, 0x82, 0x84, 0x00, 0x00, 0x00, 0x00, /* 0xb0-0xb7 */
+  0x00, 0x81, 0x00, 0xc8, 0x00, 0x97, 0x00, 0x00, /* 0xb8-0xbf */
+  0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, /* 0xc0-0xc7 */
+  0x00, 0x83, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0xc8-0xcf */
+  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x85, 0x00, /* 0xd0-0xd7 */
+  0x00, 0x00, 0x00, 0x00, 0x86, 0x00, 0x00, 0xa7, /* 0xd8-0xdf */
+  0x88, 0x00, 0x89, 0x00, 0x8a, 0x00, 0x00, 0x8d, /* 0xe0-0xe7 */
+  0x8f, 0x8e, 0x90, 0x91, 0x00, 0x00, 0x94, 0x95, /* 0xe8-0xef */
+  0x00, 0x00, 0x00, 0x00, 0x99, 0x00, 0x9a, 0xd6, /* 0xf0-0xf7 */
+  0x00, 0x9d, 0x00, 0x9e, 0x9f, 0x00, 0x00, 0x00, /* 0xf8-0xff */
+};
+static const unsigned char mac_greek_page03[80] = {
+  0x00, 0x00, 0x00, 0x00, 0x8b, 0x87, 0xcd, 0xaf, /* 0x80-0x87 */
+  0xce, 0xd7, 0xd8, 0x00, 0xd9, 0x00, 0xda, 0xdf, /* 0x88-0x8f */
+  0xfd, 0xb0, 0xb5, 0xa1, 0xa2, 0xb6, 0xb7, 0xb8, /* 0x90-0x97 */
+  0xa3, 0xb9, 0xba, 0xa4, 0xbb, 0xc1, 0xa5, 0xc3, /* 0x98-0x9f */
+  0xa6, 0xc4, 0x00, 0xaa, 0xc6, 0xcb, 0xbc, 0xcc, /* 0xa0-0xa7 */
+  0xbe, 0xbf, 0xab, 0xbd, 0xc0, 0xdb, 0xdc, 0xdd, /* 0xa8-0xaf */
+  0xfe, 0xe1, 0xe2, 0xe7, 0xe4, 0xe5, 0xfa, 0xe8, /* 0xb0-0xb7 */
+  0xf5, 0xe9, 0xeb, 0xec, 0xed, 0xee, 0xea, 0xef, /* 0xb8-0xbf */
+  0xf0, 0xf2, 0xf7, 0xf3, 0xf4, 0xf9, 0xe6, 0xf8, /* 0xc0-0xc7 */
+  0xe3, 0xf6, 0xfb, 0xfc, 0xde, 0xe0, 0xf1, 0x00, /* 0xc8-0xcf */
+};
+static const unsigned char mac_greek_page20[40] = {
+  0x00, 0x00, 0x00, 0xd0, 0x00, 0xd1, 0x00, 0x00, /* 0x10-0x17 */
+  0xd4, 0xd5, 0x00, 0x00, 0xd2, 0xd3, 0x00, 0x00, /* 0x18-0x1f */
+  0xa0, 0x00, 0x96, 0x00, 0x00, 0x00, 0xc9, 0x00, /* 0x20-0x27 */
+  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0x28-0x2f */
+  0x98, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0x30-0x37 */
+};
+static const unsigned char mac_greek_page22[32] = {
+  0xc5, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0x48-0x4f */
+  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0x50-0x57 */
+  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* 0x58-0x5f */
+  0xad, 0x00, 0x00, 0x00, 0xb2, 0xb3, 0x00, 0x00, /* 0x60-0x67 */
+};
+
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/unicode/charsets/mac_hebrew.c netatalk/libatalk/unicode/charsets/mac_hebrew.c
--- netatalk.orig/libatalk/unicode/charsets/mac_hebrew.c	2005-02-06 11:16:03.000000000 +0100
+++ netatalk/libatalk/unicode/charsets/mac_hebrew.c	2005-09-27 12:40:41.000000000 +0200
@@ -80,7 +80,7 @@
     return 0;
 }
 
-static size_t mac_hebrew_push( void *cd, char **inbuf, size_t *inbytesleft,
+static size_t mac_hebrew_push( void *cd _U_, char **inbuf, size_t *inbytesleft,
                          char **outbuf, size_t *outbytesleft)
 {
     unsigned char c = 0;
@@ -152,7 +152,7 @@
 	return 0;
 }
 
-static size_t mac_hebrew_pull ( void *cd, char **inbuf, size_t *inbytesleft,
+static size_t mac_hebrew_pull ( void *cd _U_, char **inbuf, size_t *inbytesleft,
                          char **outbuf, size_t *outbytesleft)
 {
     ucs2_t         temp;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/unicode/charsets/Makefile.am netatalk/libatalk/unicode/charsets/Makefile.am
--- netatalk.orig/libatalk/unicode/charsets/Makefile.am	2003-09-09 18:42:22.000000000 +0200
+++ netatalk/libatalk/unicode/charsets/Makefile.am	2006-07-20 00:09:34.000000000 +0200
@@ -7,6 +7,7 @@
 
 libcharsets_la_SOURCES = \
 	mac_roman.c	\
+	mac_greek.c	\
 	mac_hebrew.c	\
 	mac_centraleurope.c	\
 	mac_turkish.c \
@@ -15,6 +16,7 @@
 
 noinst_HEADERS = \
 	mac_roman.h \
+	mac_greek.h \
 	mac_centraleurope.h \
 	mac_hebrew.h \
 	mac_turkish.h \
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/unicode/iconv.c netatalk/libatalk/unicode/iconv.c
--- netatalk.orig/libatalk/unicode/iconv.c	2005-02-06 11:16:03.000000000 +0100
+++ netatalk/libatalk/unicode/iconv.c	2006-07-20 00:09:34.000000000 +0200
@@ -92,6 +92,7 @@
 extern  struct charset_functions charset_mac_hebrew;
 extern  struct charset_functions charset_mac_centraleurope;
 extern  struct charset_functions charset_mac_cyrillic;
+extern  struct charset_functions charset_mac_greek;
 extern  struct charset_functions charset_mac_turkish;
 extern  struct charset_functions charset_utf8;
 extern  struct charset_functions charset_utf8_mac;
@@ -166,6 +167,7 @@
 		atalk_register_charset(&charset_utf8_mac);
 		atalk_register_charset(&charset_mac_roman);
 		atalk_register_charset(&charset_mac_hebrew);
+		atalk_register_charset(&charset_mac_greek);
 		atalk_register_charset(&charset_mac_turkish);
 		atalk_register_charset(&charset_mac_centraleurope);
 		atalk_register_charset(&charset_mac_cyrillic);
@@ -349,7 +351,7 @@
  the following functions implement the builtin character sets in Netatalk
 *************************************************************************/
 
-static size_t ascii_pull(void *cd, char **inbuf, size_t *inbytesleft,
+static size_t ascii_pull(void *cd _U_, char **inbuf, size_t *inbytesleft,
 			 char **outbuf, size_t *outbytesleft)
 {
 	ucs2_t curchar;
@@ -377,7 +379,7 @@
 	return 0;
 }
 
-static size_t ascii_push(void *cd, char **inbuf, size_t *inbytesleft,
+static size_t ascii_push(void *cd _U_, char **inbuf, size_t *inbytesleft,
 			 char **outbuf, size_t *outbytesleft)
 {
 	int ir_count=0;
@@ -412,7 +414,7 @@
 }
 
 
-static size_t iconv_copy(void *cd, char **inbuf, size_t *inbytesleft,
+static size_t iconv_copy(void *cd _U_, char **inbuf, size_t *inbytesleft,
 			 char **outbuf, size_t *outbytesleft)
 {
 	int n;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/unicode/utf8.c netatalk/libatalk/unicode/utf8.c
--- netatalk.orig/libatalk/unicode/utf8.c	2005-02-06 11:16:03.000000000 +0100
+++ netatalk/libatalk/unicode/utf8.c	2005-09-27 12:40:41.000000000 +0200
@@ -61,7 +61,7 @@
 };
 
 /* ------------------------ */
-static size_t utf8_pull(void *cd, char **inbuf, size_t *inbytesleft,
+static size_t utf8_pull(void *cd _U_, char **inbuf, size_t *inbytesleft,
 			 char **outbuf, size_t *outbytesleft)
 {
 	ucs2_t uc = 0;
@@ -113,7 +113,7 @@
 }
 
 /* ------------------------ */
-static size_t utf8_push(void *cd, char **inbuf, size_t *inbytesleft,
+static size_t utf8_push(void *cd _U_, char **inbuf, size_t *inbytesleft,
 			 char **outbuf, size_t *outbytesleft)
 {
 	ucs2_t uc=0;
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/unicode/util_unistr.c netatalk/libatalk/unicode/util_unistr.c
--- netatalk.orig/libatalk/unicode/util_unistr.c	2004-05-12 23:21:49.000000000 +0200
+++ netatalk/libatalk/unicode/util_unistr.c	2005-07-22 23:50:04.000000000 +0200
@@ -17,6 +17,17 @@
 #include "precompose.h"
 #include "byteorder.h"
 
+#define HANGUL_SBASE 0xAC00
+#define HANGUL_LBASE 0x1100
+#define HANGUL_VBASE 0x1161
+#define HANGUL_TBASE 0x11A7
+#define HANGUL_LCOUNT 19
+#define HANGUL_VCOUNT 21
+#define HANGUL_TCOUNT 28
+#define HANGUL_NCOUNT (HANGUL_VCOUNT * HANGUL_TCOUNT)   /* 588 */
+#define HANGUL_SCOUNT (HANGUL_LCOUNT * HANGUL_NCOUNT)   /* 11172 */
+
+#define MAXCOMBLEN 3
 
 ucs2_t toupper_w(ucs2_t val)
 {
@@ -380,14 +391,23 @@
 	size_t i;
 	ucs2_t base, comb;
 	ucs2_t *in, *out;
+	ucs2_t hangul_lindex, hangul_vindex;
 	ucs2_t result;
 	size_t o_len = *outlen;
 
     	if (!inplen || (inplen & 1) || inplen > o_len)
         	return (size_t)-1;
+	
+	/*   Actually,                                                 */
+	/*   Decomposition and Canonical Ordering are necessary here.  */
+	/*                                                             */
+	/*         Ex. in = CanonicalOrdering(decompose_w(name))       */
+	/*                                                             */
+	/*   A new mapping table is needed for CanonicalOrdering.      */
+	
     	i = 0;
     	in  = name;
-    	out = (ucs2_t *)comp;
+	out = comp;
     
     	base = *in;
     	while (*outlen > 2) {
@@ -401,19 +421,36 @@
            		return o_len - *outlen;
         	}
         	comb = *in;
-        	if (comb >= 0x300 && (result = do_precomposition(base, comb))) {
-           		*out = result;
-           		out++;
-           		*outlen -= 2;
-           		i += 2;
-           		in++;
-           		if (i == inplen) {
-				*out = 0;
-              			return o_len - *outlen;
+		result = 0;
+		
+		/* Non-Combination Character */
+		if (comb < 0x300) ;
+		
+		/* Unicode Standard Annex #15 A10.3 Hangul Composition */
+		/* Step 1 <L,V> */
+		else if ((HANGUL_VBASE <= comb) && (comb <= HANGUL_VBASE + HANGUL_VCOUNT)) {
+			if ((HANGUL_LBASE <= base) && (base < HANGUL_LBASE + HANGUL_LCOUNT)) {
+				result = 1;
+				hangul_lindex = base - HANGUL_LBASE;
+				hangul_vindex = comb - HANGUL_VBASE;
+				base = HANGUL_SBASE + (hangul_lindex * HANGUL_VCOUNT + hangul_vindex) * HANGUL_TCOUNT;
 			}
-           		base = *in;
         	}
-        	else {
+		
+		/* Step 2 <LV,T> */
+		else if ((HANGUL_TBASE < comb) && (comb < HANGUL_TBASE + HANGUL_TCOUNT)) {
+			if ((HANGUL_SBASE <= base) && (base < HANGUL_SBASE +HANGUL_SCOUNT) && (((base - HANGUL_SBASE) % HANGUL_TCOUNT) == 0)) {
+				result = 1;
+				base += comb - HANGUL_TBASE;
+			}
+		}
+		
+		/* Combining Sequence */
+		else if ((result = do_precomposition(base, comb))) {
+			base = result;
+		}
+		
+		if (!result) {
            		*out = base;
            		out++;
            		*outlen -= 2;
@@ -427,10 +464,16 @@
 
 /* --------------- */
 
+/* Singleton Decomposition is unsupported.               */
+/* A new mapping table is needed for implementation.     */
+
 size_t decompose_w (ucs2_t *name, size_t inplen, ucs2_t *comp, size_t *outlen)
 {
 	size_t i;
+	size_t comblen;
 	ucs2_t base;
+	ucs2_t comb[MAXCOMBLEN];
+	ucs2_t hangul_sindex, tjamo;
 	ucs2_t *in, *out;
 	unsigned int result;
 	size_t o_len = *outlen;
@@ -439,42 +482,68 @@
         	return (size_t)-1;
 	i = 0;
 	in  = name;
-	out = (ucs2_t *)comp;
+	out = comp;
     
     	while (i < inplen) {
-        	if (*outlen < 2) {
-			errno = E2BIG;
-            		return (size_t)-1;
-        	}
         	base = *in;
-		if ( (base > 0x1fff && base < 0x3000) || (base > 0xfe2f && base < 0xfe50)) {
-			/* exclude these ranges from decomposition according to AFP 3.1 spec */
-			/* page 97 */
-			*out = base;
-			out++;
-			*outlen -= 2;
+		comblen = 0;
+		
+		/* check ASCII first. this is frequent. */
+		if (base <= 0x007f) ;
+		
+		/* Unicode Standard Annex #15 A10.2 Hangul Decomposition */
+		else if ((HANGUL_SBASE <= base) && (base < HANGUL_SBASE + HANGUL_SCOUNT)) {
+			hangul_sindex = base - HANGUL_SBASE;
+			base = HANGUL_LBASE + hangul_sindex / HANGUL_NCOUNT;
+			comb[MAXCOMBLEN-2] = HANGUL_VBASE + (hangul_sindex % HANGUL_NCOUNT) / HANGUL_TCOUNT;
+			
+			/* <L,V> */
+			if ((tjamo = HANGUL_TBASE + hangul_sindex % HANGUL_TCOUNT) == HANGUL_TBASE) {
+				comb[MAXCOMBLEN-1] = comb[MAXCOMBLEN-2];
+				comblen = 1;
+			}
+			
+			/* <L,V,T> */
+			else {
+				comb[MAXCOMBLEN-1] = tjamo;
+				comblen = 2;
+			}
 		}
-        	else if ((result = do_decomposition(base))) {
-			if ( *outlen < 4 ) {
+		
+		/* Combining Sequence */
+		/* exclude U2000-U2FFF and UFE30-UFE4F ranges      */
+		/* from decomposition according to AFP 3.1 spec    */
+		else if ((base < 0x2000) || ((0x2fff < base) && (base < 0xfe30)) || (0xfe4f < base)) {
+			do {
+				if ((comblen >= MAXCOMBLEN) || !(result = do_decomposition(base))) break;
+				comblen++;
+				base = result  >> 16;
+				comb[MAXCOMBLEN-comblen] = result & 0xffff;
+			} while (((0x007f < base) && (base < 0x2000)) || ((0x2fff < base) && (base < 0xfe30)) || (0xfe4f < base)) ;
+		}
+		
+		if (*outlen < (comblen + 1) << 1) {
 				errno = E2BIG;
 				return (size_t)-1;
 			}
-           		*out = result  >> 16;
+		
+		*out = base;
            		out++;
            		*outlen -= 2;
-           		*out = result & 0xffff;
-           		out++;
-           		*outlen -= 2;
-        	}
-        	else {
-           		*out = base;
+		
+		while ( comblen > 0 ) {
+			*out = comb[MAXCOMBLEN-comblen];
            		out++;
            		*outlen -= 2;
+			comblen--;
         	}
+		
         	i += 2;
         	in++;
      	}
 
+	/* Is Canonical Ordering necessary here? */
+	
 	*out = 0;
 	return o_len-*outlen;
 }
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/libatalk/util/server_ipc.c netatalk/libatalk/util/server_ipc.c
--- netatalk.orig/libatalk/util/server_ipc.c	2004-07-01 03:27:34.000000000 +0200
+++ netatalk/libatalk/util/server_ipc.c	2005-09-27 12:40:41.000000000 +0200
@@ -1,5 +1,5 @@
 /*
- * $Id: server_ipc.c,v 1.1.4.1.2.2 2004/07/01 01:27:34 didg Exp $
+ * $Id: server_ipc.c,v 1.1.4.1.2.2.2.1 2005/09/27 10:40:41 didg Exp $
  *
  * All rights reserved. See COPYRIGHT.
  *
@@ -42,7 +42,7 @@
 }
 
 /* ----------------- */
-int server_ipc_child(void *obj)
+int server_ipc_child(void *obj _U_)
 {
     /* close input */
     close(pipe_fd[0]);
@@ -50,7 +50,7 @@
 }
 
 /* ----------------- */
-int server_ipc_parent(void *obj)
+int server_ipc_parent(void *obj _U_)
 {
     return pipe_fd[0];
 }
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/macros/afs-check.m4 netatalk/macros/afs-check.m4
--- netatalk.orig/macros/afs-check.m4	2003-10-30 00:53:24.000000000 +0100
+++ netatalk/macros/afs-check.m4	2005-08-11 22:14:51.000000000 +0200
@@ -1,4 +1,4 @@
-dnl $Id: afs-check.m4,v 1.2.6.1 2003/10/29 23:53:24 bfernhomberg Exp $
+dnl $Id: afs-check.m4,v 1.2.6.1.2.1 2005/08/11 20:14:51 didg Exp $
 dnl Autoconf macro to check whether AFS support should be enabled
 
 AC_DEFUN([NETATALK_AFS_CHECK], [
@@ -13,7 +13,7 @@
 				AC_CHECK_LIB(afsauthent, pioctl, netatalk_cv_afs=yes,
 					AC_MSG_ERROR([AFS installation not found])
 				)
-				AFS_LIBS=-lafsauthent
+				AFS_LIBS=-lresolv -lafsrpc -lafsauthent 
 				AC_DEFINE(AFS, 1, [Define if AFS should be used])
 			fi
 		]
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/macros/db3-check.m4 netatalk/macros/db3-check.m4
--- netatalk.orig/macros/db3-check.m4	2004-08-11 05:01:11.000000000 +0200
+++ netatalk/macros/db3-check.m4	2006-09-09 03:36:39.000000000 +0200
@@ -1,4 +1,4 @@
-dnl $Id: db3-check.m4,v 1.11.6.9 2004/08/11 03:01:11 bfernhomberg Exp $
+dnl $Id: db3-check.m4,v 1.11.6.9.2.2 2006/09/09 01:36:39 didg Exp $
 dnl Autoconf macros to check for the Berkeley DB library
 
 
@@ -111,7 +111,12 @@
 	CFLAGS="$savedcflags"
 ])
 
-
+dnl I don't understand this stuff below
+dnl AFAIK it works for 4.1 and 4.2 and (4.3 xor 4.4) 
+dnl you can have 4.2 and 4.3 installed
+dnl but If you have 4.3 and 4.4 it won't work with 4.3
+dnl only 4.4
+dnl didier 
 AC_DEFUN([NETATALK_BERKELEY_LINK],
 [
 atalk_cv_lib_db=no
@@ -119,6 +124,17 @@
 NETATALK_BDB_LINK_TRY(atalk_cv_db_db42,[-ldb42])
 NETATALK_BDB_LINK_TRY(atalk_cv_db_db_42,[-ldb-42])
 NETATALK_BDB_LINK_TRY(atalk_cv_db_db_4_2,[-ldb-4-2])
+
+NETATALK_BDB_LINK_TRY(atalk_cv_db_db_4_dot_2,[-ldb-4.4])
+NETATALK_BDB_LINK_TRY(atalk_cv_db_db42,[-ldb44])
+NETATALK_BDB_LINK_TRY(atalk_cv_db_db_42,[-ldb-44])
+NETATALK_BDB_LINK_TRY(atalk_cv_db_db_4_2,[-ldb-4-4])
+
+NETATALK_BDB_LINK_TRY(atalk_cv_db_db_4_dot_2,[-ldb-4.3])
+NETATALK_BDB_LINK_TRY(atalk_cv_db_db42,[-ldb43])
+NETATALK_BDB_LINK_TRY(atalk_cv_db_db_42,[-ldb-43])
+NETATALK_BDB_LINK_TRY(atalk_cv_db_db_4_2,[-ldb-4-3])
+
 NETATALK_BDB_LINK_TRY(atalk_cv_db_db_4_dot_1,[-ldb-4.1])
 NETATALK_BDB_LINK_TRY(atalk_cv_db_db41,[-ldb41])
 NETATALK_BDB_LINK_TRY(atalk_cv_db_db_41,[-ldb-41])
@@ -134,7 +150,7 @@
 	trybdbdir=""
 	dobdbsearch=yes
 	bdb_search_dirs="/usr/local/include /usr/include"
-	search_subdirs="/db4.2 /db42 /db4.1 /db41 /db4 /"
+	search_subdirs="/db4.2 /db42 /db4.3 /db43 /db4.4 /db44 /db4.1 /db41 /db4 /"
 
 dnl required BDB version
 	DB_MAJOR_REQ=4
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/macros/quota-check.m4 netatalk/macros/quota-check.m4
--- netatalk.orig/macros/quota-check.m4	2004-01-15 09:12:57.000000000 +0100
+++ netatalk/macros/quota-check.m4	2005-07-21 02:12:25.000000000 +0200
@@ -1,8 +1,12 @@
-dnl $Id: quota-check.m4,v 1.1.12.3 2004/01/15 08:12:57 bfernhomberg Exp $
+dnl $Id: quota-check.m4,v 1.1.12.3.2.1 2005/07/21 00:12:25 didg Exp $
 dnl Autoconf macro to check for quota support
 dnl FIXME: This is in now way complete.
 
 AC_DEFUN([AC_CHECK_QUOTA], [
+	AC_ARG_ENABLE(quota,
+	[  --enable-quota           Turn on quota support (default=auto)])
+
+	if test x$enable_quota != xno; then
 	QUOTA_LIBS=""
 	netatalk_cv_quotasupport="yes"
 	AC_CHECK_LIB(rpcsvc, main, [QUOTA_LIBS="-lrpcsvc"])
@@ -11,6 +15,10 @@
 		netatalk_cv_quotasupport="no"
 		AC_DEFINE(NO_QUOTA_SUPPORT, 1, [Define if quota support should not compiled])
 	])
+	else
+		netatalk_cv_quotasupport="no"
+		AC_DEFINE(NO_QUOTA_SUPPORT, 1, [Define if quota support should not compiled])
+	fi
 
 	AC_SUBST(QUOTA_LIBS)
 ])
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/Makefile.am netatalk/Makefile.am
--- netatalk.orig/Makefile.am	2004-08-24 01:02:55.000000000 +0200
+++ netatalk/Makefile.am	2005-10-19 19:48:50.000000000 +0200
@@ -6,3 +6,5 @@
 	TODO VERSION services.atalk
 
 ACLOCAL_AMFLAGS = -I macros
+AUTOMAKE_OPTIONS = foreign
+
diff -ruN -x Makefile.in -x aclocal.m4 -x compile -x config.guess -x config.h.in -x config.sub -x configure -x depcomp -x install-sh -x ltmain.sh -x missing -x mkinstalldirs -x doc -x CVS -x .cvsignore netatalk.orig/sys/netatalk/endian.h netatalk/sys/netatalk/endian.h
--- netatalk.orig/sys/netatalk/endian.h	2001-12-15 13:13:10.000000000 +0100
+++ netatalk/sys/netatalk/endian.h	2006-02-08 02:38:42.000000000 +0100
@@ -1,5 +1,5 @@
 /*
- * $Id: endian.h,v 1.7 2001/12/15 12:13:10 srittau Exp $
+ * $Id: endian.h,v 1.7.12.1 2006/02/08 01:38:42 didg Exp $
  *
  * Copyright (c) 1990,1991 Regents of The University of Michigan.
  * All Rights Reserved. See COPYRIGHT.
@@ -57,10 +57,13 @@
  * various types are forever. this makes some assumptions about integer
  * sizes. */
 #if defined (ultrix) || defined(HAVE_32BIT_LONGS) || defined(HAVE_64BIT_LONGS)
+#ifndef __BIT_TYPES_DEFINED__
+#define __BIT_TYPES_DEFINED__
 typedef unsigned char  u_int8_t;
 typedef unsigned short u_int16_t;
 typedef unsigned int   u_int32_t;
 typedef int            int32_t;
+#endif
 #endif /* ultrix || HAVE_32BIT_LONGS || HAVE_64BIT_LONGS */
 
 #ifdef ultrix
